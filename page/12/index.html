<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 12 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/25/一台服务器安装多个mysql数据库程序/"><span>[Mysql] 一台服务器安装多个mysql数据库程序</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/25/一台服务器安装多个mysql数据库程序/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-25T03:17:00.000Z">
          2018-10-25
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、已安装第一个mysql程序的相关信息："><a href="#1、已安装第一个mysql程序的相关信息：" class="headerlink" title="1、已安装第一个mysql程序的相关信息："></a>1、已安装第一个mysql程序的相关信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">端口：3306</span><br><span class="line">目录：&#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line">配置文件:&#x2F;etc&#x2F;my.cnf</span><br></pre></td></tr></table></figure>

<h4 id="2、新建用于第二个mysql程序的目录："><a href="#2、新建用于第二个mysql程序的目录：" class="headerlink" title="2、新建用于第二个mysql程序的目录："></a>2、新建用于第二个mysql程序的目录：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;twomysql</span><br></pre></td></tr></table></figure>
<p>将安装包解压到twomysql目录（下载地址<a href="https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz）" target="_blank" rel="noopener">https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz）</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz -C &#x2F;data&#x2F;twomysql</span><br><span class="line">cd &#x2F;data&#x2F;twomysql</span><br><span class="line">mv mysql-5.7.22-linux-glibc2.12-x86_64 twomysql</span><br></pre></td></tr></table></figure>

<p>创建相关数据、日志、配置文件目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;log</span><br><span class="line">touch &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;log&#x2F;mysqld.log</span><br><span class="line">chown -R mysql.mysql &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;log</span><br><span class="line">mkdir -p &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;data</span><br><span class="line">chown -R mysql.mysql &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;data</span><br><span class="line">mkdir -p &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;tmp</span><br><span class="line">chown -R mysql.mysql &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;tmp</span><br><span class="line">mkdir -p &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;etc</span><br><span class="line">chown -R mysql.mysql &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;etc</span><br><span class="line">cd &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;etc</span><br></pre></td></tr></table></figure>

<p>配置文件信息如下，端口设为3307，目录设置跟上面创建的目录匹配：<br>vim my.cnf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">port    &#x3D; 3307</span><br><span class="line">socket    &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;tmp&#x2F;mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt&#x3D;&quot;\u@db \R:\m:\s [\d]&gt; &quot;</span><br><span class="line">no-auto-rehash</span><br><span class="line">[mysqld]</span><br><span class="line">user    &#x3D; mysql</span><br><span class="line">port    &#x3D; 3307</span><br><span class="line">basedir    &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql</span><br><span class="line">datadir    &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;data</span><br><span class="line">socket    &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;tmp&#x2F;mysql.sock</span><br><span class="line">pid-file &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;tmp&#x2F;mysql.pid</span><br><span class="line">character-set-server &#x3D; utf8mb4</span><br><span class="line">skip_name_resolve &#x3D; 1</span><br><span class="line">open_files_limit    &#x3D; 65535</span><br><span class="line">back_log &#x3D; 1024</span><br><span class="line">max_connections &#x3D; 2000</span><br><span class="line">max_connect_errors &#x3D; 100</span><br><span class="line">net_read_timeout &#x3D; 30</span><br><span class="line">net_write_timeout &#x3D; 60</span><br><span class="line">slave_net_timeout &#x3D; 90</span><br><span class="line">table_open_cache &#x3D; 1024</span><br><span class="line">table_definition_cache &#x3D; 1024</span><br><span class="line">table_open_cache_instances &#x3D; 64</span><br><span class="line">thread_stack &#x3D; 512K</span><br><span class="line">external-locking &#x3D; FALSE</span><br><span class="line">max_allowed_packet &#x3D; 32M</span><br><span class="line">sort_buffer_size &#x3D; 4M</span><br><span class="line">join_buffer_size &#x3D; 4M</span><br><span class="line">thread_cache_size &#x3D; 768</span><br><span class="line">query_cache_size &#x3D; 0</span><br><span class="line">query_cache_type &#x3D; 0</span><br><span class="line">interactive_timeout &#x3D; 600</span><br><span class="line">wait_timeout &#x3D; 600</span><br><span class="line">tmp_table_size &#x3D; 32M</span><br><span class="line">max_heap_table_size &#x3D; 32M</span><br><span class="line">slow_query_log &#x3D; 1</span><br><span class="line">slow_query_log_file &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;log&#x2F;slow.log</span><br><span class="line">log-error &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;log&#x2F;error.log</span><br><span class="line">long_query_time &#x3D; 0.1</span><br><span class="line">server-id &#x3D; 3306101</span><br><span class="line">log-bin &#x3D; &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;log&#x2F;mysql-binlog</span><br><span class="line">sync_binlog &#x3D; 1</span><br><span class="line">binlog_cache_size &#x3D; 4M</span><br><span class="line">max_binlog_cache_size &#x3D; 1G</span><br><span class="line">max_binlog_size &#x3D; 1G</span><br><span class="line">expire_logs_days &#x3D; 7</span><br><span class="line">gtid_mode &#x3D; on</span><br><span class="line">enforce_gtid_consistency &#x3D; 1</span><br><span class="line">log_slave_updates</span><br><span class="line">binlog_format &#x3D; row</span><br><span class="line">relay_log_recovery &#x3D; 1</span><br><span class="line">relay-log &#x3D; relay-log</span><br><span class="line">relay-log-purge &#x3D; 1</span><br><span class="line">key_buffer_size &#x3D; 32M</span><br><span class="line">read_buffer_size &#x3D; 8M</span><br><span class="line">read_rnd_buffer_size &#x3D; 4M</span><br><span class="line">bulk_insert_buffer_size &#x3D; 64M</span><br><span class="line">lock_wait_timeout &#x3D; 60</span><br><span class="line">explicit_defaults_for_timestamp &#x3D; 1</span><br><span class="line">innodb_thread_concurrency &#x3D; 0</span><br><span class="line">innodb_sync_spin_loops &#x3D; 100</span><br><span class="line">innodb_spin_wait_delay &#x3D; 30</span><br><span class="line">transaction_isolation &#x3D; REPEATABLE-READ</span><br><span class="line">innodb_buffer_pool_size &#x3D; 2048M</span><br><span class="line">innodb_buffer_pool_instances &#x3D; 8</span><br><span class="line">innodb_buffer_pool_load_at_startup &#x3D; 1</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown &#x3D; 1</span><br><span class="line">innodb_data_file_path &#x3D; ibdata1:1G:autoextend</span><br><span class="line">innodb_flush_log_at_trx_commit &#x3D; 1</span><br><span class="line">innodb_log_buffer_size &#x3D; 32M</span><br><span class="line">innodb_log_file_size &#x3D; 1G</span><br><span class="line">innodb_log_files_in_group &#x3D; 3</span><br><span class="line">innodb_max_undo_log_size &#x3D; 4G</span><br><span class="line">innodb_io_capacity &#x3D; 4000</span><br><span class="line">innodb_io_capacity_max &#x3D; 8000</span><br><span class="line">innodb_flush_neighbors &#x3D; 0</span><br><span class="line">innodb_write_io_threads &#x3D; 8</span><br><span class="line">innodb_read_io_threads &#x3D; 8</span><br><span class="line">innodb_purge_threads &#x3D; 4</span><br><span class="line">innodb_page_cleaners &#x3D; 4</span><br><span class="line">innodb_open_files &#x3D; 65535</span><br><span class="line">innodb_max_dirty_pages_pct &#x3D; 50</span><br><span class="line">innodb_flush_method &#x3D; O_DIRECT</span><br><span class="line">innodb_lru_scan_depth &#x3D; 4000</span><br><span class="line">innodb_checksum_algorithm &#x3D; crc32</span><br><span class="line">innodb_lock_wait_timeout &#x3D; 30</span><br><span class="line">innodb_rollback_on_timeout &#x3D; 1</span><br><span class="line">innodb_print_all_deadlocks &#x3D; 1</span><br><span class="line">innodb_file_per_table &#x3D; 1</span><br><span class="line">innodb_online_alter_log_max_size &#x3D; 4G</span><br><span class="line">internal_tmp_disk_storage_engine &#x3D; InnoDB</span><br><span class="line">innodb_stats_on_metadata &#x3D; 0</span><br><span class="line">innodb_status_file &#x3D; 1</span><br><span class="line">innodb_status_output &#x3D; 0</span><br><span class="line">innodb_status_output_locks &#x3D; 0</span><br><span class="line">performance_schema &#x3D; 1</span><br><span class="line">performance_schema_instrument &#x3D; &#39;%&#x3D;on&#39;</span><br><span class="line">lower_case_table_names &#x3D; 1</span><br><span class="line">explicit_defaults_for_timestamp &#x3D; off</span><br><span class="line">sql_mode &#x3D; STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet &#x3D; 32M</span><br><span class="line">[mysql.server]</span><br><span class="line">basedir&#x3D;&#x2F;data&#x2F;twomysql&#x2F;twomysql</span><br></pre></td></tr></table></figure>
<h4 id="3、初始化数据库"><a href="#3、初始化数据库" class="headerlink" title="3、初始化数据库"></a>3、初始化数据库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;mysql-files</span><br><span class="line">sudo chown mysql:mysql &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;mysql-files</span><br><span class="line">sudo chmod 750 &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;mysql-files</span><br></pre></td></tr></table></figure>
<p>设置无密码登录，在后面在重新创建密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;bin&#x2F;mysqld  --defaults-file&#x3D;&#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;etc&#x2F;my.cnf --initialize-insecure --user&#x3D;mysql </span><br><span class="line">sudo &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;bin&#x2F;mysql_ssl_rsa_setup</span><br></pre></td></tr></table></figure>
<h4 id="4、初始化完成之后，启动数据库："><a href="#4、初始化完成之后，启动数据库：" class="headerlink" title="4、初始化完成之后，启动数据库："></a>4、初始化完成之后，启动数据库：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;bin&#x2F;mysqld_safe --defaults-file&#x3D;&#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;etc&#x2F;my.cnf &amp;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/U6azYpM.png" alt=""><br><img src="https://i.imgur.com/hHEuSC0.png" alt=""></p>
<h4 id="5、修改用户密码"><a href="#5、修改用户密码" class="headerlink" title="5、修改用户密码"></a>5、修改用户密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;bin&#x2F;mysqladmin -u root -P 3307  -S &#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;tmp&#x2F;mysql.sock password 123456</span><br></pre></td></tr></table></figure>
<h4 id="6、登录mysql，需要输入密码："><a href="#6、登录mysql，需要输入密码：" class="headerlink" title="6、登录mysql，需要输入密码："></a>6、登录mysql，需要输入密码：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;bin&#x2F;mysql --socket&#x3D;&#x2F;data&#x2F;twomysql&#x2F;twomysql&#x2F;tmp&#x2F;mysql.sock --port&#x3D;3307 -p</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/25/一台服务器安装多个mysql数据库程序/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/24/hp交换机启用snmp，并添加到zabbix监控/"><span>[Zabbix] zabbix监控hp-switch</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/24/hp交换机启用snmp，并添加到zabbix监控/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-24T07:51:00.000Z">
          2018-10-24
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式"><a href="#1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式" class="headerlink" title="1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式"></a>1、通过console口、telnet、ssh连接到switch的命令行，登录具有管理员权限的用户。使用system-view进入特权模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># system-view</span><br></pre></td></tr></table></figure>
<h4 id="2、配置snmp服务，设置版本、联系人信息、设备位置、团体名"><a href="#2、配置snmp服务，设置版本、联系人信息、设备位置、团体名" class="headerlink" title="2、配置snmp服务，设置版本、联系人信息、设备位置、团体名"></a>2、配置snmp服务，设置版本、联系人信息、设备位置、团体名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># snmp-agent</span><br><span class="line"># snmp-agent sys-info version v2c</span><br><span class="line"># snmp-agent sys-info contact Zamasu &lt;zamasu@dbsuper.com&gt;</span><br><span class="line"># snmp-agent sys-info location Universe10 - IT Room</span><br><span class="line"># snmp-agent community read GokuBlack</span><br></pre></td></tr></table></figure>
<h4 id="3、保存配置信息："><a href="#3、保存配置信息：" class="headerlink" title="3、保存配置信息："></a>3、保存配置信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#save</span><br></pre></td></tr></table></figure>
<h4 id="4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务："><a href="#4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务：" class="headerlink" title="4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务："></a>4、保存完成之后hp交换机snmp服务已经配置完成，下面测试zabbix服务器和hp交换机之间的snmp团体名。在zabbix安装snmp测试snmp服务：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install snmp(apt-get install snmp)</span><br><span class="line"># snmpwalk -v2c -c GokuBlack 192.168.0.200</span><br></pre></td></tr></table></figure>
<p>192.168.0.200为hp交换机的地址<br>下面为snmpwalk输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SNMPv2-MIB::sysDescr.0 &#x3D; STRING: HPE V1910-48G Switch Software Version 5.20, Release 1519P03</span><br><span class="line">Copyright(c) 2010-2017 Hewlett Packard Enterprise Development, L.P.</span><br><span class="line">SNMPv2-MIB::sysObjectID.0 &#x3D; OID: SNMPv2-SMI::enterprises.25506.11.1.85</span><br><span class="line">DISMAN-EVENT-MIB::sysUpTimeInstance &#x3D; Timeticks: (197804302) 22 days, 21:27:23.02</span><br><span class="line">SNMPv2-MIB::sysContact.0 &#x3D; STRING: Zamasu &lt;zamasu@dbsuper.com&gt;</span><br><span class="line">SNMPv2-MIB::sysName.0 &#x3D; STRING: TECH-SW01</span><br><span class="line">SNMPv2-MIB::sysLocation.0 &#x3D; STRING: Universe10 - IT Room</span><br></pre></td></tr></table></figure>
<h4 id="5、配置zabbix仪表板："><a href="#5、配置zabbix仪表板：" class="headerlink" title="5、配置zabbix仪表板："></a>5、配置zabbix仪表板：</h4><p>创建主机<br><img src="https://i.imgur.com/zOCoL44.png" alt=""><br><img src="https://i.imgur.com/wknK4aG.jpg" alt=""><br>下面配置snmp团体名用于zabbix连接hp交换机<br><img src="https://i.imgur.com/THDB2A8.jpg" alt=""><br>根据对应的交换机型号，去zabbix官网下载对应得模板：<br><a href="http://www.zabbix.org/wiki/Zabbix_Templates，点击[跳转](http://www.zabbix.org/wiki/Zabbix_Templates)" target="_blank" rel="noopener">http://www.zabbix.org/wiki/Zabbix_Templates，点击[跳转](http://www.zabbix.org/wiki/Zabbix_Templates)</a></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/zabbix/">zabbix</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/24/hp交换机启用snmp，并添加到zabbix监控/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/22/oracle 定期删除trace文件/"><span>[Oracle] oracle 定期删除trace文件</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/22/oracle 定期删除trace文件/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-22T11:05:00.000Z">
          2018-10-22
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="oracle-定期删除trace文件"><a href="#oracle-定期删除trace文件" class="headerlink" title="oracle 定期删除trace文件"></a>oracle 定期删除trace文件</h4><p>cat del_trace.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#oracle 11gR2 rdbms</span><br><span class="line"></span><br><span class="line">#声明oracle环境变量</span><br><span class="line">export ORACLE_BASE&#x3D;&#x2F;u01&#x2F;app&#x2F;oracle</span><br><span class="line">export ORACLE_HOME&#x3D;$ORACLE_BASE&#x2F;product&#x2F;11.2.0.4&#x2F;dbhome_1</span><br><span class="line">#声明主机名</span><br><span class="line">export HOST_NAME&#x3D;&#96;hostname&#96;</span><br><span class="line">#声明日期，用于删除几天前的文件</span><br><span class="line">export DAYS&#x3D;7</span><br><span class="line"></span><br><span class="line">#一台服务器装有多个实例，可使用循环进行删除</span><br><span class="line">for dbname in instancea instanceb</span><br><span class="line">do</span><br><span class="line">export DB_NAME&#x3D;$dbname</span><br><span class="line">export DB_UNIQUE_NAME&#x3D;$&#123;DB_NAME&#125;</span><br><span class="line">export ORACLE_SID&#x3D;$&#123;DB_NAME&#125;</span><br><span class="line">#当前实例为rac模式节点1，启用该变量</span><br><span class="line">#export ORACLE_SID&#x3D;$&#123;DB_NAME&#125;1</span><br><span class="line">#当前实例为rac模式节点2，启用该变量</span><br><span class="line">#export ORACLE_SID&#x3D;$&#123;DB_NAME&#125;2</span><br><span class="line"></span><br><span class="line">#指定存放日志的路径</span><br><span class="line">DIAGNOSTIC_DEST&#x3D;$&#123;ORACLE_BASE&#125;</span><br><span class="line"></span><br><span class="line">#如果audit_trail_dest的一个默认值不生效，会使用下面第二个默认值：</span><br><span class="line">AUDIT_FILE_DEST&#x3D;$&#123;ORACLE_BASE&#125;&#x2F;admin&#x2F;$&#123;DB_NAME&#125;&#x2F;adump</span><br><span class="line"></span><br><span class="line">#删除audit_trail_dest第一个默认值下的审计日志，并删除7天前的日志</span><br><span class="line">find $&#123;ORACLE_HOME&#125;&#x2F;rdbms&#x2F;audit -name &quot;$&#123;ORACLE_SID&#125;_*.aud&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">#如果audit_trail_dest的一个默认值不生效，查找第二个默认值下的审计日志，并删除7天前的日志：</span><br><span class="line">find $&#123;AUDIT_FILE_DEST&#125; -name &quot;$&#123;ORACLE_SID&#125;_*.aud&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">#删除指定路径alert下的文件</span><br><span class="line">find $&#123;DIAGNOSTIC_DEST&#125;&#x2F;diag&#x2F;rdbms&#x2F;$&#123;DB_UNIQUE_NAME&#125;&#x2F;$&#123;ORACLE_SID&#125;&#x2F;alert -name &quot;log_[0-9]*.xml&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">#删除指定路径trace下的文件</span><br><span class="line">find $&#123;DIAGNOSTIC_DEST&#125;&#x2F;diag&#x2F;rdbms&#x2F;$&#123;DB_UNIQUE_NAME&#125;&#x2F;$&#123;ORACLE_SID&#125;&#x2F;trace -name &quot;$&#123;ORACLE_SID&#125;_*.tr[c|m]&quot; -mtime +$&#123;DAYS&#125; -exec rm -f &#123;&#125; \;</span><br><span class="line">find $&#123;DIAGNOSTIC_DEST&#125;&#x2F;diag&#x2F;rdbms&#x2F;$&#123;DB_UNIQUE_NAME&#125;&#x2F;$&#123;ORACLE_SID&#125;&#x2F;trace -name &quot;cdmp_*&quot; -mtime +$&#123;DAYS&#125; -exec rm -rf &#123;&#125; \;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>将该脚本，添加到cron下每日定期删除</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/22/oracle 定期删除trace文件/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/22/oracle-audit_file_dest和audit_trail参数详解/"><span>[Oracle] oracle-audit_file_dest和audit_trail参数详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/22/oracle-audit_file_dest和audit_trail参数详解/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-22T08:22:00.000Z">
          2018-10-22
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、AUDIT-FILE-DEST参数："><a href="#1、AUDIT-FILE-DEST参数：" class="headerlink" title="1、AUDIT_FILE_DEST参数："></a>1、AUDIT_FILE_DEST参数：</h4><p>当AUDIT_TRAIL初始化参数被设置为os, xml, or xml,extended，AUDIT_FILE_DEST指定操作系统目录，用于记录跟踪审计。<br>AUDIT_FILE_DEST的第一个默认值为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORACLE_BASE&#x2F;admin&#x2F;ORACLE_SID&#x2F;adump</span><br></pre></td></tr></table></figure>
<p>如果第一个值指定的目录不存在或者该值不可用，会启用第二个默认值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORACLE_HOME&#x2F;rdbms&#x2F;audit</span><br></pre></td></tr></table></figure>
<p>这两个默认值只适用于unix系统，其他平台系统默认值不同。<br>在多租户cdb模式下,默认值会被追加pdb的guid，用于存储属于pdb的审计记录。<br>例如，pdb的guid为03E1F908EE04252CE053B280E80AAAA3，第一个默认目录是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ORACLE_BASE&#x2F;admin&#x2F;ORACLE_SID&#x2F;adump&#x2F;03E1F908EE04252CE053B280E80AAAA3</span><br></pre></td></tr></table></figure>
<p>关于pdb的guid可以通过V$CONTAINERS视图参看。</p>
<p>如果AUDIT_TRAIL参数设置为xml, or xml,extended，审计记录会以xml的格式存储。如果AUDIT_SYS_OPERATIONS参数启用，用于审计sys用户的记录，审计信息也会强制写入这个位置。<br>在多租户容器数据库，audit_file_dest的值设置范围是cdb。虽然审计记录是每个pdb提供的，但是每个pdb不能修改该初始化参数。</p>
<h4 id="2、audit-trail参数"><a href="#2、audit-trail参数" class="headerlink" title="2、audit_trail参数"></a>2、audit_trail参数</h4><p>value值详解：<br>none：禁用数据库审计<br>os：开启数据库审计，并将所有审计记录定向到操作系统的审计跟踪。<br>db：开启数据库审计，并将所有审计记录定向到数据库审计跟踪（sys.aud$)<br>db, extended:开启数据库审计，并将所有审计记录定向到数据库审计跟踪（sys.aud$),另外，sys.aud$表中类型为clob的两列（sqlbind和sqltext会被写入数据）<br>xml：开启数据库审计，并将所有审计记录以xml格式写入操作系统文件<br>xml,extended:开启数据库审计，并打印所有的审计记录列，包括SqlText和SqlBind字段</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/22/oracle-audit_file_dest和audit_trail参数详解/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/18/linux区分当前服务器是物理机还是虚拟机/"><span>[Linux] linux区分当前服务器是物理机还是虚拟机方法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/18/linux区分当前服务器是物理机还是虚拟机/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-18T10:35:00.000Z">
          2018-10-18
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、查看系统产品名称："><a href="#1、查看系统产品名称：" class="headerlink" title="1、查看系统产品名称："></a>1、查看系统产品名称：</h3><p>dmidecode -s system-product-name<br>物理机：<br><img src="https://i.imgur.com/fV68YVX.png" alt=""><br>Azure微软云服务器<br><img src="https://i.imgur.com/zlsbp4u.png" alt=""><br>aws亚马逊云服务器<br><img src="https://i.imgur.com/5iOdIf3.png" alt=""><br>阿里云服务器<br><img src="https://i.imgur.com/AlWSFW0.png" alt=""><br>使用vmware建立的虚拟机<br><img src="https://i.imgur.com/TpzQH8s.png" alt=""><br>使用kvm建立的虚拟机<br><img src="https://i.imgur.com/Q7h1vEC.png" alt=""></p>
<h3 id="2、查看scsi供应商："><a href="#2、查看scsi供应商：" class="headerlink" title="2、查看scsi供应商："></a>2、查看scsi供应商：</h3><p>cat /proc/scsi/scsi|grep Vendor<br>物理机：<br><img src="https://i.imgur.com/3ID5hHz.png" alt=""><br>Azure微软云服务器<br><img src="https://i.imgur.com/A9HEqR5.png" alt=""><br>aws亚马逊云服务器（看不到任何信息）<br><img src="https://i.imgur.com/x2Eandx.png" alt=""><br>阿里云服务器<br><img src="https://i.imgur.com/5wt4HXK.png" alt=""><br>使用vmware建立的虚拟机<br><img src="https://i.imgur.com/X1v9alH.png" alt=""><br>使用kvm建立的虚拟机<br><img src="https://i.imgur.com/rFMO9XJ.png" alt=""></p>
<h3 id="3、查看内核缓冲信息："><a href="#3、查看内核缓冲信息：" class="headerlink" title="3、查看内核缓冲信息："></a>3、查看内核缓冲信息：</h3><p>dmesg | grep -i virtual<br>物理机：<br><img src="https://i.imgur.com/lfLe8yz.png" alt=""><br>Azure微软云服务器<br><img src="https://i.imgur.com/ZP2vlPq.png" alt=""><br>aws亚马逊云服务器<br><img src="https://i.imgur.com/CJijhJv.png" alt=""><br>阿里云服务器<br><img src="https://i.imgur.com/Wy7zTE3.png" alt=""><br>使用vmware建立的虚拟机<br><img src="https://i.imgur.com/8SEgcjn.png" alt=""><br>使用kvm建立的虚拟机<br><img src="https://i.imgur.com/7IacEIc.png" alt=""></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/18/linux区分当前服务器是物理机还是虚拟机/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/18/mysql忘记root密码，修改密码方法/"><span>[Mysql] mysql忘记root密码，修改密码方法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/18/mysql忘记root密码，修改密码方法/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-18T02:23:00.000Z">
          2018-10-18
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、修改my-cnf文件，在-mysqld-下添加’skip-grant-tables’参数："><a href="#1、修改my-cnf文件，在-mysqld-下添加’skip-grant-tables’参数：" class="headerlink" title="1、修改my.cnf文件，在[mysqld]下添加’skip-grant-tables’参数："></a>1、修改my.cnf文件，在[mysqld]下添加’skip-grant-tables’参数：</h3><p>cat /usr/local/mysql/etc/my.cnf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">!include &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;etc&#x2F;mysqld.cnf</span><br><span class="line">port            &#x3D; 3306</span><br><span class="line">basedir         &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;</span><br><span class="line">socket          &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;tmp&#x2F;mysql.sock</span><br><span class="line">pid-file        &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;var&#x2F;mysql.pid</span><br><span class="line">datadir         &#x3D; &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;var&#x2F;</span><br><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure>

<h3 id="2、重启mysql进程："><a href="#2、重启mysql进程：" class="headerlink" title="2、重启mysql进程："></a>2、重启mysql进程：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;mysql restart</span><br></pre></td></tr></table></figure>
<h3 id="3、进入mysql控制台，修改mysql密码："><a href="#3、进入mysql控制台，修改mysql密码：" class="headerlink" title="3、进入mysql控制台，修改mysql密码："></a>3、进入mysql控制台，修改mysql密码：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; USE mysql ; </span><br><span class="line">Database changed</span><br><span class="line">mysql&gt;  UPDATE user SET Password &#x3D; password ( &#39;12345678&#39; ) WHERE User &#x3D; &#39;root&#39; ; </span><br><span class="line">Query OK, 1 row affected (0.06 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line">mysql&gt; flush privileges ; </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure>
<h3 id="4、注释掉my-cnf配置文件下的skip-grant-tables这行参数，重新启动mysql："><a href="#4、注释掉my-cnf配置文件下的skip-grant-tables这行参数，重新启动mysql：" class="headerlink" title="4、注释掉my.cnf配置文件下的skip-grant-tables这行参数，重新启动mysql："></a>4、注释掉my.cnf配置文件下的skip-grant-tables这行参数，重新启动mysql：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;mysql restart</span><br></pre></td></tr></table></figure>
<h3 id="5、测试密码是否修改成功-能否正常登陆控制台："><a href="#5、测试密码是否修改成功-能否正常登陆控制台：" class="headerlink" title="5、测试密码是否修改成功,能否正常登陆控制台："></a>5、测试密码是否修改成功,能否正常登陆控制台：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/18/mysql忘记root密码，修改密码方法/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/17/mysql--The table is probably corrupted/"><span>[Mysql] ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/17/mysql--The table is probably corrupted/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-17T09:51:00.000Z">
          2018-10-17
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、从mysql5-6-msyqldump全备出来数据，导入到mysql5-7的库，导入导出均正常，在5-7的库新增用户时，提示以下错误："><a href="#1、从mysql5-6-msyqldump全备出来数据，导入到mysql5-7的库，导入导出均正常，在5-7的库新增用户时，提示以下错误：" class="headerlink" title="1、从mysql5.6 msyqldump全备出来数据，导入到mysql5.7的库，导入导出均正常，在5.7的库新增用户时，提示以下错误："></a>1、从mysql5.6 msyqldump全备出来数据，导入到mysql5.7的库，导入导出均正常，在5.7的库新增用户时，提示以下错误：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:21:  [(none)]&gt; grant select,update,delete,insert on *.* to &#39;clevergo&#39;@&#39;%&#39; identified by &#39;123123&#39;;</span><br><span class="line">ERROR 1805 (HY000): Column count of mysql.user is wrong. Expected 45, found 43. The table is probably corrupted</span><br></pre></td></tr></table></figure>
<h3 id="2、造成该问题是因为把5-6的库数据，全部导入5-7造成的，因此需要使用mysql-upgrade将库升级到最新版本："><a href="#2、造成该问题是因为把5-6的库数据，全部导入5-7造成的，因此需要使用mysql-upgrade将库升级到最新版本：" class="headerlink" title="2、造成该问题是因为把5.6的库数据，全部导入5.7造成的，因此需要使用mysql_upgrade将库升级到最新版本："></a>2、造成该问题是因为把5.6的库数据，全部导入5.7造成的，因此需要使用mysql_upgrade将库升级到最新版本：</h3><p>/data/mysql/bin/mysql_upgrade -uroot -p123456</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mysql_upgrade: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Checking if update is needed.</span><br><span class="line">Checking server version.</span><br><span class="line">Running queries to upgrade MySQL server.</span><br><span class="line">Checking system database.</span><br><span class="line">mysql.columns_priv                                 OK</span><br><span class="line">mysql.db                                           OK</span><br><span class="line">mysql.engine_cost                                  OK</span><br><span class="line">mysql.event                                        OK</span><br><span class="line">mysql.func                                         OK</span><br><span class="line">mysql.general_log                                  OK</span><br><span class="line">mysql.gtid_executed                                OK</span><br><span class="line">mysql.help_category                                OK</span><br><span class="line">mysql.help_keyword                                 OK</span><br><span class="line">mysql.help_relation                                OK</span><br><span class="line">mysql.help_topic                                   OK</span><br><span class="line">mysql.innodb_index_stats                           OK</span><br><span class="line">mysql.innodb_table_stats                           OK</span><br><span class="line">mysql.ndb_binlog_index                             OK</span><br><span class="line">mysql.plugin                                       OK</span><br><span class="line">mysql.proc                                         OK</span><br><span class="line">mysql.procs_priv                                   OK</span><br><span class="line">mysql.proxies_priv                                 OK</span><br><span class="line">mysql.server_cost                                  OK</span><br><span class="line">mysql.servers                                      OK</span><br><span class="line">mysql.slave_master_info                            OK</span><br><span class="line">mysql.slave_relay_log_info                         OK</span><br><span class="line">mysql.slave_worker_info                            OK</span><br><span class="line">mysql.slow_log                                     OK</span><br><span class="line">mysql.tables_priv                                  OK</span><br><span class="line">mysql.time_zone                                    OK</span><br><span class="line">mysql.time_zone_leap_second                        OK</span><br><span class="line">mysql.time_zone_name                               OK</span><br><span class="line">mysql.time_zone_transition                         OK</span><br><span class="line">mysql.time_zone_transition_type                    OK</span><br><span class="line">mysql.user                                         OK</span><br><span class="line">The sys schema is already up to date (version 1.5.1).</span><br><span class="line">Found 0 sys functions, but expected 22. Re-installing the sys schema.</span><br><span class="line">Upgrading the sys schema.</span><br><span class="line">Checking databases.</span><br><span class="line">t.t_test                                           OK</span><br><span class="line">Upgrade process completed successfully.</span><br><span class="line">Checking if update is needed.</span><br></pre></td></tr></table></figure>

<h3 id="3、进入mysql，再次执行创建用户："><a href="#3、进入mysql，再次执行创建用户：" class="headerlink" title="3、进入mysql，再次执行创建用户："></a>3、进入mysql，再次执行创建用户：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@db 09:26:  [(none)]&gt; grant select,update,delete,insert on *.* to &#39;clevergo&#39;@&#39;%&#39; identified by &#39;123123&#39;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; select host,user from mysql.user;</span><br><span class="line">+-----------+----------------+</span><br><span class="line">| host      | user           |</span><br><span class="line">+-----------+----------------+</span><br><span class="line">| %         | clevergo       |</span><br><span class="line">| localhost | mysql.session  |</span><br><span class="line">| localhost | mysql.sys      |</span><br><span class="line">| localhost | root           |</span><br><span class="line">+-----------+----------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 09:26:  [(none)]&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>
<p>执行成功。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/17/mysql--The table is probably corrupted/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/10/08/使用mysqldiff和mysqldbcompare比较数据库差异/"><span>[Mysql] 使用mysqldiff和mysqldbcompare检查数据一致性</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/08/使用mysqldiff和mysqldbcompare比较数据库差异/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-08T09:51:24.000Z">
          2018-10-08
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、官网下载mysql-utilities工具"><a href="#1、官网下载mysql-utilities工具" class="headerlink" title="1、官网下载mysql-utilities工具"></a>1、官网下载mysql-utilities工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;cdn.mysql.com&#x2F;archives&#x2F;mysql-utilities&#x2F;mysql-utilities-1.6.5.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="2、解压mysql-utilities工具："><a href="#2、解压mysql-utilities工具：" class="headerlink" title="2、解压mysql-utilities工具："></a>2、解压mysql-utilities工具：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-utilities-1.6.5.tar.gz</span><br><span class="line">cd mysql-utilities-1.6.5&#x2F;</span><br><span class="line">cd scripts&#x2F;</span><br><span class="line">[root@dax-mysql-slave scripts]# ls</span><br><span class="line">mysqlauditadmin.py  mysqlbinlogpurge.py   mysqldbcopy.py    mysqldiff.py       mysqlfrm.py         mysqlmetagrep.py   mysqlrpladmin.py  mysqlrplshow.py      mysqlserverinfo.py  mysqluserclone.py</span><br><span class="line">mysqlauditgrep.py   mysqlbinlogrotate.py  mysqldbexport.py  mysqldiskusage.py  mysqlgrants.py      mysqlprocgrep.py   mysqlrplcheck.py  mysqlrplsync.py      mysqlslavetrx.py</span><br><span class="line">mysqlbinlogmove.py  mysqldbcompare.py     mysqldbimport.py  mysqlfailover.py   mysqlindexcheck.py  mysqlreplicate.py  mysqlrplms.py     mysqlserverclone.py  mysqluc.py</span><br></pre></td></tr></table></figure>
<p>在scripts目录下存在mysqldiff和mysqldbcompare用于比对数据的脚本</p>
<h3 id="3、使用mysqldbcompare需要安装connector-python依赖关系："><a href="#3、使用mysqldbcompare需要安装connector-python依赖关系：" class="headerlink" title="3、使用mysqldbcompare需要安装connector-python依赖关系："></a>3、使用mysqldbcompare需要安装connector-python依赖关系：</h3><p>官网下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;cdn.mysql.com&#x2F;archives&#x2F;mysql-connector-python-2.2&#x2F;mysql-connector-python-2.2.3-0.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh mysql-connector-python-2.2.3-0.1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="4、安装完成之后测试mysqldbcompare能否正常使用："><a href="#4、安装完成之后测试mysqldbcompare能否正常使用：" class="headerlink" title="4、安装完成之后测试mysqldbcompare能否正常使用："></a>4、安装完成之后测试mysqldbcompare能否正常使用：</h3><p> ./mysqldbcompare.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;.&#x2F;mysqldbcompare.py&quot;, line 28, in &lt;module&gt;</span><br><span class="line">    from mysql.utilities.common.tools import check_python_version</span><br><span class="line">ImportError: No module named utilities.common.tools</span><br></pre></td></tr></table></figure>
<p>将python2.7下的模块，软连接到lib64目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;mysql&#x2F;utilities &#x2F;usr&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;mysql&#x2F;utilities</span><br></pre></td></tr></table></figure>
<p>重新测试mysqldbcompare能否正常使用：<br>./mysqldbcompare.py </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Usage: mysqldbcompare --server1&#x3D;user:pass@host:port:socket --server2&#x3D;user:pass@host:port:socket db1:db2</span><br><span class="line"></span><br><span class="line">mysqldbcompare: error: You must specify at least one database to compare or use the --all option to compare all databases.</span><br></pre></td></tr></table></figure>
<p>提示需要指定对表的库：<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306:/data/mysql/tmp/mysql.sock –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306:/data/mysql/tmp/mysql.sock test:test<br>或者<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test:test<br>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test on server1 and test on server2</span><br><span class="line">#</span><br><span class="line">ERROR: The list of objects differs among database test and test.</span><br></pre></td></tr></table></figure>
<h3 id="5、准备测试数据："><a href="#5、准备测试数据：" class="headerlink" title="5、准备测试数据："></a>5、准备测试数据：</h3><p>server1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:40:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">|  6 |</span><br><span class="line">+----+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 03:40:  [test1]&gt; show create table test;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test  | CREATE TABLE &#96;test&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>server2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@db 03:37:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br><span class="line"></span><br><span class="line">root@db 06:20:  [test1]&gt; show create table test</span><br><span class="line">    -&gt; ;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test  | CREATE TABLE &#96;test&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来："><a href="#6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来：" class="headerlink" title="6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来："></a>6、mysqldiff用于检测表结构的差异，如果某个对比表表结构相同，数据不同，mysqldiff并不会检测出来：</h3><p>./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test1:test1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing &#96;test1&#96; to &#96;test1&#96;                                     [PASS]</span><br><span class="line"># Comparing &#96;test1&#96;.&#96;aa&#96; to &#96;test1&#96;.&#96;aa&#96;                           [PASS]</span><br><span class="line"># Comparing &#96;test1&#96;.&#96;test&#96; to &#96;test1&#96;.&#96;test&#96;                       [PASS]</span><br><span class="line"># Success. All objects are the same.</span><br></pre></td></tr></table></figure>
<p>单独对比某一张表：<br>./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test1.test:test1.test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing test1.test to test1.test                               [PASS]</span><br><span class="line"># Success. All objects are the same.</span><br></pre></td></tr></table></figure>
<h3 id="7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测："><a href="#7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测：" class="headerlink" title="7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测："></a>7、结构一致，数据内容不一致，使用mysqldbcompare（用于检测数据库字符集，表结构，表数据等）检测：</h3><p>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    ERROR: Row counts are not the same among &#96;test1&#96;.&#96;test&#96; and &#96;test1&#96;.&#96;test&#96;.</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>提示test1库下面的test表数据不一致。</p>
<h3 id="8、创建测试数据，表结构不同，数据内容相同："><a href="#8、创建测试数据，表结构不同，数据内容相同：" class="headerlink" title="8、创建测试数据，表结构不同，数据内容相同："></a>8、创建测试数据，表结构不同，数据内容相同：</h3><p>server1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table test1 (id int(10) primary key);</span><br><span class="line">insert into test1 values (1),(2),(3),(4),(5);</span><br><span class="line">select * from test1;</span><br><span class="line">+----+</span><br><span class="line">| id |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure>
<p>server2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table test1 (id bigint(20));</span><br><span class="line">insert into test1 values (1),(2),(3),(4),(5);</span><br><span class="line">root@db 06:28:  [test1]&gt; select * from test1;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">|    4 |</span><br><span class="line">|    5 |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure>
<h3 id="9、使用mysqldiff检测："><a href="#9、使用mysqldiff检测：" class="headerlink" title="9、使用mysqldiff检测："></a>9、使用mysqldiff检测：</h3><p> ./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test1.test1:test1.test1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Comparing test1.test1 to test1.test1                             [FAIL]</span><br><span class="line"># Object definitions differ. (--changes-for&#x3D;server1)</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">--- test1.test1</span><br><span class="line">+++ test1.test1</span><br><span class="line">@@ -1,4 +1,3 @@</span><br><span class="line"> CREATE TABLE &#96;test1&#96; (</span><br><span class="line">-  &#96;id&#96; int(10) NOT NULL,</span><br><span class="line">-  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">+  &#96;id&#96; bigint(20) DEFAULT NULL</span><br><span class="line"> ) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4</span><br><span class="line"># Compare failed. One or more differences found.</span><br></pre></td></tr></table></figure>
<p>提示表结构存在差异。</p>
<h3 id="10、使用mysqldbcompare检测："><a href="#10、使用mysqldbcompare检测：" class="headerlink" title="10、使用mysqldbcompare检测："></a>10、使用mysqldbcompare检测：</h3><p>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    ERROR: Row counts are not the same among &#96;test1&#96;.&#96;test&#96; and &#96;test1&#96;.&#96;test&#96;.</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<p>当检测到异常之后会直接退出，不进行下面的比较，因此未检测到test1表的内容，加上-t（-t, –run-all-tests   do not abort when a diff test fails）参数，运行测试模式，遇到异常之后仍然执行下面的比较：<br>./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test1 –changes-for=server1 –difftype=sql -t</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test1 on server1 and test1 on server2</span><br><span class="line">#</span><br><span class="line">#                                                   Defn    Row     Data   </span><br><span class="line"># Type      Object Name                             Diff    Count   Check  </span><br><span class="line"># ------------------------------------------------------------------------- </span><br><span class="line"># TABLE     aa                                      pass    pass    -       </span><br><span class="line">#           - Compare table checksum                                pass    </span><br><span class="line"># TABLE     test                                    pass    FAIL    -       </span><br><span class="line">#           - Compare table checksum                                FAIL    </span><br><span class="line">#           - Find row differences                                  FAIL    </span><br><span class="line">#</span><br><span class="line"># Row counts are not the same among &#96;test1&#96;.&#96;test&#96; and &#96;test1&#96;.&#96;test&#96;.</span><br><span class="line">#</span><br><span class="line"># Transformation for --changes-for&#x3D;server1:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">DELETE FROM &#96;test1&#96;.&#96;test&#96; WHERE &#96;ID&#96; &#x3D; &#39;6&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># TABLE     test1                                   FAIL    pass    -       </span><br><span class="line">#           - Compare table checksum                                FAIL    </span><br><span class="line">#           - Find row differences                                  SKIP    </span><br><span class="line">#</span><br><span class="line"># Transformation for --changes-for&#x3D;server1:</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">ALTER TABLE &#96;test1&#96;.&#96;test1&#96; </span><br><span class="line">  DROP PRIMARY KEY, </span><br><span class="line">  CHANGE COLUMN id id bigint(20) NULL;</span><br><span class="line"></span><br><span class="line"># The table test1 does not have an usable Index or primary key.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Database consistency check failed.</span><br><span class="line">#</span><br><span class="line"># ...done</span><br></pre></td></tr></table></figure>

<h3 id="11、创建两个test库，server1比server2实例多一个gtid-test14的表："><a href="#11、创建两个test库，server1比server2实例多一个gtid-test14的表：" class="headerlink" title="11、创建两个test库，server1比server2实例多一个gtid_test14的表："></a>11、创建两个test库，server1比server2实例多一个gtid_test14的表：</h3><p>server1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| articles       |</span><br><span class="line">| gtid_test10    |</span><br><span class="line">| gtid_test11    |</span><br><span class="line">| gtid_test12    |</span><br><span class="line">| gtid_test13    |</span><br><span class="line">| gtid_test14    |</span><br><span class="line">| gtid_test15    |</span><br><span class="line">| gtid_test2     |</span><br><span class="line">| gtid_test3     |</span><br><span class="line">| gtid_test4     |</span><br><span class="line">| gtid_test5     |</span><br><span class="line">| gtid_test6     |</span><br><span class="line">| gtid_test7     |</span><br><span class="line">| gtid_test8     |</span><br><span class="line">| gtid_test9     |</span><br><span class="line">| ratings        |</span><br><span class="line">+----------------+</span><br><span class="line">16 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>server2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| articles       |</span><br><span class="line">| gtid_test10    |</span><br><span class="line">| gtid_test11    |</span><br><span class="line">| gtid_test12    |</span><br><span class="line">| gtid_test13    |</span><br><span class="line">| gtid_test15    |</span><br><span class="line">| gtid_test2     |</span><br><span class="line">| gtid_test3     |</span><br><span class="line">| gtid_test4     |</span><br><span class="line">| gtid_test5     |</span><br><span class="line">| gtid_test6     |</span><br><span class="line">| gtid_test7     |</span><br><span class="line">| gtid_test8     |</span><br><span class="line">| gtid_test9     |</span><br><span class="line">| ratings        |</span><br><span class="line">+----------------+</span><br><span class="line">15 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="12、使用mysqldiff测试："><a href="#12、使用mysqldiff测试：" class="headerlink" title="12、使用mysqldiff测试："></a>12、使用mysqldiff测试：</h3><p> ./mysqldiff.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test:test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># WARNING: Objects in server1.test but not in server2.test:</span><br><span class="line">#        TABLE: gtid_test14</span><br><span class="line"># Compare failed. One or more differences found.</span><br></pre></td></tr></table></figure>
<p>提示server2.test库下不存在gtid_test14表。</p>
<h3 id="13、使用mysqldbcompare测试："><a href="#13、使用mysqldbcompare测试：" class="headerlink" title="13、使用mysqldbcompare测试："></a>13、使用mysqldbcompare测试：</h3><p> ./mysqldbcompare.py –server1=root:<a href="mailto:12345678@10.0.7.50">12345678@10.0.7.50</a>:3306 –server2=root:<a href="mailto:12345678@10.0.7.51">12345678@10.0.7.51</a>:3306 test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># WARNING: Using a password on the command line interface can be insecure.</span><br><span class="line"># server1 on 10.0.7.50: ... connected.</span><br><span class="line"># server2 on 10.0.7.51: ... connected.</span><br><span class="line"># Checking databases test on server1 and test on server2</span><br><span class="line">#</span><br><span class="line">ERROR: The list of objects differs among database test and test.</span><br></pre></td></tr></table></figure>
<p>只会提示两个实例的test库有差异，并没有列出详细信息。在对比数据时可先使用mysqldiff工具检测两个server端的表结构是否一致，如果没有差异，再使用mysqldbcompare工具去检测表数据是否一致。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/10/08/使用mysqldiff和mysqldbcompare比较数据库差异/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/28/使用certbot为域名生成免费证书(apache版)/"><span>[Linux] 使用certbot为域名生成免费证书(apache版)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/28/使用certbot为域名生成免费证书(apache版)/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-28T08:41:30.000Z">
          2018-09-28
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、下载certbot"><a href="#1、下载certbot" class="headerlink" title="1、下载certbot"></a>1、下载certbot</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;soft</span><br><span class="line">wget https:&#x2F;&#x2F;dl.eff.org&#x2F;certbot-auto</span><br><span class="line">chmod a+x certbot-auto</span><br></pre></td></tr></table></figure>
<h4 id="2、生成证书"><a href="#2、生成证书" class="headerlink" title="2、生成证书"></a>2、生成证书</h4><p>/data/soft/certbot-auto –apache certonly</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to &#x2F;var&#x2F;log&#x2F;letsencrypt&#x2F;letsencrypt.log</span><br><span class="line">Could not choose appropriate plugin: The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&#39;Cannot find Apache executable apachectl&#39;,)</span><br><span class="line">The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&#39;Cannot find Apache executable apachectl&#39;,)</span><br></pre></td></tr></table></figure>
<h4 id="3、上面报错提示找不到执行路径，需要指定apache的路径"><a href="#3、上面报错提示找不到执行路径，需要指定apache的路径" class="headerlink" title="3、上面报错提示找不到执行路径，需要指定apache的路径"></a>3、上面报错提示找不到执行路径，需要指定apache的路径</h4><p>sudo env PATH=$PATH:/usr/local/apache2/bin ./certbot-auto –apache certonly</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to &#x2F;var&#x2F;log&#x2F;letsencrypt&#x2F;letsencrypt.log</span><br><span class="line">Could not choose appropriate plugin: The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&#39;Could not find configuration root&#39;,)</span><br><span class="line">The apache plugin is not working; there may be problems with your existing configuration.</span><br><span class="line">The error was: NoInstallationError(&#39;Could not find configuration root&#39;,)</span><br></pre></td></tr></table></figure>
<h4 id="4、上面报错提示找不到配置目录，需要指定–apache-server-root"><a href="#4、上面报错提示找不到配置目录，需要指定–apache-server-root" class="headerlink" title="4、上面报错提示找不到配置目录，需要指定–apache-server-root"></a>4、上面报错提示找不到配置目录，需要指定–apache-server-root</h4><p> sudo env PATH=$PATH:/usr/local/apache2/bin ./certbot-auto –apache –apache-server-root /usr/local/apache2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Saving debug log to &#x2F;var&#x2F;log&#x2F;letsencrypt&#x2F;letsencrypt.log</span><br><span class="line">Plugins selected: Authenticator apache, Installer apache</span><br><span class="line">No names were found in your configuration files. Please enter in your domain</span><br><span class="line">name(s) (comma and&#x2F;or space separated)  (Enter &#39;c&#39; to cancel): www.test.com</span><br><span class="line">Obtaining a new certificate</span><br><span class="line">Performing the following challenges:</span><br><span class="line">http-01 challenge for www.test.com</span><br><span class="line">Cleaning up challenges</span><br><span class="line">Unable to find a virtual host listening on port 80 which is currently needed for Certbot to prove to the CA that you control your domain. Please add a virtual host for port 80.</span><br></pre></td></tr></table></figure>
<h4 id="5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd-conf配置文件，添加上80端口，并重启apache"><a href="#5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd-conf配置文件，添加上80端口，并重启apache" class="headerlink" title="5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd.conf配置文件，添加上80端口，并重启apache"></a>5、使用certbot申请申请域名免费证书，默认会访问80端口，如果80端口不存在，会报以上错误，修改httpd.conf配置文件，添加上80端口，并重启apache</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Listen 80</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;  </span><br><span class="line">    ServerAdmin test@test.example.com</span><br><span class="line">    ServerName  www.test.com</span><br><span class="line">    ServerAlias test</span><br><span class="line">    DocumentRoot &#x2F;var&#x2F;www&#x2F;html </span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<h4 id="6、重新生成证书，成功之后会在-etc-letsencrypt-live-ebank-cbibank-com目录下生成四个文件-pem文件和一个README文件"><a href="#6、重新生成证书，成功之后会在-etc-letsencrypt-live-ebank-cbibank-com目录下生成四个文件-pem文件和一个README文件" class="headerlink" title="6、重新生成证书，成功之后会在/etc/letsencrypt/live/ebank.cbibank.com目录下生成四个文件.pem文件和一个README文件"></a>6、重新生成证书，成功之后会在/etc/letsencrypt/live/ebank.cbibank.com目录下生成四个文件.pem文件和一个README文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cert.pem  chain.pem  fullchain.pem  privkey.pem  README</span><br></pre></td></tr></table></figure>
<h4 id="7、修改conf-httpd-conf文件"><a href="#7、修改conf-httpd-conf文件" class="headerlink" title="7、修改conf/httpd.conf文件"></a>7、修改conf/httpd.conf文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#Include conf&#x2F;extra&#x2F;httpd-ssl.conf</span><br><span class="line">#LoadModule ssl_module modules&#x2F;mod_ssl.so</span><br></pre></td></tr></table></figure>
<p>将这两行的#去掉</p>
<h4 id="8、配置conf-extra-httpd-ssl-conf文件，修改对应的域名和证书路径："><a href="#8、配置conf-extra-httpd-ssl-conf文件，修改对应的域名和证书路径：" class="headerlink" title="8、配置conf/extra/httpd-ssl.conf文件，修改对应的域名和证书路径："></a>8、配置conf/extra/httpd-ssl.conf文件，修改对应的域名和证书路径：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:443&gt;</span><br><span class="line">DocumentRoot &quot;&#x2F;var&#x2F;www&#x2F;html&quot;</span><br><span class="line">ServerName ebank.cbibank.com</span><br><span class="line">SSLEngine on</span><br><span class="line">SSLCertificateFile &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;ebank.cbibank.com&#x2F;cert.pem</span><br><span class="line">SSLCertificateKeyFile &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;ebank.cbibank.com&#x2F;privkey.pem</span><br><span class="line">SSLCertificateChainFile &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;ebank.cbibank.com&#x2F;chain.pem</span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h4 id="9、修改完成后重启apache："><a href="#9、修改完成后重启apache：" class="headerlink" title="9、修改完成后重启apache："></a>9、修改完成后重启apache：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;apache2&#x2F;bin&#x2F;apachectl restart</span><br></pre></td></tr></table></figure>
<p>重启过程报错，无法关闭apache提示以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;conf&#x2F;httpd.conf: Cannot load &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so into server: &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>
<p>在/usr/lib64/下面没有httpd的模块，yum安装mod_ssl：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mod_ssl</span><br></pre></td></tr></table></figure>
<p>安装完成之后在/usr/lib64/httpd/modules/下面会有mod_ssl.so</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;lib64&#x2F;httpd&#x2F;modules&#x2F;mod_ssl.so</span><br><span class="line">ln -s &#x2F;usr&#x2F;lib64&#x2F;httpd&#x2F;modules&#x2F;mod_ssl.so &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so</span><br></pre></td></tr></table></figure>
<p>再次尝试重启apache，报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;conf&#x2F;httpd.conf: Cannot load &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so into server: &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so:undefined symbol: ap_global_mutex_create</span><br></pre></td></tr></table></figure>
<p>google了一下，有说yum安装的mod_ssl与apache的安装版本不兼容的问题，因此尝试使用对应版本的tar包将模块文件拷过去:<br>拷贝modules目录下的ssl目录和loggers的内容到/usr/local/apache2/modules/ssl目录下、拷贝include目录下的内容到/usr/local/apache2/modules/ssl目录下，拷贝完之后，在/usr/local/apache2/modules/ssl目录下执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;apache2&#x2F;bin&#x2F;apxs -a -i -c mod_ssl.c</span><br></pre></td></tr></table></figure>
<p>执行完成之后再次重启apache，依旧报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;conf&#x2F;httpd.conf: Cannot load &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so into server: &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so: undefined symbol: ssl_cmd_SSLPassPhraseDialog</span><br></pre></td></tr></table></figure>
<p>需要指定openssl路径，执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;apache2&#x2F;bin&#x2F;apxs -a -i -c -L&#x2F;usr&#x2F;lib&#x2F;openssl&#x2F;engines&#x2F;lib -c *.c -lcrypto -lssl -ldl</span><br></pre></td></tr></table></figure>
<p>再次重启apache</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd: Syntax error on line 434 of &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;conf&#x2F;httpd.conf: Cannot load &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so into server: &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;modules&#x2F;mod_ssl.so:undefined symbol: ap_global_mutex_create</span><br></pre></td></tr></table></figure>
<p>重启apache依旧报错undefinedsymbol:ap_global_mutex_create，没找到任何解决办法，最后只能添加-enable-ssl参数，重新编译安装apache。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/28/使用certbot为域名生成免费证书(apache版)/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/09/26/mysql 勿操作drop table之后，利用mysqldump备份和binlog去恢复/"><span>[Mysql] mysql勿操作drop table之后，利用mysqldump备份和binlog恢复</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/26/mysql 勿操作drop table之后，利用mysqldump备份和binlog去恢复/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-26T14:35:24.000Z">
          2018-09-26
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <p>1、查看备份表数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:30:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">+----+</span><br></pre></td></tr></table></figure>
<p>2、查看当前binlog位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                       |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000036 |    80147 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-195:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>3、开始备份test1数据库下的test数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p12345678 test1 test --master-data&#x3D;2 --single-transaction &gt; &#x2F;data&#x2F;test.dump</span><br></pre></td></tr></table></figure>
<p>4、查看备份数据文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> more &#x2F;data&#x2F;test.dump</span><br><span class="line">-- MySQL dump 10.13  Distrib 5.7.22, for linux-glibc2.12 (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost    Database: test1</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version	5.7.22-log</span><br><span class="line"></span><br><span class="line">&#x2F;*!40101 SET @OLD_CHARACTER_SET_CLIENT&#x3D;@@CHARACTER_SET_CLIENT *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET @OLD_CHARACTER_SET_RESULTS&#x3D;@@CHARACTER_SET_RESULTS *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET @OLD_COLLATION_CONNECTION&#x3D;@@COLLATION_CONNECTION *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET NAMES utf8 *&#x2F;;</span><br><span class="line">&#x2F;*!40103 SET @OLD_TIME_ZONE&#x3D;@@TIME_ZONE *&#x2F;;</span><br><span class="line">&#x2F;*!40103 SET TIME_ZONE&#x3D;&#39;+00:00&#39; *&#x2F;;</span><br><span class="line">&#x2F;*!40014 SET @OLD_UNIQUE_CHECKS&#x3D;@@UNIQUE_CHECKS, UNIQUE_CHECKS&#x3D;0 *&#x2F;;</span><br><span class="line">&#x2F;*!40014 SET @OLD_FOREIGN_KEY_CHECKS&#x3D;@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS&#x3D;0 *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET @OLD_SQL_MODE&#x3D;@@SQL_MODE, SQL_MODE&#x3D;&#39;NO_AUTO_VALUE_ON_ZERO&#39; *&#x2F;;</span><br><span class="line">&#x2F;*!40111 SET @OLD_SQL_NOTES&#x3D;@@SQL_NOTES, SQL_NOTES&#x3D;0 *&#x2F;;</span><br><span class="line">SET @MYSQLDUMP_TEMP_LOG_BIN &#x3D; @@SESSION.SQL_LOG_BIN;</span><br><span class="line">SET @@SESSION.SQL_LOG_BIN&#x3D; 0;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- GTID state at the beginning of the backup </span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">SET @@GLOBAL.GTID_PURGED&#x3D;&#39;8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-195:1000036-1000040&#39;;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Position to start replication or point-in-time recovery from</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE&#x3D;&#39;mysql-binlog.000036&#39;, MASTER_LOG_POS&#x3D;80147;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Table structure for table &#96;test&#96;</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;test&#96;;</span><br><span class="line">&#x2F;*!40101 SET @saved_cs_client     &#x3D; @@character_set_client *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET character_set_client &#x3D; utf8 *&#x2F;;</span><br><span class="line">CREATE TABLE &#96;test&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4;</span><br><span class="line">&#x2F;*!40101 SET character_set_client &#x3D; @saved_cs_client *&#x2F;;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Dumping data for table &#96;test&#96;</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">LOCK TABLES &#96;test&#96; WRITE;</span><br><span class="line">&#x2F;*!40000 ALTER TABLE &#96;test&#96; DISABLE KEYS *&#x2F;;</span><br><span class="line">INSERT INTO &#96;test&#96; VALUES (1),(2),(3);</span><br><span class="line">&#x2F;*!40000 ALTER TABLE &#96;test&#96; ENABLE KEYS *&#x2F;;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">SET @@SESSION.SQL_LOG_BIN &#x3D; @MYSQLDUMP_TEMP_LOG_BIN;</span><br><span class="line">&#x2F;*!40103 SET TIME_ZONE&#x3D;@OLD_TIME_ZONE *&#x2F;;</span><br><span class="line"></span><br><span class="line">&#x2F;*!40101 SET SQL_MODE&#x3D;@OLD_SQL_MODE *&#x2F;;</span><br><span class="line">&#x2F;*!40014 SET FOREIGN_KEY_CHECKS&#x3D;@OLD_FOREIGN_KEY_CHECKS *&#x2F;;</span><br><span class="line">&#x2F;*!40014 SET UNIQUE_CHECKS&#x3D;@OLD_UNIQUE_CHECKS *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET CHARACTER_SET_CLIENT&#x3D;@OLD_CHARACTER_SET_CLIENT *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET CHARACTER_SET_RESULTS&#x3D;@OLD_CHARACTER_SET_RESULTS *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET COLLATION_CONNECTION&#x3D;@OLD_COLLATION_CONNECTION *&#x2F;;</span><br><span class="line">&#x2F;*!40111 SET SQL_NOTES&#x3D;@OLD_SQL_NOTES *&#x2F;;</span><br><span class="line"></span><br><span class="line">-- Dump completed on 2018-09-25  7:32:05</span><br></pre></td></tr></table></figure>

<p>5、备份完成之后插入新的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:34:  [test1]&gt; insert into test values(4);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>6、刷新binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; flush binary logs;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure>
<p>7、查看binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                          |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000037 |      326 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-196:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>8、在新的binlog文件里面再次插入一条数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:44:  [test1]&gt; insert into test values(5);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>9、查看当前测试的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:45:  [test1]&gt; select * from test;</span><br><span class="line">+----+</span><br><span class="line">| ID |</span><br><span class="line">+----+</span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">|  4 |</span><br><span class="line">|  5 |</span><br><span class="line">+----+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>10、再次刷新binlog文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:45:  [test1]&gt; flush binary logs;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">root@db 07:49:  [test1]&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                                                                                                                          |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-binlog.000038 |      326 |              |                  | 8182e5ae-af54-11e8-af0e-000d3a801ae2:1-13253,</span><br><span class="line">c42e3372-ba21-11e8-99ed-000d3a800ed3:1-2,</span><br><span class="line">d240752c-b809-11e8-8947-000d3a800ed3:1,</span><br><span class="line">dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:1-197:1000036-1000040 |</span><br><span class="line">+---------------------+----------+--------------+------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>11、删除测试表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 07:49:  [test1]&gt; drop table test;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br></pre></td></tr></table></figure>
<p>12、根据备份文件获取测试表test的创建语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e&#39;&#x2F;.&#x2F;&#123;H;$!d;&#125;&#39; -e &#39;x;&#x2F;CREATE TABLE &#96;test&#96;&#x2F;!d;q&#39; &#x2F;data&#x2F;test.dump</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS &#96;test&#96;;</span><br><span class="line">&#x2F;*!40101 SET @saved_cs_client     &#x3D; @@character_set_client *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET character_set_client &#x3D; utf8 *&#x2F;;</span><br><span class="line">CREATE TABLE &#96;test&#96; (</span><br><span class="line">  &#96;ID&#96; int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;ID&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4;</span><br><span class="line">&#x2F;*!40101 SET character_set_client &#x3D; @saved_cs_client *&#x2F;;</span><br></pre></td></tr></table></figure>
<p>13、获取测试表test的数据，并指定到数据文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &#39;INSERT INTO &#96;test&#96;&#39; &#x2F;data&#x2F;test.dump &gt; insert.sql</span><br></pre></td></tr></table></figure>
<p>cat insert.sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;test&#96; VALUES (1),(2),(3);</span><br></pre></td></tr></table></figure>

<p>14、根据test.dump备份文件记录的log-file文件位置和log-pos参数，去获取未备份的关于test表的增删改数据：<br>从mysql-binlog.000036文件开始，–start-position=80147：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog  -v --base64-output&#x3D;decode-rows --set-charset&#x3D;UTF-8 --database&#x3D;test1 --start-position&#x3D;80147  mysql-binlog.000036  &gt; restore.sql</span><br></pre></td></tr></table></figure>
<p>15、获取test表被删除是的pos，文件为mysql-binlog.000038，位置为507：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output&#x3D;DECODE-ROWS --set-charset&#x3D;UTF-8  &#x2F;data&#x2F;mysql&#x2F;log&#x2F;mysql-binlog.000038 |grep DROP  -A15 -B15</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># at 326</span><br><span class="line">#180925  7:49:39 server id 3306101  end_log_pos 387 	GTID	last_committed&#x3D;0	sequence_number&#x3D;1	rbr_only&#x3D;no</span><br><span class="line">SET @@SESSION.GTID_NEXT&#x3D; &#39;dd412cc2-ba1f-11e8-9ba2-000d3a801ae2:198&#39;&#x2F;*!*&#x2F;;</span><br><span class="line"># at 387</span><br><span class="line">#180925  7:49:39 server id 3306101  end_log_pos 507 	Query	thread_id&#x3D;267	exec_time&#x3D;0	error_code&#x3D;0</span><br><span class="line">use &#96;test1&#96;&#x2F;*!*&#x2F;;</span><br><span class="line">SET TIMESTAMP&#x3D;1537861779&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@session.pseudo_thread_id&#x3D;267&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@session.foreign_key_checks&#x3D;1, @@session.sql_auto_is_null&#x3D;0, @@session.unique_checks&#x3D;1, @@session.autocommit&#x3D;1&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@session.sql_mode&#x3D;0&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@session.auto_increment_increment&#x3D;1, @@session.auto_increment_offset&#x3D;29301&#x2F;*!*&#x2F;;</span><br><span class="line">&#x2F;*!\C utf8 *&#x2F;&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@session.character_set_client&#x3D;33,@@session.collation_connection&#x3D;33,@@session.collation_server&#x3D;45&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@session.lc_time_names&#x3D;0&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@session.collation_database&#x3D;DEFAULT&#x2F;*!*&#x2F;;</span><br><span class="line">DROP TABLE &#96;test&#96; &#x2F;* generated by server *&#x2F;</span><br><span class="line">&#x2F;*!*&#x2F;;</span><br><span class="line">SET @@SESSION.GTID_NEXT&#x3D; &#39;AUTOMATIC&#39; &#x2F;* added by mysqlbinlog *&#x2F; &#x2F;*!*&#x2F;;</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">&#x2F;*!50003 SET COMPLETION_TYPE&#x3D;@OLD_COMPLETION_TYPE*&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET CHARACTER_SET_CLIENT&#x3D;@OLD_CHARACTER_SET_CLIENT *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET CHARACTER_SET_RESULTS&#x3D;@OLD_CHARACTER_SET_RESULTS *&#x2F;;</span><br><span class="line">&#x2F;*!40101 SET COLLATION_CONNECTION&#x3D;@OLD_COLLATION_CONNECTION *&#x2F;;</span><br><span class="line">&#x2F;*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE&#x3D;0*&#x2F;;</span><br></pre></td></tr></table></figure>

<p>16、在备份开始binlog文件和记录drop操作的binlog文件之间还存在一个mysql-binlog.000037文件，需要将该文件内记录的信息都导出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output&#x3D;DECODE-ROWS --set-charset&#x3D;UTF-8 mysql-binlog.000037 &gt;&gt; restore.sql</span><br></pre></td></tr></table></figure>
<p>17：将记录drop操作的binlog文件里面drop之前的信息导出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output&#x3D;DECODE-ROWS --set-charset&#x3D;UTF-8 --stop-position&#x3D;507 mysql-binlog.000038 &gt;&gt; restore.sql</span><br></pre></td></tr></table></figure>
<p>18:对导出的文件进行筛选，过滤出test表的相关信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">more restore.sql |grep  --ignore-case -E &#39;insert|update|delete&#39; -A3|grep &#39;&#96;test1&#96;.&#96;test&#96;&#39; -A2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">### INSERT INTO &#96;test1&#96;.&#96;test&#96;</span><br><span class="line">### SET</span><br><span class="line">###   @1&#x3D;4</span><br><span class="line">--</span><br><span class="line">### INSERT INTO &#96;test1&#96;.&#96;test&#96;</span><br><span class="line">### SET</span><br><span class="line">###   @1&#x3D;5</span><br></pre></td></tr></table></figure>
<p>将过滤出来的内容进行编辑，@1为第一列的列名，建议使用sublime或者vim进行批量编辑 ：<br>cat test_insert.sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;test1&#96;.&#96;test&#96; SET   id&#x3D;4  ;</span><br><span class="line">INSERT INTO &#96;test1&#96;.&#96;test&#96; SET   id&#x3D;5  ;</span><br></pre></td></tr></table></figure>
<p>19、执行create table语句，并引用insert.sql和test_insert.sql文件，至此drop掉的test表被恢复。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/09/26/mysql 勿操作drop table之后，利用mysqldump备份和binlog去恢复/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/page/11/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/13/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2020 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>