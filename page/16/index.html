<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 16 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/14/mysql-innodb buffer pool size调整/"><span>[Mysql] mysql-innodb buffer pool size调整</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/14/mysql-innodb buffer pool size调整/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-14T05:03:24.000Z">
          2018-08-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、查看当前数据库innodb-buffer-pool参数"><a href="#1、查看当前数据库innodb-buffer-pool参数" class="headerlink" title="1、查看当前数据库innodb_buffer_pool参数"></a>1、查看当前数据库innodb_buffer_pool参数</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_buffer_pool_size'</span>;</span><br></pre></td></tr></table></figure>
<p>##2、查看page_size大小</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'innodb_page_size'</span>;</span><br></pre></td></tr></table></figure>
<p>官方文档参数详解</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_page_size</span></span><br><span class="line"><span class="string">InnoDB</span> <span class="string">page</span> <span class="string">size</span> <span class="string">(default</span> <span class="string">16KB).</span> <span class="string">Many</span> <span class="string">values</span> <span class="string">are</span> <span class="string">counted</span> <span class="string">in</span> <span class="string">pages;</span> <span class="string">the</span> <span class="string">page</span> <span class="string">size</span> <span class="string">enables</span> <span class="string">them</span> <span class="string">to</span> <span class="string">be</span></span><br><span class="line"><span class="string">easily</span> <span class="string">converted</span> <span class="string">to</span> <span class="string">bytes</span></span><br></pre></td></tr></table></figure>
<h2 id="3、查看当前内存innodb页的总数量和包含数据的页的数量"><a href="#3、查看当前内存innodb页的总数量和包含数据的页的数量" class="headerlink" title="3、查看当前内存innodb页的总数量和包含数据的页的数量"></a>3、查看当前内存innodb页的总数量和包含数据的页的数量</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_data'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Innodb_buffer_pool_pages_total'</span>;</span><br></pre></td></tr></table></figure>
<p>官方文档参数详解：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Innodb_buffer_pool_pages_data</span></span><br><span class="line"><span class="string">The</span> <span class="string">number</span> <span class="string">of</span> <span class="string">pages</span> <span class="string">in</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool</span> <span class="string">containing</span> <span class="string">data.</span> <span class="string">The</span> <span class="string">number</span> <span class="string">includes</span> <span class="string">both</span> <span class="string">dirty</span> <span class="string">and</span></span><br><span class="line"><span class="string">clean</span> <span class="string">pages.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Innodb_buffer_pool_pages_total</span></span><br><span class="line"><span class="string">The</span> <span class="string">total</span> <span class="string">size</span> <span class="string">of</span> <span class="string">the</span> <span class="string">InnoDB</span> <span class="string">buffer</span> <span class="string">pool,</span> <span class="string">in</span> <span class="string">pages.</span></span><br></pre></td></tr></table></figure>
<h2 id="4、调优参考计算方法："><a href="#4、调优参考计算方法：" class="headerlink" title="4、调优参考计算方法："></a>4、调优参考计算方法：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val &#x3D; Innodb_buffer_pool_pages_data &#x2F; Innodb_buffer_pool_pages_total * 100%</span><br><span class="line">val &gt; 95% 则考虑增大 innodb_buffer_pool_size， 建议使用物理内存的75%</span><br><span class="line">val &lt; 95% 则考虑减小 innodb_buffer_pool_size， 建议设置为：Innodb_buffer_pool_pages_data * Innodb_page_size * 1.05 &#x2F; (1024*1024*1024)</span><br></pre></td></tr></table></figure>
<h2 id="5、设置innodb-buffer-pool-siz大小"><a href="#5、设置innodb-buffer-pool-siz大小" class="headerlink" title="5、设置innodb_buffer_pool_siz大小"></a>5、设置innodb_buffer_pool_siz大小</h2><p>设置命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> innodb_buffer_pool_size = <span class="number">17179869184</span>;</span><br></pre></td></tr></table></figure>
<p>缓冲池字节大小，单位kb，如果不设置，默认为128M<br>5.7版本以后可以动态修改参数，但是也要修改配置文件参数，防止重启之后，参数又变成配置文件内的参数,5.7以下的版本为静态参数，需要修改配置文件，并重新启动mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;my.cnf</span><br><span class="line">---------</span><br><span class="line">innodb_buffer_pool_size &#x3D; 17179869184  #设置16G</span><br><span class="line">---------</span><br></pre></td></tr></table></figure>

<h2 id="6、配置参数也可使用M、G等参数，内容如下："><a href="#6、配置参数也可使用M、G等参数，内容如下：" class="headerlink" title="6、配置参数也可使用M、G等参数，内容如下："></a>6、配置参数也可使用M、G等参数，内容如下：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;my.cnf：</span><br><span class="line">-------------------</span><br><span class="line">innodb_buffer_pool_size &#x3D; 16G  #设置16G</span><br><span class="line">innodb_buffer_pool_size &#x3D; 500M  #设置500M</span><br><span class="line">--------------------------</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/14/mysql-innodb buffer pool size调整/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/12/mongodb4.0定时备份并邮件告知备份情况/"><span>[Mongodb] mongodb4.0定时备份并邮件告知备份情况</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/12/mongodb4.0定时备份并邮件告知备份情况/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-12T07:05:24.000Z">
          2018-08-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、mongodb全量备份脚本，内容如下："><a href="#1、mongodb全量备份脚本，内容如下：" class="headerlink" title="1、mongodb全量备份脚本，内容如下："></a>1、mongodb全量备份脚本，内容如下：</h2><p>cat /data/soft/mongodb_backup.sh</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#认证用户名</span></span><br><span class="line"><span class="string">authuser=admin1</span></span><br><span class="line"><span class="comment">#认证用户对应密码</span></span><br><span class="line"><span class="string">authpass=admin123</span></span><br><span class="line"><span class="comment">#备份的服务器地址</span></span><br><span class="line"><span class="string">servername=testrepl/127.0.0.1:30000</span></span><br><span class="line"><span class="comment">#备份的数据库实例名称</span></span><br><span class="line"><span class="string">instancename=test</span></span><br><span class="line"><span class="comment">#认证数据库实例名称</span></span><br><span class="line"><span class="string">authdbname=admin</span></span><br><span class="line"><span class="comment">#备份脚本运行获取到的时间戳</span></span><br><span class="line"><span class="string">stamp=`date</span> <span class="string">+"%Y-%m-%d"`</span></span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line"><span class="string">programname=bulingbuling</span></span><br><span class="line"><span class="comment">#备份文件目录</span></span><br><span class="line"><span class="string">backuppath=/data/backup</span></span><br><span class="line"><span class="comment">#备份文件绝对路径名称</span></span><br><span class="line"><span class="string">backname=$&#123;backuppath&#125;/$&#123;instancename&#125;</span></span><br><span class="line"><span class="comment">#需要删除的备份文件绝对路径名称</span></span><br><span class="line"><span class="string">oldstamp=`date</span> <span class="string">+"%Y-%m-%d"</span> <span class="string">-d</span> <span class="string">"-5 day"</span><span class="string">`</span></span><br><span class="line"><span class="string">oldbackname=$&#123;backname&#125;-$&#123;oldstamp&#125;.dump</span></span><br><span class="line"><span class="comment">#数据库安装路径</span></span><br><span class="line"><span class="string">dbpath=/data/mongodb/bin</span></span><br><span class="line"><span class="comment">#备份操作log目录</span></span><br><span class="line"><span class="string">backuplogname=/tmp/mongodb_bakcup_$&#123;stamp&#125;.log</span></span><br><span class="line"><span class="comment">#当前服务器主机名</span></span><br><span class="line"><span class="string">localname=`hostname`</span></span><br><span class="line"><span class="comment">#当前服务器ip地址</span></span><br><span class="line"><span class="string">localip=`ip</span> <span class="string">a</span> <span class="string">|grep</span> <span class="string">global|</span> <span class="string">head</span> <span class="number">-1</span><span class="string">|</span> <span class="string">awk</span> <span class="string">'&#123;print $2&#125;'</span><span class="string">|awk</span> <span class="string">-F'/'</span> <span class="string">'&#123;print $1&#125;'</span><span class="string">`</span></span><br><span class="line"><span class="comment">#localip='65.52.165.104'</span></span><br><span class="line"><span class="comment">#目标邮箱</span></span><br><span class="line"><span class="string">dest_mail='test@qq.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断指定log文件是否存在，如果存在将其删除</span></span><br><span class="line"><span class="string">if</span> <span class="string">[</span> <span class="string">-e</span> <span class="string">$&#123;backuplogname&#125;</span> <span class="string">];then</span></span><br><span class="line">   <span class="string">sudo</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line">   <span class="string">:</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行失败发送错误邮件</span></span><br><span class="line"><span class="string">send_fail_mail()&#123;</span></span><br><span class="line">	<span class="string">echo</span> <span class="string">"$&#123;programname&#125;备份失败,登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看报错！！！"</span> <span class="string">|mail</span> <span class="string">-s</span> <span class="string">$&#123;programname&#125;数据库备份情况</span> <span class="string">$&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行成功发送成功邮件 </span></span><br><span class="line"><span class="string">send_success_mail()&#123;</span></span><br><span class="line">	<span class="string">echo</span> <span class="string">"$&#123;programname&#125;备份成功,可登录服务器$&#123;localname&#125;-$&#123;localip&#125;的日志$&#123;backuplogname&#125;下查看备份信息。"</span> <span class="string">|mail</span> <span class="string">-s</span> <span class="string">$&#123;programname&#125;数据库备份情况</span> <span class="string">$&#123;dest_mail&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建备份时间函数</span></span><br><span class="line"><span class="string">date_func()&#123;</span></span><br><span class="line">   <span class="string">dateresult=$(($&#123;afterstamp&#125;-$&#123;beforstamp&#125;))</span></span><br><span class="line">   <span class="string">hour=$(($&#123;dateresult&#125;/3600))</span></span><br><span class="line">   <span class="string">min=$((($&#123;dateresult&#125;-$&#123;hour&#125;*3600)/60))</span></span><br><span class="line">   <span class="string">sec=$(($&#123;dateresult&#125;-$&#123;hour&#125;*3600-$&#123;min&#125;*60))</span></span><br><span class="line">   <span class="string">echo</span> <span class="string">"6、本次备份运行时间为:"</span><span class="string">$&#123;hour&#125;时$&#123;min&#125;分$&#123;sec&#125;秒</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个删除五天前的备份数据的函数</span></span><br><span class="line"><span class="string">del_old_bakdata()&#123;</span></span><br><span class="line">   <span class="string">if</span> <span class="string">[</span> <span class="string">-e</span> <span class="string">$&#123;oldbackname&#125;</span> <span class="string">];then</span></span><br><span class="line">   	 <span class="string">sudo</span> <span class="string">echo</span> <span class="string">"7、五天前的备份数据$&#123;oldbackname&#125;存在，进行删除"</span>  <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">   	 <span class="string">rm</span> <span class="string">-rf</span> <span class="string">$&#123;oldbackname&#125;</span></span><br><span class="line">   	 <span class="string">if</span> <span class="string">[</span> <span class="string">$?</span> <span class="string">==</span> <span class="number">0</span> <span class="string">];then</span></span><br><span class="line">   	 	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"7.1、备份数据删除成功"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">   	 <span class="string">else</span></span><br><span class="line">   	 	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"7.1、备份数据删除失败，注意查看失败原因"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">   	 <span class="string">fi</span></span><br><span class="line">   <span class="string">else</span></span><br><span class="line">     <span class="string">sudo</span> <span class="string">echo</span> <span class="string">"7、五天前的备份数据$&#123;oldbackname&#125;不存在，不需要再删除。"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">   <span class="string">fi</span> </span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#因为mongodbdump只能指定路径，不能自定义备份文件名称，因此需要对备份完成的目录重命名</span></span><br><span class="line"><span class="string">rename_backname_func()&#123;</span></span><br><span class="line">	<span class="string">if</span> <span class="string">[</span> <span class="string">-e</span> <span class="string">$&#123;backname&#125;-$&#123;stamp&#125;</span> <span class="string">];then</span></span><br><span class="line">	  <span class="string">mv</span> <span class="string">$&#123;backname&#125;-$&#123;stamp&#125;</span> <span class="string">$&#123;backname&#125;-$&#123;stamp&#125;-old</span></span><br><span class="line">	  <span class="string">mv</span> <span class="string">$&#123;backname&#125;</span> <span class="string">$&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line">	  <span class="string">if</span> <span class="string">[</span> <span class="string">$?</span> <span class="string">==</span> <span class="number">0</span> <span class="string">];then</span></span><br><span class="line">	    <span class="string">echo</span> <span class="string">"5、备份目录重命名成功"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">	  <span class="string">else</span></span><br><span class="line">	    <span class="string">echo</span> <span class="string">"5、备份目录重命名失败,查看命名失败原因！"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">	  <span class="string">fi</span></span><br><span class="line">	<span class="string">else</span></span><br><span class="line">	  <span class="string">mv</span> <span class="string">$&#123;backname&#125;</span> <span class="string">$&#123;backname&#125;-$&#123;stamp&#125;</span></span><br><span class="line">	  <span class="string">if</span> <span class="string">[</span> <span class="string">$?</span> <span class="string">==</span> <span class="number">0</span> <span class="string">];then</span></span><br><span class="line">	    <span class="string">echo</span> <span class="string">"5、备份目录重命名成功"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">	  <span class="string">else</span></span><br><span class="line">	    <span class="string">echo</span> <span class="string">"5、备份目录重命名失败,查看命名失败原因！"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">	  <span class="string">fi</span></span><br><span class="line">	<span class="string">fi</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份目录是否存在</span></span><br><span class="line"><span class="string">if</span> <span class="string">[</span> <span class="string">-d</span> <span class="string">$&#123;backuppath&#125;</span> <span class="string">];then</span></span><br><span class="line">	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"1、备份目录存在,可执行备份操作"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line">	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"1、备份目录不存在,手动创建"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">	<span class="string">sudo</span> <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">$&#123;backuppath&#125;</span></span><br><span class="line">	<span class="string">if</span> <span class="string">[</span> <span class="string">$?</span> <span class="string">==</span> <span class="number">0</span> <span class="string">];then</span></span><br><span class="line">	   <span class="string">sudo</span> <span class="string">echo</span> <span class="string">"1.1、备份目录创建成功，可进行下面操作"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">	<span class="string">else</span></span><br><span class="line">	   <span class="string">sudo</span> <span class="string">echo</span> <span class="string">"1.1、备份目录不存在，且创建失败，无法进行下面操作，退出备份"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">	   <span class="string">exit</span></span><br><span class="line">	<span class="string">fi</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份文件是否已经存在</span></span><br><span class="line"><span class="string">if</span> <span class="string">[</span> <span class="string">-d</span> <span class="string">$&#123;backname&#125;</span> <span class="string">];then</span></span><br><span class="line">	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"2、指定的备份实例目录$&#123;backname&#125;已存在，对其进行重命名"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">$&#123;backname&#125;</span> <span class="string">$&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump</span></span><br><span class="line">    <span class="string">if</span> <span class="string">[</span> <span class="string">$?</span> <span class="string">==</span> <span class="number">0</span> <span class="string">];then</span></span><br><span class="line">    	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"2.1、文件已重新命名为$&#123;backuppath&#125;/bak-$&#123;fullbackupname&#125;-$&#123;stamp&#125;.dump,可继续备份"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="string">else</span></span><br><span class="line">    	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"2.1、文件重命名失败，退出备份操作"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">    	<span class="string">exit</span></span><br><span class="line">    <span class="string">fi</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line">	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"2、指定的备份文件不存在，开始进行备份"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前时间戳</span></span><br><span class="line"><span class="string">beforstamp=`date</span> <span class="string">+%s`</span></span><br><span class="line"><span class="comment">#开始全量备份数据库</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">echo</span> <span class="string">"3、开始全量备份数据库"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="string">$&#123;dbpath&#125;/mongodump</span> <span class="string">-h</span> <span class="string">$&#123;servername&#125;</span> <span class="string">-u</span> <span class="string">$&#123;authuser&#125;</span> <span class="string">-p</span> <span class="string">$&#123;authpass&#125;</span> <span class="string">-d</span> <span class="string">$&#123;instancename&#125;</span> <span class="string">-o</span> <span class="string">$&#123;backuppath&#125;</span> <span class="string">--authenticationDatabase</span> <span class="string">$&#123;authdbname&#125;</span></span><br><span class="line"><span class="string">backupresult=$?</span></span><br><span class="line"><span class="string">afterstamp=`date</span> <span class="string">+%s`</span></span><br><span class="line"><span class="string">if</span> <span class="string">[</span> <span class="string">$&#123;backupresult&#125;</span> <span class="string">==</span> <span class="number">0</span> <span class="string">];then</span></span><br><span class="line">    	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份成功,文件名称为$&#123;backname&#125;，重命名备份文件"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">    	<span class="string">rename_backname_func</span></span><br><span class="line">    	<span class="string">date_func</span></span><br><span class="line">        <span class="string">del_old_bakdata</span></span><br><span class="line">        <span class="string">send_success_mail</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line">    	<span class="string">sudo</span> <span class="string">echo</span> <span class="string">"4、$&#123;programname&#125;-$&#123;instancename&#125;数据库备份失败,注意查看备份失败原因并重新备份"</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;backuplogname&#125;</span></span><br><span class="line">    	<span class="string">send_fail_mail</span></span><br><span class="line">    	<span class="string">exit</span></span><br><span class="line"><span class="string">fi</span></span><br></pre></td></tr></table></figure>
<p>使用该脚本需要修改自己数据库对应的用户名authuser,密码authpass,邮箱dest_mail,项目名称programname,服务器名称servername,数据库实例名称instancename,mongodb数据库安装路径dbpath。其他参数可使用脚本内默认的，也可自行修改</p>
<h2 id="2、配置邮件发送功能"><a href="#2、配置邮件发送功能" class="headerlink" title="2、配置邮件发送功能"></a>2、配置邮件发送功能</h2><p>2.1、安装mailx软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mailx</span><br></pre></td></tr></table></figure>
<p>2.2、修改配置文件/etc/mail.rc,在行尾添加一下信息：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">from=test@qq.com</span> <span class="string">smtp=smtp.qq.com</span></span><br><span class="line"><span class="string">set</span> <span class="string">smtp-auth-user=test@qq.com</span> <span class="string">smtp-auth-password=testpassword</span> <span class="string">smtp-auth=login</span></span><br></pre></td></tr></table></figure>
<p>参数详解：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">from:指定发送邮件的发件人</span></span><br><span class="line"><span class="string">smtp:指定smtp服务器信息</span></span><br><span class="line"><span class="string">smtp-auth-user:允许第三方登录的用户名</span></span><br><span class="line"><span class="string">smtp-auth-password：允许第三方登录的密码</span></span><br></pre></td></tr></table></figure>
<p>2.3、发送测试邮件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">'test email'</span> <span class="string">|mail</span> <span class="string">-s</span> <span class="string">'title'</span> <span class="string">test@qq.com</span></span><br></pre></td></tr></table></figure>
<p>title:指定发送文件的标题，可自行定义</p>
<h2 id="3、修改备份脚本权限"><a href="#3、修改备份脚本权限" class="headerlink" title="3、修改备份脚本权限"></a>3、修改备份脚本权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure>

<h2 id="4、将脚本添加到定时任务"><a href="#4、将脚本添加到定时任务" class="headerlink" title="4、将脚本添加到定时任务"></a>4、将脚本添加到定时任务</h2><p>如：每天凌晨一点备份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; crontab -e</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/soft/mongodb_backup.sh</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/12/mongodb4.0定时备份并邮件告知备份情况/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/12/mongdob4.0 备份与恢复/"><span>[Mongodb] mongodb4.0备份与恢复</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/12/mongdob4.0 备份与恢复/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-12T04:06:00.000Z">
          2018-08-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、mongodb备份命令"><a href="#1、mongodb备份命令" class="headerlink" title="1、mongodb备份命令"></a>1、mongodb备份命令</h2><p>1.1、备份之前查看备份实例的相关数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.auth(&#39;admin1&#39;,&#39;admin123&#39;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; use test;</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure>
<p>1.2、对于replica set集群模式命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongodump -h <span class="string">"testrepl/127.0.0.1:30000"</span> -u admin1 -p admin123 -d <span class="built_in">test</span> -o /data/backup/ --authenticationDatabase admin</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-12T03:40:01.489+0000</span>    <span class="string">writing</span> <span class="string">test.test_collection</span> <span class="string">to</span> </span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-12T03:40:03.823+0000</span>    <span class="string">done</span> <span class="string">dumping</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br></pre></td></tr></table></figure>
<p>会在指定的备份目录下，生成备份实例名对应的文件夹，文件夹下有以下文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_collection.bson  test_collection.metadata.json</span><br></pre></td></tr></table></figure>
<p>命令参数详解：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">-h:指定当前备份主机ip</span></span><br><span class="line"><span class="string">--port:指定当前mongodb的启动端口</span></span><br><span class="line"><span class="string">-u:指定验证的用户名</span></span><br><span class="line"><span class="string">-d:需要备份的数据库实例</span></span><br><span class="line"><span class="string">-p:指定用户名对应的密码</span></span><br><span class="line"><span class="string">-o:指定备份的路径</span></span><br><span class="line"><span class="string">--authenticationDatabase:认证数据库</span></span><br></pre></td></tr></table></figure>
<p>备份过程没有加上指定认证数据库“–authenticationDatabase admin”,会报一下错误</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Failed: error connecting to db server: server returned error on SASL authentication step:</span> <span class="string">Authentication</span> <span class="string">failed.</span></span><br></pre></td></tr></table></figure>
<p>1.3、对于单节点备份命令如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/data/mongodb/bin/mongodump</span> <span class="string">-h</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">--port</span> <span class="number">30000</span> <span class="string">-u</span> <span class="string">admin1</span> <span class="string">-p</span> <span class="string">admin123</span> <span class="string">-d</span> <span class="string">test</span> <span class="string">-o</span> <span class="string">/data/backup</span> <span class="string">--authenticationDatabase</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>


<h2 id="2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-："><a href="#2、拷贝备份出来的文件，新建一台新节点-10-0-7-36-mongodb-并做恢复测试-恢复命令如下-因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作-：" class="headerlink" title="2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)："></a>2、拷贝备份出来的文件，新建一台新节点(10.0.7.36)mongodb,并做恢复测试,恢复命令如下(因为测试环境节点有限，该恢复操作是将一个集群模式的备份，恢复到一个单点上的操作)：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongorestore -h 10.0.7.36 --port 30000  -u admin1 -p admin123 -d <span class="built_in">test</span>  /data/backup/<span class="built_in">test</span> --authenticationDatabase admin</span><br></pre></td></tr></table></figure>
<p>恢复输出结果如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:48.860+0000</span>    <span class="string">the</span> <span class="string">--db</span> <span class="string">and</span> <span class="string">--collection</span> <span class="string">args</span> <span class="string">should</span> <span class="string">only</span> <span class="string">be</span> <span class="string">used</span> <span class="string">when</span> <span class="string">restoring</span> <span class="string">from</span> <span class="string">a</span> <span class="string">BSON</span> <span class="string">file.</span> <span class="string">Other</span> <span class="string">uses</span> <span class="string">are</span> <span class="string">deprecated</span> <span class="string">and</span> <span class="string">will</span> <span class="string">not</span> <span class="string">exist</span> <span class="string">in</span> <span class="string">the</span> <span class="string">future;</span> <span class="string">use</span> <span class="string">--nsInclude</span> <span class="string">instead</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:48.860+0000</span>    <span class="string">building</span> <span class="string">a</span> <span class="string">list</span> <span class="string">of</span> <span class="string">collections</span> <span class="string">to</span> <span class="string">restore</span> <span class="string">from</span> <span class="string">/data/backup/test</span> <span class="string">dir</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:48.885+0000</span>    <span class="string">reading</span> <span class="string">metadata</span> <span class="string">for</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.metadata.json</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:48.972+0000</span>    <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">/data/backup/test/test_collection.bson</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:51.781+0000</span>    <span class="string">[###########.............]</span>  <span class="string">test.test_collection</span>  <span class="number">28.</span><span class="string">4MB/57.1MB</span>  <span class="string">(49.8%)</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:54.490+0000</span>    <span class="string">[########################]</span>  <span class="string">test.test_collection</span>  <span class="number">57.</span><span class="string">1MB/57.1MB</span>  <span class="string">(100.0%)</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:54.490+0000</span>    <span class="string">restoring</span> <span class="string">indexes</span> <span class="string">for</span> <span class="string">collection</span> <span class="string">test.test_collection</span> <span class="string">from</span> <span class="string">metadata</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:57.737+0000</span>    <span class="string">finished</span> <span class="string">restoring</span> <span class="string">test.test_collection</span> <span class="string">(844703</span> <span class="string">documents)</span></span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="string">-11T14:19:57.737+0000</span>    <span class="string">done</span></span><br></pre></td></tr></table></figure>
<p>控制台登录，查看数据是否一致：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise &gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">MongoDB Enterprise &gt; db.auth(&#39;admin1&#39;,&#39;admin123&#39;);</span><br><span class="line">1</span><br><span class="line">MongoDB Enterprise &gt; show dbs;</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">test    0.031GB</span><br><span class="line">MongoDB Enterprise &gt; use test</span><br><span class="line">switched to db test</span><br><span class="line">MongoDB Enterprise &gt; show tables;</span><br><span class="line">test_collection</span><br><span class="line">MongoDB Enterprise &gt; db.test_collection.find().count();</span><br><span class="line">844703</span><br></pre></td></tr></table></figure>
<p>恢复完成</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/12/mongdob4.0 备份与恢复/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/11/使用innodb trx和innodb lock信息表查看锁事物/"><span>[Mysql] 使用innodb trx和innodb lock信息表查看锁事物</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/11/使用innodb trx和innodb lock信息表查看锁事物/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-11T09:10:24.000Z">
          2018-08-11
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、插入表测试数据"><a href="#1、插入表测试数据" class="headerlink" title="1、插入表测试数据"></a>1、插入表测试数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> aaa;</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">| id | name | telephone   |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br><span class="line">|  1 | a    | 11111111111 |</span><br><span class="line">|  2 | b    | 22222222222 |</span><br><span class="line">|  3 | c    | 33333333333 |</span><br><span class="line">+<span class="comment">----+------+-------------+</span></span><br></pre></td></tr></table></figure>
<h2 id="2、创建三个会话，造成锁事物"><a href="#2、创建三个会话，造成锁事物" class="headerlink" title="2、创建三个会话，造成锁事物"></a>2、创建三个会话，造成锁事物</h2><p>sessin 1:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">60</span>);</span><br></pre></td></tr></table></figure>
<p>session 2:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>
<p>sesion 3:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>
<h2 id="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："><a href="#3、使用以下查询来查看正在等待的事务以及阻止它们的事务：" class="headerlink" title="3、使用以下查询来查看正在等待的事务以及阻止它们的事务："></a>3、使用以下查询来查看正在等待的事务以及阻止它们的事务：</h2><p>session 4</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  r.trx_id waiting_trx_id,</span><br><span class="line">  r.trx_mysql_thread_id waiting_thread,</span><br><span class="line">  r.trx_query waiting_query,</span><br><span class="line">  b.trx_id blocking_trx_id,</span><br><span class="line">  b.trx_mysql_thread_id blocking_thread,</span><br><span class="line">  b.trx_query blocking_query</span><br><span class="line"><span class="keyword">FROM</span>       information_schema.innodb_lock_waits w</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx b</span><br><span class="line">  <span class="keyword">ON</span> b.trx_id = w.blocking_trx_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> information_schema.innodb_trx r</span><br><span class="line">  <span class="keyword">ON</span> r.trx_id = w.requesting_trx_id;</span><br><span class="line">查询结果如下：</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| waiting_trx_id | waiting_thread | waiting_query                        | blocking_trx_id | blocking_thread | blocking_query                  |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br><span class="line">| 2488           |             58 | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2487</span>            |              <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">| <span class="number">2488</span>           |             <span class="number">58</span> | <span class="keyword">SELECT</span> telephone <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">| <span class="number">2487</span>           |             <span class="number">57</span> | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>      | <span class="number">2486</span>            |              <span class="number">53</span> | <span class="keyword">SELECT</span> <span class="keyword">SLEEP</span>(<span class="number">100</span>)               |</span><br><span class="line">+<span class="comment">----------------+----------------+--------------------------------------+-----------------+-----------------+---------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>上述sql语句可能太繁琐，也可使用下面语句查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  waiting_trx_id,</span><br><span class="line">  waiting_pid,</span><br><span class="line">  waiting_query,</span><br><span class="line">  blocking_trx_id,</span><br><span class="line">  blocking_pid,</span><br><span class="line">  blocking_query</span><br><span class="line"><span class="keyword">FROM</span> sys.innodb_lock_waits;</span><br></pre></td></tr></table></figure>
<h2 id="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物"><a href="#4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process-id-来查询琐事物" class="headerlink" title="4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物"></a>4、如果查询造成锁事物的会话已经变成空闲，上面查询出来的数据会变为空，可以通过process_id,来查询琐事物</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>;</span><br><span class="line">| 57 | root        | localhost | aaaa | Sleep   |    566 |                                                        | NULL                  |</span><br></pre></td></tr></table></figure>
<p>查询出process_id为57</p>
<h2 id="5、通过processlist-id查询出thread-id"><a href="#5、通过processlist-id查询出thread-id" class="headerlink" title="5、通过processlist_id查询出thread_id"></a>5、通过processlist_id查询出thread_id</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID <span class="keyword">FROM</span> performance_schema.threads <span class="keyword">WHERE</span> PROCESSLIST_ID = <span class="number">57</span>;</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| THREAD_ID |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">|        79 |</span><br><span class="line">+<span class="comment">-----------+</span></span><br></pre></td></tr></table></figure>
<h2 id="6、根据thread-id查询出来造成锁事物的sql语句"><a href="#6、根据thread-id查询出来造成锁事物的sql语句" class="headerlink" title="6、根据thread_id查询出来造成锁事物的sql语句"></a>6、根据thread_id查询出来造成锁事物的sql语句</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_current </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span>\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">THREAD_ID: <span class="number">79</span></span><br><span class="line"> SQL_TEXT: <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。"><a href="#7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance-Schema-events-statements-history-表以查看该线程执行的最后10个语句。" class="headerlink" title="7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。"></a>7、如果线程执行的最后一个查询不足以确定锁定的原因，则可以查询Performance Schema events_statements_history 表以查看该线程执行的最后10个语句。</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> THREAD_ID, SQL_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_history </span><br><span class="line"><span class="keyword">WHERE</span> THREAD_ID = <span class="number">79</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> EVENT_ID;</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">| THREAD_ID | SQL_TEXT                        |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br><span class="line">|        79 | <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> aaa <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> |</span><br><span class="line">+<span class="comment">-----------+---------------------------------+</span></span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/11/使用innodb trx和innodb lock信息表查看锁事物/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/11/mysql- Lock wait timeout exceeded; try restarting transaction/"><span>[Mysql] ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/11/mysql- Lock wait timeout exceeded; try restarting transaction/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-11T02:03:24.000Z">
          2018-08-11
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、对一个表进行ddl操作"><a href="#1、对一个表进行ddl操作" class="headerlink" title="1、对一个表进行ddl操作"></a>1、对一个表进行ddl操作</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mysql&gt;ALTER</span> <span class="string">TABLE</span> <span class="string">deposit_coin_order_user</span> <span class="string">add</span> <span class="string">`txid`</span>  <span class="string">varchar(128)</span> <span class="string">CHARACTER</span> <span class="string">SET</span> <span class="string">utf8mb4</span> <span class="string">COLLATE</span> <span class="string">utf8mb4_general_ci</span> <span class="string">NOT</span> <span class="literal">NULL</span> <span class="string">COMMENT</span> <span class="string">'区块链id'</span> <span class="string">;</span></span><br><span class="line"><span class="string">提示报错：</span></span><br><span class="line"><span class="string">ERROR</span> <span class="number">1205</span> <span class="string">(HY000):</span> <span class="string">Lock</span> <span class="string">wait</span> <span class="string">timeout</span> <span class="string">exceeded;</span> <span class="string">try</span> <span class="string">restarting</span> <span class="string">transaction</span></span><br></pre></td></tr></table></figure>
<p>查看该表数据只有39行数据：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">select</span> <span class="string">count(*)</span> <span class="string">from</span> <span class="string">deposit_coin_order_user;</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">|</span> <span class="string">count(*)</span> <span class="string">|</span></span><br><span class="line"><span class="string">+----------+</span></span><br><span class="line"><span class="string">|</span>       <span class="number">39</span> <span class="string">|</span></span><br><span class="line"><span class="string">+----------+</span></span><br></pre></td></tr></table></figure>

<h2 id="2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’"><a href="#2、查看事物表Innodb-trx是否记录相关事物，如果有找到该事物的‘trx-mysql-thread-id’" class="headerlink" title="2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’"></a>2、查看事物表Innodb_trx是否记录相关事物，如果有找到该事物的‘trx_mysql_thread_id’</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">SELECT</span> <span class="string">*</span> <span class="string">FROM</span> <span class="string">information_schema.INNODB_TRX\G</span></span><br><span class="line"><span class="string">***************************</span> <span class="number">1</span><span class="string">.</span> <span class="string">row</span> <span class="string">***************************</span></span><br><span class="line">                    <span class="attr">trx_id:</span> <span class="number">421462261342800</span></span><br><span class="line">                 <span class="attr">trx_state:</span> <span class="string">RUNNING</span></span><br><span class="line">               <span class="attr">trx_started:</span> <span class="number">2018</span><span class="number">-08</span><span class="number">-10</span> <span class="number">08</span><span class="string">:24:58</span></span><br><span class="line">     <span class="attr">trx_requested_lock_id:</span> <span class="literal">NULL</span></span><br><span class="line">          <span class="attr">trx_wait_started:</span> <span class="literal">NULL</span></span><br><span class="line">                <span class="attr">trx_weight:</span> <span class="number">0</span></span><br><span class="line">       <span class="attr">trx_mysql_thread_id:</span> <span class="number">12989053</span></span><br><span class="line">                 <span class="attr">trx_query:</span> <span class="literal">NULL</span></span><br><span class="line">       <span class="attr">trx_operation_state:</span> <span class="literal">NULL</span></span><br><span class="line">         <span class="attr">trx_tables_in_use:</span> <span class="number">0</span></span><br><span class="line">         <span class="attr">trx_tables_locked:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">trx_lock_structs:</span> <span class="number">0</span></span><br><span class="line">     <span class="attr">trx_lock_memory_bytes:</span> <span class="number">1136</span></span><br><span class="line">           <span class="attr">trx_rows_locked:</span> <span class="number">0</span></span><br><span class="line">         <span class="attr">trx_rows_modified:</span> <span class="number">0</span></span><br><span class="line">   <span class="attr">trx_concurrency_tickets:</span> <span class="number">0</span></span><br><span class="line">       <span class="attr">trx_isolation_level:</span> <span class="string">REPEATABLE</span> <span class="string">READ</span></span><br><span class="line">         <span class="attr">trx_unique_checks:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">trx_foreign_key_checks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">trx_last_foreign_key_error:</span> <span class="literal">NULL</span></span><br><span class="line"> <span class="attr">trx_adaptive_hash_latched:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">trx_adaptive_hash_timeout:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">trx_is_read_only:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">trx_autocommit_non_locking:</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br></pre></td></tr></table></figure>
<p>使用show full processlist查看是否有‘trx_mysql_thread_id’对应的进程，如果有就证明这个sleep的线程事务一直没有commit或者rollback而是卡住了，我们需要手动kill掉。没有的话看看有没有正在执行的很慢SQL记录线程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show full processlist;</span><br><span class="line">| 12989053 | cwreadonly                        | 10.1.10.9:51650  | exchange_market | Sleep            |   1189 |                                                               | NULL</span><br></pre></td></tr></table></figure>
<h2 id="3、发现有id为12989053的sql，需要手动kill掉"><a href="#3、发现有id为12989053的sql，需要手动kill掉" class="headerlink" title="3、发现有id为12989053的sql，需要手动kill掉"></a>3、发现有id为12989053的sql，需要手动kill掉</h2><p>mysql &gt; KILL 12989053;</p>
<h2 id="4、再次执行ddl语句，正常执行"><a href="#4、再次执行ddl语句，正常执行" class="headerlink" title="4、再次执行ddl语句，正常执行"></a>4、再次执行ddl语句，正常执行</h2><p>ALTER TABLE deposit_coin_order_user add <code>txid</code>  varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT ‘区块链id’ ;</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/11/mysql- Lock wait timeout exceeded; try restarting transaction/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/10/mysql定时备份及邮件告知备份情况/"><span>[Mysql] mysql定时备份及邮件告知备份情况</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/10/mysql定时备份及邮件告知备份情况/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-10T06:05:24.000Z">
          2018-08-10
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、mysql全量备份脚本，内容如下："><a href="#1、mysql全量备份脚本，内容如下：" class="headerlink" title="1、mysql全量备份脚本，内容如下："></a>1、mysql全量备份脚本，内容如下：</h2><p>cat /data/soft/mysql_backup.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#数据库用户名</span></span><br><span class="line">dbuser=<span class="built_in">test</span></span><br><span class="line"><span class="comment">#数据库密码</span></span><br><span class="line">dbpass=<span class="built_in">test</span></span><br><span class="line"><span class="comment">#备份脚本运行获取到的时间戳</span></span><br><span class="line">stamp=`date +<span class="string">"%Y-%m-%d"</span>`</span><br><span class="line"><span class="comment">#项目名称</span></span><br><span class="line">programname=mw</span><br><span class="line"><span class="comment">#备份文件名称前缀</span></span><br><span class="line">fullbackupname=<span class="variable">$&#123;programname&#125;</span>-dbfullbak</span><br><span class="line"><span class="comment">#备份文件目录</span></span><br><span class="line">backuppath=/data/backup</span><br><span class="line"><span class="comment">#备份文件绝对路径名称</span></span><br><span class="line">backname=<span class="variable">$backuppath</span>/<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump</span><br><span class="line"><span class="comment">#需要删除的备份文件绝对路径名称</span></span><br><span class="line">oldstamp=`date +<span class="string">"%Y-%m-%d"</span> -d <span class="string">"-5 day"</span>`</span><br><span class="line">oldbackname=<span class="variable">$backuppath</span>/<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;oldstamp&#125;</span>.dump</span><br><span class="line"><span class="comment">#数据库安装路径</span></span><br><span class="line">dbpath=/data/mysql/bin</span><br><span class="line"><span class="comment">#备份操作log目录</span></span><br><span class="line">backuplogname=/tmp/backup_<span class="variable">$&#123;stamp&#125;</span>.<span class="built_in">log</span></span><br><span class="line"><span class="comment">#当前服务器主机名</span></span><br><span class="line">localname=`hostname`</span><br><span class="line"><span class="comment">#当前服务器ip地址</span></span><br><span class="line">localip=`ip a |grep global| head -1| awk <span class="string">'&#123;print $2&#125;'</span>|awk -F<span class="string">'/'</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="comment">#localip='65.52.165.104'</span></span><br><span class="line"><span class="comment">#目标邮箱</span></span><br><span class="line">dest_mail=<span class="string">'test@qq.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断指定log文件是否存在，如果存在将其删除</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;backuplogname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">   sudo rm -rf <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   :</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行失败发送错误邮件</span></span><br><span class="line"><span class="function"><span class="title">send_fail_mail</span></span>()&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;programname&#125;</span>备份失败,登录服务器<span class="variable">$&#123;localname&#125;</span>-<span class="variable">$&#123;localip&#125;</span>的日志<span class="variable">$&#123;backuplogname&#125;</span>下查看报错！！！"</span> |mail -s <span class="variable">$&#123;programname&#125;</span>数据库备份情况 <span class="variable">$&#123;dest_mail&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份执行成功发送成功邮件 </span></span><br><span class="line"><span class="function"><span class="title">send_success_mail</span></span>()&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;programname&#125;</span>备份成功,可登录服务器<span class="variable">$&#123;localname&#125;</span>-<span class="variable">$&#123;localip&#125;</span>的日志<span class="variable">$&#123;backuplogname&#125;</span>下查看备份信息。"</span> |mail -s <span class="variable">$&#123;programname&#125;</span>数据库备份情况 <span class="variable">$&#123;dest_mail&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建备份时间函数</span></span><br><span class="line"><span class="function"><span class="title">date_func</span></span>()&#123;</span><br><span class="line">   dateresult=$((<span class="variable">$&#123;afterstamp&#125;</span>-<span class="variable">$&#123;beforstamp&#125;</span>))</span><br><span class="line">   hour=$((<span class="variable">$&#123;dateresult&#125;</span>/3600))</span><br><span class="line">   min=$(((<span class="variable">$&#123;dateresult&#125;</span>-<span class="variable">$&#123;hour&#125;</span>*3600)/60))</span><br><span class="line">   sec=$((<span class="variable">$&#123;dateresult&#125;</span>-<span class="variable">$&#123;hour&#125;</span>*3600-<span class="variable">$&#123;min&#125;</span>*60))</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"5、本次备份运行时间为:"</span><span class="variable">$&#123;hour&#125;</span>时<span class="variable">$&#123;min&#125;</span>分<span class="variable">$&#123;sec&#125;</span>秒 &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个删除五天前的备份数据的函数</span></span><br><span class="line"><span class="function"><span class="title">del_old_bakdata</span></span>()&#123;</span><br><span class="line">   <span class="keyword">if</span> [ -e <span class="variable">$&#123;oldbackname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">   	 sudo <span class="built_in">echo</span> <span class="string">"6、五天前的备份数据<span class="variable">$&#123;oldbackname&#125;</span>存在，进行删除"</span>  &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   	 rm -rf <span class="variable">$&#123;oldbackname&#125;</span></span><br><span class="line">   	 <span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">   	 	sudo <span class="built_in">echo</span> <span class="string">"6.1、备份数据删除成功"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   	 <span class="keyword">else</span></span><br><span class="line">   	 	sudo <span class="built_in">echo</span> <span class="string">"6.1、备份数据删除失败，注意查看失败原因"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   	 <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">     sudo <span class="built_in">echo</span> <span class="string">"6、五天前的备份数据<span class="variable">$&#123;oldbackname&#125;</span>不存在，不需要再删除。"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">   <span class="keyword">fi</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份目录是否存在</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$&#123;backuppath&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">	sudo <span class="built_in">echo</span> <span class="string">"1、备份目录存在,可执行备份操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	sudo <span class="built_in">echo</span> <span class="string">"1、备份目录不存在,手动创建"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">	sudo mkdir -p <span class="variable">$&#123;backuppath&#125;</span></span><br><span class="line">	<span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">	   sudo <span class="built_in">echo</span> <span class="string">"1.1、备份目录创建成功，可进行下面操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	   sudo <span class="built_in">echo</span> <span class="string">"1.1、备份目录不存在，且创建失败，无法进行下面操作，退出备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">	   <span class="built_in">exit</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前判断备份文件是否已经存在</span></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$&#123;backname&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">	sudo <span class="built_in">echo</span> <span class="string">"2、指定的备份文件<span class="variable">$&#123;backname&#125;</span>已存在，对其进行重命名"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    mv <span class="variable">$&#123;backname&#125;</span> <span class="variable">$&#123;backuppath&#125;</span>/bak-<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump</span><br><span class="line">    <span class="keyword">if</span> [ $? == 0 ];<span class="keyword">then</span></span><br><span class="line">    	sudo <span class="built_in">echo</span> <span class="string">"2.1、文件已重新命名为<span class="variable">$&#123;backuppath&#125;</span>/bak-<span class="variable">$&#123;fullbackupname&#125;</span>-<span class="variable">$&#123;stamp&#125;</span>.dump,可继续备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    	sudo <span class="built_in">echo</span> <span class="string">"2.1、文件重命名失败，退出备份操作"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    	<span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	sudo <span class="built_in">echo</span> <span class="string">"2、指定的备份文件不存在，开始进行备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份之前时间戳</span></span><br><span class="line">beforstamp=`date +%s`</span><br><span class="line"><span class="comment">#开始全量备份数据库</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"3、开始全量备份数据库"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line"><span class="variable">$&#123;dbpath&#125;</span>/mysqldump -u<span class="variable">$&#123;dbuser&#125;</span> -p<span class="variable">$&#123;dbpass&#125;</span> --all-databases  --single-transaction --master-data=2 --quick --<span class="built_in">set</span>-gtid-purged=OFF &gt; <span class="variable">$&#123;backname&#125;</span></span><br><span class="line">backupresult=$?</span><br><span class="line">afterstamp=`date +%s`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$&#123;backupresult&#125;</span> == 0 ];<span class="keyword">then</span></span><br><span class="line">    	sudo <span class="built_in">echo</span> <span class="string">"4、<span class="variable">$&#123;programname&#125;</span>数据库备份成功,文件名称为<span class="variable">$&#123;backname&#125;</span>，准备删除五天前的备份数据"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    	date_func</span><br><span class="line">        del_old_bakdata</span><br><span class="line">        send_success_mail</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    	sudo <span class="built_in">echo</span> <span class="string">"4、<span class="variable">$&#123;programname&#125;</span>数据库备份失败,注意查看备份失败原因并重新备份"</span> &gt;&gt; <span class="variable">$&#123;backuplogname&#125;</span></span><br><span class="line">    	send_fail_mail</span><br><span class="line">    	<span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>使用该脚本需要修改自己数据库对应的用户名dbuser,密码dbpass,邮箱dest_mail,项目名称programname,mysql数据库安装路径dbpath。其他参数可使用脚本内默认的，也可自行修改<br>其中–single-transaction：该参数在备份前将隔离模式设为repeatable read并启动start transaction语句。该参数只对innodb事物表有作用，当启动start transaction时开始备份数据库一致性状态，并不阻塞其他的应用。对于myisam和memory数据引擎使用这个参数备份的时候状态是实时改变的。另外该参数与–lock-tables参数是相互排斥的，lock-tables会是隐式吧提交的事物产生等待。<br>–master-data=2：使用该参数指备份执行时binglog开始的坐标，在输出结果中属于change master to语句，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE&#x3D;&#39;mysql-binlog.000036&#39;, MASTER_LOG_POS&#x3D;79549;</span><br></pre></td></tr></table></figure>
<p>如果使用该参数不指定值，默认值为1，语句不会以注释的形式写入，当dump文件被加载时该行参数会影响加载过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_LOG_FILE&#x3D;&#39;mysql-binlog.000036&#39;, MASTER_LOG_POS&#x3D;79549;</span><br></pre></td></tr></table></figure>
<p>如果指定参数为2，会以注释的形式写入输出文件，dump文件被加载也不会受该行语句影响。</p>
<p>–quick：对于备份大表比较有用，该参数强制mysqldump命令一次性从数据库中获取表的行，而不是先获取行集合，在写出之前把他们缓存到内存。</p>
<h2 id="2、配置邮件发送功能"><a href="#2、配置邮件发送功能" class="headerlink" title="2、配置邮件发送功能"></a>2、配置邮件发送功能</h2><p>2.1、安装mailx软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mailx</span><br></pre></td></tr></table></figure>
<p>2.2、修改配置文件/etc/mail.rc,在行尾添加一下信息：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">from=test@qq.com</span> <span class="string">smtp=smtp.qq.com</span></span><br><span class="line"><span class="string">set</span> <span class="string">smtp-auth-user=test@qq.com</span> <span class="string">smtp-auth-password=testpassword</span> <span class="string">smtp-auth=login</span></span><br></pre></td></tr></table></figure>
<p>参数详解：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">from:指定发送邮件的发件人</span></span><br><span class="line"><span class="string">smtp:指定smtp服务器信息</span></span><br><span class="line"><span class="string">smtp-auth-user:允许第三方登录的用户名</span></span><br><span class="line"><span class="string">smtp-auth-password：允许第三方登录的密码</span></span><br></pre></td></tr></table></figure>
<p>2.3、发送测试邮件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">echo</span> <span class="string">'test email'</span> <span class="string">|mail</span> <span class="string">-s</span> <span class="string">'title'</span> <span class="string">test@qq.com</span></span><br></pre></td></tr></table></figure>
<p>title:指定发送文件的标题，可自行定义</p>
<h2 id="3、修改备份脚本权限"><a href="#3、修改备份脚本权限" class="headerlink" title="3、修改备份脚本权限"></a>3、修改备份脚本权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /data/soft/mysql_backup.sh</span><br></pre></td></tr></table></figure>

<h2 id="4、将脚本添加到定时任务"><a href="#4、将脚本添加到定时任务" class="headerlink" title="4、将脚本添加到定时任务"></a>4、将脚本添加到定时任务</h2><p>如：每天凌晨一点备份</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; crontab -e</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * sh /data/soft/mysql_backup.sh</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/10/mysql定时备份及邮件告知备份情况/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/09/mysqldump逻辑备份及恢复/"><span>[Mysql] mysqldump逻辑备份及恢复</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/09/mysqldump逻辑备份及恢复/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-09T08:30:24.000Z">
          2018-08-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、mysql实验版本"><a href="#0、mysql实验版本" class="headerlink" title="0、mysql实验版本"></a>0、mysql实验版本</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.7</span><span class="number">.22</span><span class="string">-log</span></span><br></pre></td></tr></table></figure>
<h2 id="1、mysqldump备份操作详解："><a href="#1、mysqldump备份操作详解：" class="headerlink" title="1、mysqldump备份操作详解："></a>1、mysqldump备份操作详解：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-d --no-data No row information 只导出数据结构</span><br><span class="line">-t --no-create-info 只导出数据（不包含结构）</span><br><span class="line">1）导出所有数据库</span><br><span class="line">mysqldump -u root -p --all-databases &gt; all_db.dump</span><br><span class="line">2）导出指定数据库</span><br><span class="line">mysqldump -u root -p zabbixDB &gt; zabbix.dump</span><br><span class="line">3) 导出多个数据库</span><br><span class="line">mysqldump -u root -p --databases zabbixDB mysql &gt; zabbix_mysql.dump</span><br><span class="line">4）导出一个表</span><br><span class="line">mysqldump -u root -p zabbixDB task &gt;  zabbixDB_task.dump</span><br><span class="line">5)导出一个数据库的多个表</span><br><span class="line">mysqldump -u root -p --databases zabbixDB --tables trends users &gt; zabbix_trends_users.dump</span><br><span class="line">6)条件导出----导出db1表a1中id&#x3D;1的数据</span><br><span class="line">mysqldump -uroot -p --databases db1 --tables a1 --where&#x3D;&#39;id&#x3D;1&#39; &gt; db1_a1_id.dump</span><br><span class="line">7)将h1服务器中的db1数据库的所有数据导入到h2中的db2数据库中，db2的数据库必须存在否则会报错</span><br><span class="line">mysqldump --host&#x3D;h1 -uroot -proot --databases db1 |mysql --host&#x3D;h2 -uroot -proot db2</span><br><span class="line">8)压缩备份</span><br><span class="line">mysqldump -uroot -p --databases zabbixDB 2&gt;&#x2F;dev&#x2F;null |gzip &gt; zabbixDB.gz</span><br></pre></td></tr></table></figure>
<p>##开始实验</p>
<h2 id="2、源库插入测试数据"><a href="#2、源库插入测试数据" class="headerlink" title="2、源库插入测试数据"></a>2、源库插入测试数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create database aaaa;</span><br><span class="line">use aaaa;</span><br><span class="line">create table aa (id int primary key);</span><br><span class="line">insert into aa values(&#39;1&#39;);</span><br></pre></td></tr></table></figure>
<h2 id="3、导出备份"><a href="#3、导出备份" class="headerlink" title="3、导出备份"></a>3、导出备份</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u root -p --all-databases --<span class="built_in">set</span>-gtid-purged=OFF  &gt; /tmp/test.dump</span><br></pre></td></tr></table></figure>
<h2 id="4、在目标数据库进行还原，全库导入"><a href="#4、在目标数据库进行还原，全库导入" class="headerlink" title="4、在目标数据库进行还原，全库导入"></a>4、在目标数据库进行还原，全库导入</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p12345678 &lt; test.dump</span><br></pre></td></tr></table></figure>
<p>因为mysqldump属于逻辑备份，恢复步骤为先检查要恢复的database是否存在，如果不存在就手动创建，如果存在就进入database去检查表是否存在，如果存在，会先删除再手动创建,表创建完成之后插入数据,分析dump文件，具体内容如下：</p>
<p>4.1、创建database：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">--</span> <span class="attr">Current Database:</span> <span class="string">`aaaa`</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">CREATE</span> <span class="string">DATABASE</span> <span class="string">/*!32312</span> <span class="string">IF</span> <span class="string">NOT</span> <span class="string">EXISTS*/</span> <span class="string">`aaaa`</span> <span class="string">/*!40100</span> <span class="string">DEFAULT</span> <span class="string">CHARACTER</span> <span class="string">SET</span> <span class="string">utf8mb4</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">USE</span> <span class="string">`aaaa`;</span></span><br></pre></td></tr></table></figure>
<p>4.2、检查并创建表aaa:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">--</span> <span class="string">Table</span> <span class="string">structure</span> <span class="string">for</span> <span class="string">table</span> <span class="string">`aaa`</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">DROP</span> <span class="string">TABLE</span> <span class="string">IF</span> <span class="string">EXISTS</span> <span class="string">`aaa`;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">@saved_cs_client</span>     <span class="string">=</span> <span class="string">@@character_set_client</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">character_set_client</span> <span class="string">=</span> <span class="string">utf8</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">CREATE</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">(</span></span><br><span class="line">  <span class="string">`id`</span> <span class="string">int(11)</span> <span class="string">NOT</span> <span class="literal">NULL</span><span class="string">,</span></span><br><span class="line">  <span class="string">PRIMARY</span> <span class="string">KEY</span> <span class="string">(`id`)</span></span><br><span class="line"><span class="string">)</span> <span class="string">ENGINE=InnoDB</span> <span class="string">DEFAULT</span> <span class="string">CHARSET=utf8mb4;</span></span><br><span class="line"><span class="string">/*!40101</span> <span class="string">SET</span> <span class="string">character_set_client</span> <span class="string">=</span> <span class="string">@saved_cs_client</span> <span class="string">*/;</span></span><br></pre></td></tr></table></figure>
<p>4.3、对表aaa插入备份出来的数据：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">--</span> <span class="string">Dumping</span> <span class="string">data</span> <span class="string">for</span> <span class="string">table</span> <span class="string">`aaa`</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">LOCK</span> <span class="string">TABLES</span> <span class="string">`aaa`</span> <span class="string">WRITE;</span></span><br><span class="line"><span class="string">/*!40000</span> <span class="string">ALTER</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">DISABLE</span> <span class="string">KEYS</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">INSERT</span> <span class="string">INTO</span> <span class="string">`aaa`</span> <span class="string">VALUES</span> <span class="string">(1);</span></span><br><span class="line"><span class="string">/*!40000</span> <span class="string">ALTER</span> <span class="string">TABLE</span> <span class="string">`aaa`</span> <span class="string">ENABLE</span> <span class="string">KEYS</span> <span class="string">*/;</span></span><br><span class="line"><span class="string">UNLOCK</span> <span class="string">TABLES;</span></span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/09/mysqldump逻辑备份及恢复/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/08/mongodb-sharding-cluster部署/"><span>[Mongodb] mongodb sharding集群配置</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/08/mongodb-sharding-cluster部署/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-08T09:30:24.000Z">
          2018-08-08
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、前提需求"><a href="#0、前提需求" class="headerlink" title="0、前提需求"></a>0、前提需求</h2><p>为了满足mongodb数据库高可用环境，可以使用配置副本集CSRS（config server replica set)，搭建方法点击<a href="https://zeven0707.github.io/2018/08/05/mongodb-%E9%9B%86%E7%BE%A4/" target="_blank" rel="noopener">此处</a>,但是当业务吞吐量特别高的时刻，单台节点已经不能满足访问需求，因此需要考虑sharding cluster 模式，提高访问性能。</p>
<h2 id="1、将集群架构从csrs调整为sharding-cluster-下文按照上面搭建的csrs架构继续调整："><a href="#1、将集群架构从csrs调整为sharding-cluster-下文按照上面搭建的csrs架构继续调整：" class="headerlink" title="1、将集群架构从csrs调整为sharding cluster,下文按照上面搭建的csrs架构继续调整："></a>1、将集群架构从csrs调整为sharding cluster,下文按照上面搭建的csrs架构继续调整：</h2><p>1.1、节点信息如下：<br>主：10.0.7.53<br>从：10.0.7.51<br>仲裁：10.0.7.50<br>依次关闭仲裁、从、主节点，修改配置文件mongodb.conf，添加如下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sharding:</span><br><span class="line">   clusterRole: shardsvr</span><br></pre></td></tr></table></figure>
<p>1.2、修改完三个节点之后，依次启动主，从，仲裁三个节点，进入控制台使用rs.status()，查看集群状态是否正常。为了保证停机时间较短，可使用rs.stepDown()分别进行主从切换，对从库进行配置并重启。</p>
<h2 id="2、新建一个shard1集群节点，操作如下-三个节点都要执行）："><a href="#2、新建一个shard1集群节点，操作如下-三个节点都要执行）：" class="headerlink" title="2、新建一个shard1集群节点，操作如下(三个节点都要执行）："></a>2、新建一个shard1集群节点，操作如下(三个节点都要执行）：</h2><p>2.1、节点信息如下：<br>从：10.0.7.53<br>主：10.0.7.51<br>仲裁：10.0.7.50<br>2.2、拷贝一份mongodb.conf文件，并重新命名<br>cp mongodb.conf shard1mongodb.conf<br>2.3、主节点需要在无需验证的模式下，先配置用户名密码。之后修改（三个节点）shard1mongodb.conf配置文件内容如下：<br>cat shard1mongodb.conf</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/data/mongodb/shard1/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodb/shard1/data/</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/data/mongodb/shard1/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line">  <span class="attr">timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">30001</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.53</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">   <span class="attr">authorization:</span> <span class="string">enabled</span></span><br><span class="line">   <span class="attr">keyFile:</span> <span class="string">/data/mongodb/shard1/mongodb.keyfile</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">   <span class="attr">replSetName:</span> <span class="string">"shard1"</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">   <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure>
<p>注意修改sharding、port、path、replname等参数</p>
<p>2.4、创建相应的数据目录和日志目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/shard1/&#123;<span class="built_in">log</span>,data&#125;</span><br></pre></td></tr></table></figure>
<p>2.5、生成keyfile文件并拷贝keyfile文件到指定目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp mongodb.keyfile /data/mongodb/shard1/</span><br></pre></td></tr></table></figure>
<p>2.6、三个节点启动mongodb-shard1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod -f /data/mongodb/shard1mongodb.conf</span><br></pre></td></tr></table></figure>
<p>2.7、初始化集群配置：<br>/data/mongodb/bin/mongo –port 30001<br>–<br>rs.initiate(<br>  {<br>    _id : “shard”,<br>    members: [<br>      { _id : 0, host : “10.0.7.53:30001” },<br>      { _id : 1, host : “10.0.7.50:30001” },<br>      { _id : 2, host : “10.0.7.51:30001”,”arbiterOnly” : true }<br>    ]<br>  }<br>)<br>2.8、查看集群节点信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.status();</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span></span><br><span class="line">	<span class="string">"set"</span> <span class="string">:</span> <span class="string">"shard"</span><span class="string">,</span></span><br><span class="line">	<span class="string">"date"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.697Z"),</span></span><br><span class="line">	<span class="string">"myState"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">	<span class="string">"term"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line">	<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line">	<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line">	<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">	<span class="string">"heartbeatIntervalMillis"</span> <span class="string">:</span> <span class="string">NumberLong(2000),</span></span><br><span class="line">	<span class="string">"optimes"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">		<span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">"readConcernMajorityOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">"appliedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">"durableOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;</span></span><br><span class="line">	<span class="string">&#125;,</span></span><br><span class="line">	<span class="string">"lastStableCheckpointTimestamp"</span> <span class="string">:</span> <span class="string">Timestamp(1533784355,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">	<span class="string">"members"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line">		<span class="string">&#123;</span></span><br><span class="line">			<span class="string">"_id"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">			<span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.53:30001"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">			<span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"uptime"</span> <span class="string">:</span> <span class="number">47039</span><span class="string">,</span></span><br><span class="line">			<span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line">			<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"self"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">			<span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">&#123;</span></span><br><span class="line">			<span class="string">"_id"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30001"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"state"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"PRIMARY"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"uptime"</span> <span class="string">:</span> <span class="number">46862</span><span class="string">,</span></span><br><span class="line">			<span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line">			<span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:25Z"),</span></span><br><span class="line">			<span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:33.395Z"),</span></span><br><span class="line">			<span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:32.735Z"),</span></span><br><span class="line">			<span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line">			<span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">-1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"electionTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533737562,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">			<span class="string">"electionDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-08T14:12:42Z"),</span></span><br><span class="line">			<span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">&#123;</span></span><br><span class="line">			<span class="string">"_id"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">			<span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30001"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"state"</span> <span class="string">:</span> <span class="number">7</span><span class="string">,</span></span><br><span class="line">			<span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"ARBITER"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"uptime"</span> <span class="string">:</span> <span class="number">46862</span><span class="string">,</span></span><br><span class="line">			<span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.660Z"),</span></span><br><span class="line">			<span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-09T03:13:34.658Z"),</span></span><br><span class="line">			<span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(0),</span></span><br><span class="line">			<span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">-1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">		<span class="string">&#125;</span></span><br><span class="line">	<span class="string">],</span></span><br><span class="line">	<span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">	<span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">	<span class="string">"$gleStats"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">		<span class="string">"lastOpTime"</span> <span class="string">:</span> <span class="string">Timestamp(0,</span> <span class="number">0</span><span class="string">),</span></span><br><span class="line">		<span class="string">"electionId"</span> <span class="string">:</span> <span class="string">ObjectId("000000000000000000000000")</span></span><br><span class="line">	<span class="string">&#125;,</span></span><br><span class="line">	<span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784405,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">	<span class="string">"$configServerState"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">		<span class="string">"opTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533784394,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;</span></span><br><span class="line">	<span class="string">&#125;,</span></span><br><span class="line">	<span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">		<span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533784408,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">		<span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"dToZVSHbihPkQILJVl0qcSY+8ys="),</span></span><br><span class="line">			<span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong("6587344633552961565")</span></span><br><span class="line">		<span class="string">&#125;</span></span><br><span class="line">	<span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="3、新建一个config-server集群节点，操作如下-三个节点都要执行）："><a href="#3、新建一个config-server集群节点，操作如下-三个节点都要执行）：" class="headerlink" title="3、新建一个config-server集群节点，操作如下(三个节点都要执行）："></a>3、新建一个config-server集群节点，操作如下(三个节点都要执行）：</h2><p>3.1、节点信息如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">从：10.0.7.53</span></span><br><span class="line"><span class="string">从：10.0.7.51</span></span><br><span class="line"><span class="string">主：10.0.7.50</span></span><br></pre></td></tr></table></figure>
<p>3.2、拷贝一份mongodb.conf文件，并重新命名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp shard1mongodb.conf configmongodb.conf</span><br></pre></td></tr></table></figure>
<p>3.3、主节点需要在无需验证的模式下，先配置用户名密码。之后修改（三个节点）configmongodb.conf配置文件内容如下：<br>cat configmongodb.conf</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongod.conf</span></span><br><span class="line"><span class="comment"># for documentation of all options, see:</span></span><br><span class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></span><br><span class="line"><span class="comment"># where to write logging data.</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/data/mongodb/config/log/mongod.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where and how to store data.</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/data/mongodb/config/data/</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#  engine:</span></span><br><span class="line"><span class="comment">#  mmapv1:</span></span><br><span class="line"><span class="comment">#  wiredTiger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># how the process runs</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/data/mongodb/config/log/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line">  <span class="attr">timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network interfaces</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">30002</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,10.0.7.53</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#security:</span></span><br><span class="line"><span class="comment">#   authorization: enabled</span></span><br><span class="line"><span class="comment">#   keyFile: /data/mongodb/config/mongodb.keyfile</span></span><br><span class="line"><span class="comment">#operationProfiling:</span></span><br><span class="line"><span class="comment">#replication:</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">   <span class="attr">replSetName:</span> <span class="string">"config"</span></span><br><span class="line"><span class="comment">#sharding:</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">   <span class="attr">clusterRole:</span> <span class="string">configsvr</span></span><br><span class="line"><span class="comment">## Enterprise-Only Options</span></span><br><span class="line"><span class="comment">#auditLog:</span></span><br><span class="line"><span class="comment">#snmp:</span></span><br></pre></td></tr></table></figure>
<p>注意修改sharding、repl、port、path<br>3.4、创建相应的数据目录和日志目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/config/&#123;<span class="built_in">log</span>,data&#125;</span><br></pre></td></tr></table></figure>
<p>3.5、三个节点启动mongodb-shard1:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod --configsvr -f /data/mongodb/configmongodb.conf</span><br></pre></td></tr></table></figure>
<p>启动config-server服务需要指定参数，否则初始化集群的时候会报错：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"errmsg"</span> <span class="string">:</span> <span class="string">"Nodes being used for config servers must be started with the --configsvr flag"</span></span><br></pre></td></tr></table></figure>
<p>3.6、初始化集群配置：<br>/data/mongodb/bin/mongo –port 30002<br>–<br>rs.initiate(<br>  {<br>    _id : “config”,<br>    configsvr: true,<br>    members: [<br>      { _id : 0, host : “10.0.7.53:30002” },<br>      { _id : 1, host : “10.0.7.50:30002” },<br>      { _id : 2, host : “10.0.7.51:30002” }<br>    ]<br>  }<br>)<br>3.7、查看集群信息：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rs.status();</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">	<span class="string">"set"</span> <span class="string">:</span> <span class="string">"config"</span><span class="string">,</span></span><br><span class="line">	<span class="string">"date"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.472Z"),</span></span><br><span class="line">	<span class="string">"myState"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">	<span class="string">"term"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line">	<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">	<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">	<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">-1</span><span class="string">,</span></span><br><span class="line">	<span class="string">"heartbeatIntervalMillis"</span> <span class="string">:</span> <span class="string">NumberLong(2000),</span></span><br><span class="line">	<span class="string">"optimes"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">		<span class="string">"lastCommittedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">"readConcernMajorityOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">"appliedOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">"durableOpTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">			<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">		<span class="string">&#125;</span></span><br><span class="line">	<span class="string">&#125;,</span></span><br><span class="line">	<span class="string">"lastStableCheckpointTimestamp"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">	<span class="string">"members"</span> <span class="string">:</span> <span class="string">[</span></span><br><span class="line">		<span class="string">&#123;</span></span><br><span class="line">			<span class="string">"_id"</span> <span class="string">:</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">			<span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.53:30002"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">			<span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"uptime"</span> <span class="string">:</span> <span class="number">15</span><span class="string">,</span></span><br><span class="line">			<span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line">			<span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line">			<span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.161Z"),</span></span><br><span class="line">			<span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:12.674Z"),</span></span><br><span class="line">			<span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(0),</span></span><br><span class="line">			<span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">			<span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">&#123;</span></span><br><span class="line">			<span class="string">"_id"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.50:30002"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"state"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">			<span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"SECONDARY"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"uptime"</span> <span class="string">:</span> <span class="number">15</span><span class="string">,</span></span><br><span class="line">			<span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDurable"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line">			<span class="string">"optimeDurableDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line">			<span class="string">"lastHeartbeat"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:14.164Z"),</span></span><br><span class="line">			<span class="string">"lastHeartbeatRecv"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:12.680Z"),</span></span><br><span class="line">			<span class="string">"pingMs"</span> <span class="string">:</span> <span class="string">NumberLong(1),</span></span><br><span class="line">			<span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">			<span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span></span><br><span class="line">		<span class="string">&#125;,</span></span><br><span class="line">		<span class="string">&#123;</span></span><br><span class="line">			<span class="string">"_id"</span> <span class="string">:</span> <span class="number">2</span><span class="string">,</span></span><br><span class="line">			<span class="string">"name"</span> <span class="string">:</span> <span class="string">"10.0.7.51:30002"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"health"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"state"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"stateStr"</span> <span class="string">:</span> <span class="string">"PRIMARY"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"uptime"</span> <span class="string">:</span> <span class="number">59</span><span class="string">,</span></span><br><span class="line">			<span class="string">"optime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">				<span class="string">"ts"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">				<span class="string">"t"</span> <span class="string">:</span> <span class="string">NumberLong(1)</span></span><br><span class="line">			<span class="string">&#125;,</span></span><br><span class="line">			<span class="string">"optimeDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:11Z"),</span></span><br><span class="line">			<span class="string">"syncingTo"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceHost"</span> <span class="string">:</span> <span class="string">""</span><span class="string">,</span></span><br><span class="line">			<span class="string">"syncSourceId"</span> <span class="string">:</span> <span class="number">-1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"infoMessage"</span> <span class="string">:</span> <span class="string">"could not find member to sync from"</span><span class="string">,</span></span><br><span class="line">			<span class="string">"electionTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544150,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">			<span class="string">"electionDate"</span> <span class="string">:</span> <span class="string">ISODate("2018-08-06T08:29:10Z"),</span></span><br><span class="line">			<span class="string">"configVersion"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">			<span class="string">"self"</span> <span class="string">:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">			<span class="string">"lastHeartbeatMessage"</span> <span class="string">:</span> <span class="string">""</span></span><br><span class="line">		<span class="string">&#125;</span></span><br><span class="line">	<span class="string">],</span></span><br><span class="line">	<span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">	<span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">	<span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">		<span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533544151,</span> <span class="number">2</span><span class="string">),</span></span><br><span class="line">		<span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</span></span><br><span class="line">			<span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong(0)</span></span><br><span class="line">		<span class="string">&#125;</span></span><br><span class="line">	<span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="4、配置mongs-mongodb-router-用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点"><a href="#4、配置mongs-mongodb-router-用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点" class="headerlink" title="4、配置mongs(mongodb-router),用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点"></a>4、配置mongs(mongodb-router),用于客户端连接到mongodb集群，为防止单点故障，可配置多个mongos节点</h2><p>4.1、拷贝一份配置文件，并重命名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp configmongodb.conf routermongodb.conf</span><br></pre></td></tr></table></figure>
<p>4.2、修改配置文件参数，内容如下：<br>cat routermongodb.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># mongod.conf</span><br><span class="line"></span><br><span class="line"># for documentation of all options, see:</span><br><span class="line">#   http:&#x2F;&#x2F;docs.mongodb.org&#x2F;manual&#x2F;reference&#x2F;routeruration-options&#x2F;</span><br><span class="line"></span><br><span class="line"># where to write logging data.</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: &#x2F;data&#x2F;mongodb&#x2F;router&#x2F;log&#x2F;mongod.log</span><br><span class="line"></span><br><span class="line"># Where and how to store data.</span><br><span class="line">#storage:</span><br><span class="line">#  dbPath: &#x2F;data&#x2F;mongodb&#x2F;router&#x2F;data&#x2F;</span><br><span class="line">#  journal:</span><br><span class="line">#    enabled: true</span><br><span class="line">#  engine:</span><br><span class="line">#  mmapv1:</span><br><span class="line">#  wiredTiger:</span><br><span class="line"></span><br><span class="line"># how the process runs</span><br><span class="line">processManagement:</span><br><span class="line">  fork: true  # fork and run in background</span><br><span class="line">  pidFilePath: &#x2F;data&#x2F;mongodb&#x2F;router&#x2F;log&#x2F;mongod.pid  # location of pidfile</span><br><span class="line">  timeZoneInfo: &#x2F;usr&#x2F;share&#x2F;zoneinfo</span><br><span class="line"></span><br><span class="line"># network interfaces</span><br><span class="line">net:</span><br><span class="line">  port: 30004</span><br><span class="line">  bindIp: 127.0.0.1,10.0.7.53  # Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><span class="line"></span><br><span class="line">#security:</span><br><span class="line">#security:</span><br><span class="line">#   authorization: enabled</span><br><span class="line">#operationProfiling:</span><br><span class="line"></span><br><span class="line">#replication:</span><br><span class="line">#sharding:</span><br><span class="line">sharding:</span><br><span class="line">   configDB: config&#x2F;10.0.7.53:30002,10.0.7.51:30002,10.0.7.50:30002</span><br><span class="line"></span><br><span class="line">## Enterprise-Only Options</span><br><span class="line"></span><br><span class="line">#auditLog:</span><br><span class="line"></span><br><span class="line">#snmp:</span><br></pre></td></tr></table></figure>
<p>注意修改sharding,port参数，注释掉storage参数<br>4.3、创建router日志目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/mongodb/router/<span class="built_in">log</span></span><br></pre></td></tr></table></figure>
<p>4.4、启动mongos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongos -f /data/mongodb/routermongodb.conf</span><br></pre></td></tr></table></figure>

<p>4.5、为模拟生产环境数据，对testrepl集群节点，插入部分数据,批量插入脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use test</span><br><span class="line">var bulk &#x3D; db.test_collection.initializeUnorderedBulkOp();</span><br><span class="line">people &#x3D; [&quot;Marc&quot;, &quot;Bill&quot;, &quot;George&quot;, &quot;Eliot&quot;, &quot;Matt&quot;, &quot;Trey&quot;, &quot;Tracy&quot;, &quot;Greg&quot;, &quot;Steve&quot;, &quot;Kristina&quot;, &quot;Katie&quot;, &quot;Jeff&quot;];</span><br><span class="line">for(var i&#x3D;0; i&lt;1000000; i++)&#123;</span><br><span class="line">   user_id &#x3D; i;</span><br><span class="line">   name &#x3D; people[Math.floor(Math.random()*people.length)];</span><br><span class="line">   number &#x3D; Math.floor(Math.random()*10001);</span><br><span class="line">   bulk.insert( &#123; &quot;user_id&quot;:user_id, &quot;name&quot;:name, &quot;number&quot;:number &#125;);</span><br><span class="line">&#125;</span><br><span class="line">bulk.execute();</span><br></pre></td></tr></table></figure>

<p>4.6、连接到mongos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mongo --host 10.0.7.50 --port 30004</span><br><span class="line">mongos&gt; use admin</span><br><span class="line">mongos&gt; db.auth(<span class="string">'admin1'</span>,<span class="string">'admin123'</span>);</span><br></pre></td></tr></table></figure>

<p>4.7、将节点添加到集群内：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.addShard(&quot;testrepl&#x2F;10.0.7.53:30000&quot;)</span><br><span class="line">mongos&gt; sh.addShard(&quot;shard1&#x2F;10.0.7.53:30001&quot;)</span><br></pre></td></tr></table></figure>


<p>4.8、使数据库test支持sharding</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongos&gt; sh.enableSharding(&quot;test&quot;)</span><br><span class="line">mongos&gt; use test</span><br><span class="line">#在拆分键上创建索引</span><br><span class="line">mongos&gt; db.test_collection.createIndex( &#123; number : 1 &#125; )</span><br><span class="line">#拆分集合</span><br><span class="line">mongos&gt; sh.shardCollection(&#39;test.mycol2&#39;, &#123;&#39;_id&#39;: 1&#125;)</span><br></pre></td></tr></table></figure>
<p>4.9、查看拆分结果,(可多次重复4.5步骤进行测试）<br>sh.status()或者db.printShardingStatus() </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">--- Sharding Status --- </span><br><span class="line">  sharding version: &#123;</span><br><span class="line">  	<span class="string">"_id"</span> : 1,</span><br><span class="line">  	<span class="string">"minCompatibleVersion"</span> : 5,</span><br><span class="line">  	<span class="string">"currentVersion"</span> : 6,</span><br><span class="line">  	<span class="string">"clusterId"</span> : ObjectId(<span class="string">"5b6af30b5025146bfd45717b"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"shard"</span>,  <span class="string">"host"</span> : <span class="string">"shard/10.0.7.50:30001,10.0.7.53:30001"</span>,  <span class="string">"state"</span> : 1 &#125;</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"testrepl"</span>,  <span class="string">"host"</span> : <span class="string">"testrepl/10.0.7.50:30000,10.0.7.53:30000"</span>,  <span class="string">"state"</span> : 1 &#125;</span><br><span class="line">  active mongoses:</span><br><span class="line">        <span class="string">"4.0.0"</span> : 1</span><br><span class="line">  autosplit:</span><br><span class="line">        Currently enabled: yes</span><br><span class="line">  balancer:</span><br><span class="line">        Currently enabled:  yes</span><br><span class="line">        Currently running:  no</span><br><span class="line">        Failed balancer rounds <span class="keyword">in</span> last 5 attempts:  0</span><br><span class="line">        Migration Results <span class="keyword">for</span> the last 24 hours: </span><br><span class="line">                4 : Success</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"config"</span>,  <span class="string">"primary"</span> : <span class="string">"config"</span>,  <span class="string">"partitioned"</span> : <span class="literal">true</span> &#125;</span><br><span class="line">                config.system.sessions</span><br><span class="line">                        shard key: &#123; <span class="string">"_id"</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shard	1</span><br><span class="line">                        &#123; <span class="string">"_id"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">"_id"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : 1 &#125; &#125; on : shard Timestamp(1, 0) </span><br><span class="line">        &#123;  <span class="string">"_id"</span> : <span class="string">"test"</span>,  <span class="string">"primary"</span> : <span class="string">"testrepl"</span>,  <span class="string">"partitioned"</span> : <span class="literal">true</span>,  <span class="string">"version"</span> : &#123;  <span class="string">"uuid"</span> : UUID(<span class="string">"185a3842-639f-42b0-89a1-afdc8dcdfbe7"</span>),  <span class="string">"lastMod"</span> : 1 &#125; &#125;</span><br><span class="line">                test.test_collection</span><br><span class="line">                        shard key: &#123; <span class="string">"number"</span> : 1 &#125;</span><br><span class="line">                        unique: <span class="literal">false</span></span><br><span class="line">                        balancing: <span class="literal">true</span></span><br><span class="line">                        chunks:</span><br><span class="line">                                shard	4</span><br><span class="line">                                testrepl	4</span><br><span class="line">                        &#123; <span class="string">"number"</span> : &#123; <span class="string">"<span class="variable">$minKey</span>"</span> : 1 &#125; &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 2394 &#125; on : shard Timestamp(2, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 2394 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 4791 &#125; on : shard Timestamp(3, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 4791 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 7194 &#125; on : shard Timestamp(4, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 7194 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 7892 &#125; on : shard Timestamp(5, 0) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 7892 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 8591 &#125; on : testrepl Timestamp(5, 1) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 8591 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 9287 &#125; on : testrepl Timestamp(3, 4) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 9287 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : 9589 &#125; on : testrepl Timestamp(3, 5) </span><br><span class="line">                        &#123; <span class="string">"number"</span> : 9589 &#125; --&gt;&gt; &#123; <span class="string">"number"</span> : &#123; <span class="string">"<span class="variable">$maxKey</span>"</span> : 1 &#125; &#125; on : testrepl Timestamp(4, 1)</span><br></pre></td></tr></table></figure>
<h2 id="5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可"><a href="#5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可" class="headerlink" title="5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可"></a>5、大功告成，客户端访问mongodb集群，只需连接mongos对应的ip、port即可</h2>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/08/mongodb-sharding-cluster部署/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/07/5.7.22-log版本mysql,mha主从环境，从库报错信息/"><span>[Mysql] mysql-mha主从环境，从库报错Error_code: 1062</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/07/5.7.22-log版本mysql,mha主从环境，从库报错信息/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-07T13:15:24.000Z">
          2018-08-07
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="0、数据库版本信息："><a href="#0、数据库版本信息：" class="headerlink" title="0、数据库版本信息："></a>0、数据库版本信息：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.7</span><span class="number">.22</span></span><br></pre></td></tr></table></figure>
<h2 id="1、从库报错信息"><a href="#1、从库报错信息" class="headerlink" title="1、从库报错信息"></a>1、从库报错信息</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Last_SQL_Error:</span> <span class="string">Could</span> <span class="string">not</span> <span class="string">execute</span> <span class="string">Write_rows</span> <span class="string">event</span> <span class="string">on</span> <span class="string">table</span> <span class="string">test.tb1;</span></span><br><span class="line"><span class="string">Duplicate</span> <span class="string">entry</span> <span class="string">'4'</span> <span class="string">for</span> <span class="string">key</span> <span class="string">'PRIMARY'</span><span class="string">,</span></span><br><span class="line"><span class="attr">Error_code:</span> <span class="number">1062</span><span class="string">;</span></span><br><span class="line"><span class="string">handler</span> <span class="string">error</span> <span class="string">HA_ERR_FOUND_DUPP_KEY;</span> <span class="string">the</span> <span class="string">event's</span> <span class="string">master</span> <span class="string">log</span> <span class="string">mysql-binlog.000005,</span> <span class="string">end_log_pos</span> <span class="number">273273632</span></span><br></pre></td></tr></table></figure>
<h2 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h2><p>2.1、在主库上查询二进制文件信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mysql/bin/mysqlbinlog  -v --stop-position=273273632 /data/mysql/<span class="built_in">log</span>/mysql-binlog.000005 &gt; /tmp/f.log</span><br></pre></td></tr></table></figure>
<p>2.2、过滤出报错的pos所对应的行数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/f.log | awk <span class="string">'/end_log_pos 273273632/ &#123;print NR&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">22556452</span><br></pre></td></tr></table></figure>
<p>2.3、根据查询到的行数，查看其上下文：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/f.log | awk <span class="string">'NR==22556442,NR==22556492'</span></span><br></pre></td></tr></table></figure>
<p>2.4、查询到insert的插入语句</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### INSERT INTO `test`.`tb1`</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=4</span></span><br><span class="line"><span class="comment">###   @2='ERC20'</span></span><br><span class="line"><span class="comment">###   @3='GTO'</span></span><br><span class="line"><span class="comment">###   @4=1533176390</span></span><br><span class="line"><span class="string">ROLLBACK</span> <span class="string">/*</span> <span class="string">added</span> <span class="string">by</span> <span class="string">mysqlbinlog</span> <span class="string">*/</span> <span class="string">/*!*/;</span></span><br></pre></td></tr></table></figure>

<p>2.5、在从库上执行下面操作，停止主从同步</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">stop</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure>
<p>2.6、删除报错提示的对应的行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb1 <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">4</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tb1;</span><br></pre></td></tr></table></figure>
<p>2.7、重新启动主从同步，查看节点信息正常：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G;</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/07/5.7.22-log版本mysql,mha主从环境，从库报错信息/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/08/05/mongodb-集群/"><span>[Mongodb] mongodb集群配置一主一从一仲裁</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/08/05/mongodb-集群/" rel="bookmark">
        <time class="entry-date published" datetime="2018-08-05T06:30:24.000Z">
          2018-08-05
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h2 id="1、首先安装在三个节点安装mongodb-安装方法详见"><a href="#1、首先安装在三个节点安装mongodb-安装方法详见" class="headerlink" title="1、首先安装在三个节点安装mongodb,安装方法详见"></a>1、首先安装在三个节点安装mongodb,安装方法详见</h2><p>   <a href="https://zeven0707.github.io/2018/08/03/mongdob4.0/" target="_blank" rel="noopener">mongodb单点安装</a></p>
<h2 id="2、集群节点信息："><a href="#2、集群节点信息：" class="headerlink" title="2、集群节点信息："></a>2、集群节点信息：</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">主：10.0.7.53</span></span><br><span class="line"><span class="string">从：10.0.7.51</span></span><br><span class="line"><span class="string">仲裁：10.0.7.50</span></span><br></pre></td></tr></table></figure>
<h2 id="3、启动主节点，进入主节点控制台，"><a href="#3、启动主节点，进入主节点控制台，" class="headerlink" title="3、启动主节点，进入主节点控制台，"></a>3、启动主节点，进入主节点控制台，</h2><p>3.1、创建管理员用户名、密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; /data/mongodb/bin/mongo --port 30000</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt;use admin</span><br><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt;</span><br><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: <span class="string">"admin"</span>,</span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"abc123"</span>,</span><br><span class="line">    roles: [ &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>使用userAdminAnyDatabase的role权限去查看rs.status();会提示<br>“not authorized on admin to execute command”,建议授予root权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: <span class="string">"admin1"</span>,</span><br><span class="line">    <span class="built_in">pwd</span>: <span class="string">"admin123"</span>,</span><br><span class="line">    roles: [ &#123; role: <span class="string">"root"</span>, db: <span class="string">"admin"</span> &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>3.2、查看创建的管理员信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; db.system.users.find()</span><br></pre></td></tr></table></figure>
<p>3.3、退出控制台，修改配置文件mongodb.conf(每个节点都要配置)：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">   <span class="attr">authorization:</span> <span class="string">enabled</span></span><br></pre></td></tr></table></figure>

<h2 id="4、在主节点上，生成秘钥文件"><a href="#4、在主节点上，生成秘钥文件" class="headerlink" title="4、在主节点上，生成秘钥文件"></a>4、在主节点上，生成秘钥文件</h2><p>4.1、生成密钥文件，用于集群之间互相通信：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 756 &gt; /data/mongodb/mongodb.keyfile</span><br></pre></td></tr></table></figure>
<p>4.2、更改文件权限以仅为文件所有者提供读取权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 400 /data/mongodb/mongodb.keyfile</span><br></pre></td></tr></table></figure>
<p>4.3、将密钥文件复制到每个副本集成员</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /data/mongodb/mongodb.keyfile root@10.0.7.51:/data/mongodb/</span><br><span class="line">scp /data/mongodb/mongodb.keyfile root@10.0.7.50:/data/mongodb/</span><br></pre></td></tr></table></figure>
<p>4.4、修改配置文件mongodb.conf，添加keyfile参数(每个节点都要配置)：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">   <span class="attr">keyFile:</span> <span class="string">/data/mongodb/mongodb.keyfile</span></span><br></pre></td></tr></table></figure>

<h2 id="5、配置集群"><a href="#5、配置集群" class="headerlink" title="5、配置集群"></a>5、配置集群</h2><p>5.1、修改配置文件mongodb.conf，添加集群配置参数(每个节点都要配置)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replication:</span><br><span class="line">   replSetName: <span class="string">"testrepl"</span></span><br></pre></td></tr></table></figure>
<p>replSetName:设置集群名称，根据自己需求自定义（三个节点要保持一直）</p>
<p>5.2、重新启动mongodb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongod -f /data/mongodb/mongodb.conf</span><br></pre></td></tr></table></figure>
<p>5.3、进入主节点控制台</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/mongodb/bin/mongo --port 30000</span><br></pre></td></tr></table></figure>
<p>5.4、添加集群节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use admin;</span><br><span class="line">db.auth(<span class="string">'admin'</span>,<span class="string">'abc123'</span>);</span><br><span class="line"></span><br><span class="line">rs.initiate( &#123;</span><br><span class="line">   _id : <span class="string">"testrepl"</span>,</span><br><span class="line">   members: [</span><br><span class="line">      &#123; _id: 0, host: <span class="string">"10.0.7.53:30000"</span> &#125;,</span><br><span class="line">      &#123; _id: 1, host: <span class="string">"10.0.7.50:30000"</span> &#125;,</span><br><span class="line">      &#123; _id: 2, host: <span class="string">"10.0.7.51:30000"</span>,<span class="string">"arbiterOnly"</span> : <span class="literal">true</span>&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;</span></span><br><span class="line">        <span class="string">"ok"</span> <span class="string">:</span> <span class="number">1</span><span class="string">,</span></span><br><span class="line">        <span class="string">"operationTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533388128,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">        <span class="string">"$clusterTime"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">"clusterTime"</span> <span class="string">:</span> <span class="string">Timestamp(1533388128,</span> <span class="number">1</span><span class="string">),</span></span><br><span class="line">                <span class="string">"signature"</span> <span class="string">:</span> <span class="string">&#123;</span></span><br><span class="line">                        <span class="string">"hash"</span> <span class="string">:</span> <span class="string">BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),</span></span><br><span class="line">                        <span class="string">"keyId"</span> <span class="string">:</span> <span class="string">NumberLong(0)</span></span><br><span class="line">                <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>5.5、查看集群状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">MongoDB Enterprise testrepl:PRIMARY&gt; rs.status();</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"set"</span> : <span class="string">"testrepl"</span>,</span><br><span class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.894Z"</span>),</span><br><span class="line">        <span class="string">"myState"</span> : 1,</span><br><span class="line">        <span class="string">"term"</span> : NumberLong(1),</span><br><span class="line">        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(2000),</span><br><span class="line">        <span class="string">"optimes"</span> : &#123;</span><br><span class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"readConcernMajorityOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"appliedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"durableOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"lastStableCheckpointTimestamp"</span> : Timestamp(1533388140, 1),</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 1,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 289,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">"could not find member to sync from"</span>,</span><br><span class="line">                        <span class="string">"electionTime"</span> : Timestamp(1533388139, 1),</span><br><span class="line">                        <span class="string">"electionDate"</span> : ISODate(<span class="string">"2018-08-04T13:08:59Z"</span>),</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1,</span><br><span class="line">                        <span class="string">"self"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.50:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 2,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 37,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(1)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2018-08-04T13:09:20Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.051Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.677Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(3),</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">"10.0.7.53:30000"</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : 0,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"10.0.7.51:30000"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : 1,</span><br><span class="line">                        <span class="string">"state"</span> : 7,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"ARBITER"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : 37,</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2018-08-04T13:09:25.031Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2018-08-04T13:09:24.265Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(0),</span><br><span class="line">                        <span class="string">"lastHeartbeatMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceHost"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"syncSourceId"</span> : -1,</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"ok"</span> : 1,</span><br><span class="line">        <span class="string">"operationTime"</span> : Timestamp(1533388160, 1),</span><br><span class="line">        <span class="string">"<span class="variable">$clusterTime</span>"</span> : &#123;</span><br><span class="line">                <span class="string">"clusterTime"</span> : Timestamp(1533388160, 1),</span><br><span class="line">                <span class="string">"signature"</span> : &#123;</span><br><span class="line">                        <span class="string">"hash"</span> : BinData(0,<span class="string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span>),</span><br><span class="line">                        <span class="string">"keyId"</span> : NumberLong(0)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.6、从库默认为不能读写模式，如果要启动从库的读模式，进入从库执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk();</span><br></pre></td></tr></table></figure>

<p>5.7、增加一个仲裁节点，新增节点，配置文件中密钥文件、repl参数一定要保持一致：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(<span class="string">"m1.example.net:27017"</span>)</span><br></pre></td></tr></table></figure>
<p>5.8、添加一个新的从节点，添加之前设置该节点优先级为0，表决为0，以防止该节点数据未同步完成之前参与选举，待该节点数据同步完成之后，使用rs.reconfig()参数再修改其优先级和表决：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add( &#123; host: <span class="string">"mongodb3.example.net:27017"</span>, priority: 0, votes: 0 &#125; )</span><br></pre></td></tr></table></figure>
<p>rs.reconfig()命令执行如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var cfg = rs.conf();</span><br><span class="line">cfg.members[4].priority = 1</span><br><span class="line">cfg.members[4].votes = 1</span><br><span class="line">rs.reconfig(cfg)</span><br></pre></td></tr></table></figure>









      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mongodb/">mongodb</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/08/05/mongodb-集群/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/page/15/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/17/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2020 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>