<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>第 10 页 | zeven&#39;s blog</title>

  
  <meta name="author" content="zeven0707&#39;s blog">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="zeven&#39;s blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/favicon.ico" rel="icon">

  <link rel="alternate" href="/atom.xml" title="zeven&#39;s blog" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">


</head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">zeven0707&#39;s blog</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/">主页</a></li>
            
              <li><a href="/archives">日志</a></li>
            
              <li><a href="/about">关于</a></li>
            
              <li><a href="/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
        <div class="container ">
          <div class="row">
            <main class="site-main posts-loop    col-lg-8 col-lg-offset-1
                    col-md-8 col-md-offset-1
                    col-sm-12
                    col-xs-12">
            
  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/25/GlusterFS/"><span>[Linux] GlusterFS部署详解</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/25/GlusterFS/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-25T12:59:30.000Z">
          2018-11-25
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、安装之前须知："><a href="#0、安装之前须知：" class="headerlink" title="0、安装之前须知："></a>0、安装之前须知：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">推荐使用xfs，没用xfs推荐使用ext4，其他文件系统也可兼容；</span><br><span class="line">生产环境DNS NTP服务必须安装,DNS服务配置可点击[此处](https:&#x2F;&#x2F;zeven0707.github.io&#x2F;2018&#x2F;11&#x2F;22&#x2F;DNS%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2&#x2F;)；</span><br><span class="line">如果是虚拟机环境最少1G内存；</span><br><span class="line">最好配置2个网卡，一个管理接口，一个数据传输接口；</span><br><span class="line">如果使用vm克隆额外的机器，确保glusterfs没有安装，如果安装了Gluster,会在每个系统上生产一个uuid，因此如果克隆了一个已经安装了gluster的系统，后面会报错；</span><br><span class="line">如果使用物理服务器，建议最低配置（2 CPU’s, 2GB of RAM, 1GBE），板载组件不如附加组件强大；</span><br><span class="line">安装官方文档，点击[此处](https:&#x2F;&#x2F;docs.gluster.org&#x2F;en&#x2F;latest&#x2F;Install-Guide&#x2F;Install&#x2F;)</span><br><span class="line">centos7快速安装指南，点击[此处](https:&#x2F;&#x2F;wiki.centos.org&#x2F;SpecialInterestGroup&#x2F;Storage&#x2F;gluster-Quickstart)</span><br><span class="line">&#x2F;var&#x2F;log目录最好单独挂在，一旦日志目录无法写入信息，gluster fs会出现古怪现象</span><br></pre></td></tr></table></figure>

<h4 id="1、配置yum源"><a href="#1、配置yum源" class="headerlink" title="1、配置yum源"></a>1、配置yum源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install centos-release-gluster</span><br></pre></td></tr></table></figure>
<h4 id="2、在两个节点上添加磁盘，格式化-并挂在目录"><a href="#2、在两个节点上添加磁盘，格式化-并挂在目录" class="headerlink" title="2、在两个节点上添加磁盘，格式化,并挂在目录"></a>2、在两个节点上添加磁盘，格式化,并挂在目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#格式化磁盘，创建相应的挂在目录</span><br><span class="line">mkfs.xfs -i size&#x3D;512 &#x2F;dev&#x2F;sdb1</span><br><span class="line">mkdir -p &#x2F;gfs&#x2F;test1</span><br><span class="line">#将挂在配置信息写入fstab配置文件，以便重启自动挂载</span><br><span class="line">vi &#x2F;etc&#x2F;fstab</span><br><span class="line">&#x2F;dev&#x2F;sdb1 &#x2F;gfs&#x2F;test1 xfs defaults 1 2</span><br><span class="line">#加载修改的配置信息</span><br><span class="line">mount -a &amp;&amp; mount</span><br></pre></td></tr></table></figure>
<p>Note: 在CentOS 6操作系统,需要安装xfs文件系统：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install xfsprogs</span><br></pre></td></tr></table></figure>

<h4 id="3、安装、配置glusterd服务"><a href="#3、安装、配置glusterd服务" class="headerlink" title="3、安装、配置glusterd服务"></a>3、安装、配置glusterd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install glusterfs-server</span><br></pre></td></tr></table></figure>
<p>启动GlusterFS 管理进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#加入开机启动</span><br><span class="line">systemctl enable glusterd</span><br><span class="line">ln -s &#39;&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;glusterd.service&#39; &#39;&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;glusterd.service&#39;</span><br><span class="line">#启动glusterd</span><br><span class="line">systemctl start glusterd</span><br><span class="line">#查看glusterd状态信息</span><br><span class="line">systemctl status glusterd</span><br><span class="line">● glusterd.service - GlusterFS, a clustered file-system server</span><br><span class="line">   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;glusterd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-11-15 12:08:54 EST; 15s ago</span><br><span class="line">  Process: 2808 ExecStart&#x3D;&#x2F;usr&#x2F;sbin&#x2F;glusterd -p &#x2F;var&#x2F;run&#x2F;glusterd.pid --log-level $LOG_LEVEL $GLUSTERD_OPTIONS (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</span><br><span class="line"> Main PID: 2810 (glusterd)</span><br><span class="line">    Tasks: 8</span><br><span class="line">   CGroup: &#x2F;system.slice&#x2F;glusterd.service</span><br><span class="line">           └─2810 &#x2F;usr&#x2F;sbin&#x2F;glusterd -p &#x2F;var&#x2F;run&#x2F;glusterd.pid --log-level INFO</span><br><span class="line"></span><br><span class="line">Nov 15 12:08:53 node1 systemd[1]: Starting GlusterFS, a clustered file-system server...</span><br><span class="line">Nov 15 12:08:54 node1 systemd[1]: Started GlusterFS, a clustered file-system server.</span><br></pre></td></tr></table></figure>

<h4 id="4、防火墙配置"><a href="#4、防火墙配置" class="headerlink" title="4、防火墙配置"></a>4、防火墙配置</h4><p>默认glusted监听tcp/24007 ，但是你增加一个brick，会开启一个新的端口，通过命令”gluster volume status”可以查询到<br>，因此如果各个节点配置了防火墙，新增一个brick之后，需要注意修改防火墙的端口限制，不然下面的配置受信任池会报错。</p>
<h4 id="5、配置受信任池"><a href="#5、配置受信任池" class="headerlink" title="5、配置受信任池"></a>5、配置受信任池</h4><p>node1操作，将node2添加到受信任池：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: success.</span><br></pre></td></tr></table></figure>
<p>如果防火墙开启可能会提示下面错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node2</span><br><span class="line">peer probe: failed: Probe returned with Transport endpoint is not connected</span><br></pre></td></tr></table></figure>
<p>node2操作，将node1添加到受信任池</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# gluster peer probe node1</span><br><span class="line">peer probe: success. Host node1 port 24007 already in peer list</span><br></pre></td></tr></table></figure>

<h4 id="6、建立GlusterFS-volume"><a href="#6、建立GlusterFS-volume" class="headerlink" title="6、建立GlusterFS volume"></a>6、建立GlusterFS volume</h4><p>node1 and node2操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;gfs&#x2F;test1&#x2F;gv0</span><br></pre></td></tr></table></figure>
<p>在任意一个节点上执行即可，不需要重复执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv0 replica 2 node1:&#x2F;gfs&#x2F;test1&#x2F;gv0 node2:&#x2F;gfs&#x2F;test1&#x2F;gv0</span><br><span class="line">[root@node1 ~]# gluster volume create gv0 replica 2 node1:&#x2F;gfs&#x2F;test1&#x2F;gv0 node2:&#x2F;gfs&#x2F;test1&#x2F;gv0</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http:&#x2F;&#x2F;docs.gluster.org&#x2F;en&#x2F;latest&#x2F;Administrator%20Guide&#x2F;Split%20brain%20and%20ways%20to%20deal%20with%20it&#x2F;.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y&#x2F;n) y</span><br><span class="line">volume create: gv0: success: please start the volume to access data</span><br></pre></td></tr></table></figure>
<p>提示只有2个副本有可能出现脑裂的情况，创建带有仲裁节点以上的gluserfs volume至少三个节点，因此两个节点的副本集可以只能忽略这个问题。<br>下面启动创建的gv0卷</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume start gv0</span><br><span class="line">[root@node1 ~]# gluster volume start gv0</span><br><span class="line">volume start: gv0: success</span><br><span class="line">Confirm that the volume shows &quot;Started&quot;:</span><br></pre></td></tr></table></figure>
<p>查看启动的gv0卷信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume info</span><br><span class="line">[root@node1 ~]# gluster volume info</span><br><span class="line"> </span><br><span class="line">Volume Name: gv0</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: 79c81f10-0cb8-4f26-a7ab-d21fe19f0bbf</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x 2 &#x3D; 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:&#x2F;gfs&#x2F;test1&#x2F;gv0</span><br><span class="line">Brick2: node2:&#x2F;gfs&#x2F;test1&#x2F;gv0</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<p>/var/log/glusterfs如果没有正常启动，可以查看日志</p>
<h4 id="7、测试Glusterfs-volume-gv0副本集是否生效"><a href="#7、测试Glusterfs-volume-gv0副本集是否生效" class="headerlink" title="7、测试Glusterfs volume gv0副本集是否生效"></a>7、测试Glusterfs volume gv0副本集是否生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#挂在到任意空目录</span><br><span class="line">mount -t glusterfs node1:&#x2F;gv0 &#x2F;mnt</span><br><span class="line">#创造测试数据</span><br><span class="line">for i in &#96;seq -w 1 100&#96;; do cp -rp &#x2F;var&#x2F;log&#x2F;messages &#x2F;mnt&#x2F;copy-test-$i; done</span><br><span class="line">#查看生成数据的数量</span><br><span class="line">ls  &#x2F;mnt | wc -l</span><br><span class="line">#在node1和node2的&#x2F;gfs&#x2F;test1&#x2F;gv0目录下均生成了100个文件</span><br><span class="line">ls &#x2F;gfs&#x2F;test1&#x2F;gv0 |wc -l</span><br></pre></td></tr></table></figure>



<p>[root@node1 ~]# gluster volume create gv1 disperse 2 node1:/gfs/test1/gv1 node2:/gfs/test1/gv1<br>disperse count must be greater than 2<br>disperse option given twice</p>
<p>Usage:<br>volume create <NEW-VOLNAME> [stripe <COUNT>] [replica <COUNT> [arbiter <COUNT>]] [disperse [<COUNT>]] [disperse-data <COUNT>] [redundancy <COUNT>] [transport &lt;tcp|rdma|tcp,rdma&gt;] <NEW-BRICK>?<vg_name>… [force]</p>
<h4 id="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"><a href="#8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来" class="headerlink" title="8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来"></a>8、添加新的节点，因为受信任池已经创建，需要在受信任池内的节点下，将新节点node3进来</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# gluster peer probe node3</span><br><span class="line">[root@node1 ~]# gluster peer status</span><br><span class="line">Number of Peers: 2</span><br><span class="line"></span><br><span class="line">Hostname: node2</span><br><span class="line">Uuid: 588d2f92-f085-4e74-ab63-c6f5aa6ffb24</span><br><span class="line">State: Peer in Cluster (Connected)</span><br><span class="line"></span><br><span class="line">Hostname: node3</span><br><span class="line">Uuid: 3495bc9c-7330-4038-ac94-1777ba0286f5</span><br><span class="line">State: Peer in Cluster (Connected)</span><br></pre></td></tr></table></figure>

<h4 id="9、创建2节点分布式volume"><a href="#9、创建2节点分布式volume" class="headerlink" title="9、创建2节点分布式volume"></a>9、创建2节点分布式volume</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#创建卷不添加任何参数的情况下，默认模式为分布式：</span><br><span class="line">#gluster volume create gv3 node1:&#x2F;gfs&#x2F;test1&#x2F;gv3 node2:&#x2F;gfs&#x2F;test1&#x2F;gv3</span><br><span class="line">[root@node1 ~]# gluster volume create gv3 node1:&#x2F;gfs&#x2F;test1&#x2F;gv3 node2:&#x2F;gfs&#x2F;test1&#x2F;gv3</span><br><span class="line">volume create: gv1: success: please start the volume to access data</span><br><span class="line"># 启动gv3</span><br><span class="line"># gluster volume start gv3</span><br><span class="line">[root@node1 ~]# gluster volume start gv3</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# gluster volume info gv3</span><br><span class="line"></span><br><span class="line">Volume Name: gv3</span><br><span class="line">Type: Distribute</span><br><span class="line">Volume ID: 02e3163b-1c69-402f-aad5-9cf4dba3267c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:&#x2F;gfs&#x2F;test1&#x2F;gv3</span><br><span class="line">Brick2: node2:&#x2F;gfs&#x2F;test1&#x2F;gv3</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br></pre></td></tr></table></figure>
<h4 id="10、测试Glusterfs-volume-gv3"><a href="#10、测试Glusterfs-volume-gv3" class="headerlink" title="10、测试Glusterfs volume gv3"></a>10、测试Glusterfs volume gv3</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:&#x2F;gv3 &#x2F;mnt</span><br><span class="line">for i in &#96;seq -w 1 100&#96;; do cp -rp &#x2F;var&#x2F;log&#x2F;messages &#x2F;mnt&#x2F;copy-test-$i; done</span><br><span class="line">#node1查看数据：</span><br><span class="line">[root@node1 gv3]# ls  &#x2F;mnt | wc -l</span><br><span class="line">100</span><br><span class="line">#node1:查看文件实际位置下的数据：</span><br><span class="line">[root@node1 gv3]# ls &#x2F;gfs&#x2F;test1&#x2F;gv3&#x2F; |wc -l</span><br><span class="line">50</span><br><span class="line">#node2：查看文件实际位置下的数据：</span><br><span class="line">[root@node2 gv3]# ls &#x2F;gfs&#x2F;test1&#x2F;gv3&#x2F; |wc -l</span><br><span class="line">50</span><br><span class="line">#虽然在节点3没有生成集群卷，在节点3上挂在&#x2F;gv3也可以看到数据：</span><br><span class="line">mount -t glusterfs 127.0.0.1:&#x2F;gv3 &#x2F;mnt</span><br><span class="line">[root@node3 mnt]# ls &#x2F;mnt&#x2F; |wc -l</span><br><span class="line">100</span><br></pre></td></tr></table></figure>


<h4 id="11、创建分布式副本"><a href="#11、创建分布式副本" class="headerlink" title="11、创建分布式副本"></a>11、创建分布式副本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># gluster volume create gv4 replica 2 transport tcp node1:&#x2F;gfs&#x2F;test1&#x2F;gv4 node2:&#x2F;gfs&#x2F;test1&#x2F;gv4 node3:&#x2F;gfs&#x2F;test1&#x2F;gv4 node4:&#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:&#x2F;gfs&#x2F;test1&#x2F;gv4 node2:&#x2F;gfs&#x2F;test1&#x2F;gv4 node3:&#x2F;gfs&#x2F;test1&#x2F;gv4 </span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http:&#x2F;&#x2F;docs.gluster.org&#x2F;en&#x2F;latest&#x2F;Administrator%20Guide&#x2F;Split%20brain%20and%20ways%20to%20deal%20with%20it&#x2F;.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y&#x2F;n) y</span><br><span class="line">number of bricks is not a multiple of replica count</span><br><span class="line">#创建副本的节点数要和副本个数成倍数关系</span><br><span class="line">[root@node1 test1]# gluster volume create gv4 replica 2 transport tcp node1:&#x2F;gfs&#x2F;test1&#x2F;gv4 node2:&#x2F;gfs&#x2F;test1&#x2F;gv4 node3:&#x2F;gfs&#x2F;test1&#x2F;gv4 node4:&#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http:&#x2F;&#x2F;docs.gluster.org&#x2F;en&#x2F;latest&#x2F;Administrator%20Guide&#x2F;Split%20brain%20and%20ways%20to%20deal%20with%20it&#x2F;.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y&#x2F;n) y</span><br><span class="line">volume create: gv4: success: please start the volume to access data</span><br><span class="line">[root@node1 test1]# gluster volume start gv4</span><br><span class="line">[root@node1 test1]# gluster volume info gv4</span><br><span class="line">Volume Name: gv4</span><br><span class="line">Type: Distributed-Replicate</span><br><span class="line">Volume ID: e8556b2e-462d-4407-99c4-a6e622754e6c</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 2 x 2 &#x3D; 4</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:&#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">Brick2: node2:&#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">Brick3: node3:&#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">Brick4: node4:&#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h4 id="12、测试Glusterfs-volume-gv4"><a href="#12、测试Glusterfs-volume-gv4" class="headerlink" title="12、测试Glusterfs volume gv4:"></a>12、测试Glusterfs volume gv4:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#挂载并创建测试数据</span><br><span class="line">mount -t glusterfs node1:&#x2F;gv4 &#x2F;mnt</span><br><span class="line">for i in &#96;seq -w 1 100&#96;; do cp -rp &#x2F;var&#x2F;log&#x2F;messages &#x2F;mnt&#x2F;copy-test-$i; done</span><br><span class="line">#查看数据分布，node1与node2数据相同，node3和node4存储另一半信息</span><br><span class="line">[root@node1 test1]# ls &#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node2 gv0]#  ls &#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">copy-test-001  copy-test-012  copy-test-021  copy-test-029  copy-test-034  copy-test-048  copy-test-060  copy-test-078  copy-test-086  copy-test-094</span><br><span class="line">copy-test-004  copy-test-015  copy-test-022  copy-test-030  copy-test-038  copy-test-051  copy-test-063  copy-test-079  copy-test-087  copy-test-095</span><br><span class="line">copy-test-006  copy-test-016  copy-test-023  copy-test-031  copy-test-039  copy-test-052  copy-test-065  copy-test-081  copy-test-088  copy-test-098</span><br><span class="line">copy-test-008  copy-test-017  copy-test-024  copy-test-032  copy-test-041  copy-test-054  copy-test-073  copy-test-082  copy-test-090  copy-test-099</span><br><span class="line">copy-test-011  copy-test-019  copy-test-028  copy-test-033  copy-test-046  copy-test-057  copy-test-077  copy-test-083  copy-test-093  copy-test-100</span><br><span class="line"></span><br><span class="line">[root@node3 test]#  ls &#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node4 ~]#  ls &#x2F;gfs&#x2F;test1&#x2F;gv4</span><br><span class="line">copy-test-002  copy-test-010  copy-test-025  copy-test-037  copy-test-045  copy-test-055  copy-test-062  copy-test-069  copy-test-075  copy-test-089</span><br><span class="line">copy-test-003  copy-test-013  copy-test-026  copy-test-040  copy-test-047  copy-test-056  copy-test-064  copy-test-070  copy-test-076  copy-test-091</span><br><span class="line">copy-test-005  copy-test-014  copy-test-027  copy-test-042  copy-test-049  copy-test-058  copy-test-066  copy-test-071  copy-test-080  copy-test-092</span><br><span class="line">copy-test-007  copy-test-018  copy-test-035  copy-test-043  copy-test-050  copy-test-059  copy-test-067  copy-test-072  copy-test-084  copy-test-096</span><br><span class="line">copy-test-009  copy-test-020  copy-test-036  copy-test-044  copy-test-053  copy-test-061  copy-test-068  copy-test-074  copy-test-085  copy-test-097</span><br></pre></td></tr></table></figure>
<h4 id="13、创建带有仲裁的副本集"><a href="#13、创建带有仲裁的副本集" class="headerlink" title="13、创建带有仲裁的副本集"></a>13、创建带有仲裁的副本集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test1]# gluster volume create gv5 replica 2 arbiter 2 transport tcp node1:&#x2F;gfs&#x2F;test1&#x2F;gv5 node2:&#x2F;gfs&#x2F;test1&#x2F;gv5 node3:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http:&#x2F;&#x2F;docs.gluster.org&#x2F;en&#x2F;latest&#x2F;Administrator%20Guide&#x2F;Split%20brain%20and%20ways%20to%20deal%20with%20it&#x2F;.</span><br><span class="line">Do you still want to continue?</span><br><span class="line"> (y&#x2F;n) y</span><br><span class="line">For arbiter configuration, replica count must be 3 and arbiter count must be 1. The 3rd brick of the replica will be the arbiter</span><br><span class="line">#提示创建仲裁必须是三个副本集</span><br><span class="line">[root@node1 test1]# gluster volume create gv5 replica 3 arbiter 1 transport tcp node1:&#x2F;gfs&#x2F;test1&#x2F;gv5 node2:&#x2F;gfs&#x2F;test1&#x2F;gv5 node3:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">#启动gv5</span><br><span class="line">[root@node1 test1]# gluster volume start gv5</span><br><span class="line">[root@node1 test1]# gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: fd4fca20-1bb3-480b-9c24-703dd3e8b508</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) &#x3D; 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Brick2: node2:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Brick3: node3:&#x2F;gfs&#x2F;test1&#x2F;gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br></pre></td></tr></table></figure>
<h4 id="14、GlusterFS的常见的卷介绍"><a href="#14、GlusterFS的常见的卷介绍" class="headerlink" title="14、GlusterFS的常见的卷介绍"></a>14、GlusterFS的常见的卷介绍</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Distributed：分布式卷，文件通过 hash 算法随机分布到由 bricks 组成的卷上。</span><br><span class="line">Replicated: 复制式卷，类似 RAID 1，replica 数必须等于 volume 中 brick 所包含的存储服务器数，可用性高。</span><br><span class="line">Striped: 条带式卷，类似 RAID 0，stripe 数必须等于 volume 中 brick 所包含的存储服务器数，文件被分成数据块，以 Round Robin 的方式存储在 bricks 中，并发粒度是数据块，大文件性能好。</span><br><span class="line">Distributed Striped: 分布式的条带卷，volume中 brick 所包含的存储服务器数必须是 stripe 的倍数（&gt;&#x3D;2倍），兼顾分布式和条带式的功能。</span><br><span class="line">Distributed Replicated: 分布式的复制卷，volume 中 brick 所包含的存储服务器数必须是 replica 的倍数（&gt;&#x3D;2倍），兼顾分布式和复制式的功能。</span><br><span class="line">分布式复制卷的brick顺序决定了文件分布的位置，一般来说，先是两个brick形成一个复制关系，然后两个复制关系形成分布。</span><br><span class="line">企业一般用后两种，大部分会用分布式复制（可用容量为 总容量&#x2F;复制份数），通过网络传输的话最好用万兆交换机，万兆网卡来做。这样就会优化一部分性能。它们的数据都是通过网络来传输的。</span><br><span class="line"></span><br><span class="line">查看官方提供的gluster volume，点击[此处](https:&#x2F;&#x2F;docs.gluster.org&#x2F;en&#x2F;latest&#x2F;Administrator%20Guide&#x2F;Setting%20Up%20Volumes&#x2F;)</span><br></pre></td></tr></table></figure>
<h4 id="15、删除卷"><a href="#15、删除卷" class="headerlink" title="15、删除卷"></a>15、删除卷</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#先停止要删除的卷</span><br><span class="line">[root@node01 ~]# gluster volume stop gv1</span><br><span class="line">[root@node01 ~]# gluster volume delete gv</span><br></pre></td></tr></table></figure>
<h4 id="16、监控负载"><a href="#16、监控负载" class="headerlink" title="16、监控负载"></a>16、监控负载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">volume profile &lt;VOLNAME&gt; &#123;start|info [peek|incremental [peek]|cumulative|clear]|stop&#125; [nfs]</span><br><span class="line">#启动性能分析：</span><br><span class="line">gluster volume profile gv5 start</span><br><span class="line">#显示io信息：</span><br><span class="line">gluster volume profile gv5 info</span><br><span class="line">#停止性能分析：</span><br><span class="line">gluster volume profile gv5 stop</span><br><span class="line"></span><br><span class="line">#使用top命令查看读取，写入，文件打开调用，读取调用，写入调用等指标：</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;open|read|write|opendir|readdir|clear&#125; [nfs|brick &lt;brick&gt;] [list-cnt &lt;value&gt;] |</span><br><span class="line">volume top &lt;VOLNAME&gt; &#123;read-perf|write-perf&#125; [bs &lt;size&gt; count &lt;count&gt;] [brick &lt;brick&gt;] [list-cnt &lt;value&gt;]</span><br><span class="line">#查看fd的当前打开数，和最大打开数</span><br><span class="line">gluster volume top gv5  open brick node1:&#x2F;gfs&#x2F;test1&#x2F;gv5 list-cnt 10</span><br><span class="line">Brick: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Current open fds: 0, Max open fds: 1, Max openfd time: 2018-11-21 14:10:02.279118</span><br><span class="line"></span><br><span class="line">#显示文件读取调用数量：</span><br><span class="line">gluster volume top gv5  read brick node1:&#x2F;gfs&#x2F;test1&#x2F;gv5 list-cnt  10</span><br><span class="line">Brick: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Count		filename</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">1		&#x2F;copy-test-002</span><br><span class="line">1		&#x2F;copy-test-001</span><br><span class="line"></span><br><span class="line">#每个brick下面文件被写入的数量列表</span><br><span class="line">gluster volume top gv5  write brick node1:&#x2F;gfs&#x2F;test1&#x2F;gv5 list-cnt  10</span><br><span class="line">Brick: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Count		filename</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">12		&#x2F;copy-test-100</span><br><span class="line">12		&#x2F;copy-test-099</span><br><span class="line">12		&#x2F;copy-test-098</span><br><span class="line">12		&#x2F;copy-test-097</span><br><span class="line">12		&#x2F;copy-test-096</span><br><span class="line">12		&#x2F;copy-test-095</span><br><span class="line">12		&#x2F;copy-test-094</span><br><span class="line">12		&#x2F;copy-test-093</span><br><span class="line">12		&#x2F;copy-test-092</span><br><span class="line">12		&#x2F;copy-test-091</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被打开的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  opendir brick node1:&#x2F;gfs&#x2F;test1&#x2F;gv5  list-cnt 10</span><br><span class="line">Brick: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Count		filename</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">1		&#x2F;test</span><br><span class="line"></span><br><span class="line">#当前brick下，目录被读的数量列表</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  readdir brick node1:&#x2F;gfs&#x2F;test1&#x2F;gv5  list-cnt 10</span><br><span class="line">Brick: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Count		filename</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2		&#x2F;test</span><br><span class="line"></span><br><span class="line">#查看brick的读性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5 read-perf bs 256  count 1 brick node1:&#x2F;gfs&#x2F;test1&#x2F;gv5  list-cnt 10</span><br><span class="line">Brick: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Throughput 51.20 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;                                        &#x3D;&#x3D;&#x3D;&#x3D;                      </span><br><span class="line">   0 &#x2F;copy-test-001                                  2018-11-21 16:14:30.512003</span><br><span class="line">   0 &#x2F;copy-test-003                                  2018-11-21 16:13:32.481649</span><br><span class="line">   0 &#x2F;copy-test-002                                  2018-11-21 16:06:19.696071</span><br><span class="line">#查看brick的写性能：</span><br><span class="line">[root@node1 test1]# gluster volume top gv5  write-perf bs 256  count 1 brick node1:&#x2F;gfs&#x2F;test1&#x2F;gv5  list-cnt 10</span><br><span class="line">Brick: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Throughput 10.67 MBps time 0.0000 secs</span><br><span class="line">MBps Filename                                        Time                      </span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;                                        &#x3D;&#x3D;&#x3D;&#x3D;                      </span><br><span class="line">   0 &#x2F;.copy-test-001.swp                             2018-11-21 16:14:53.514516</span><br><span class="line">   0 &#x2F;copy-test-001                                  2018-11-21 16:14:53.489068</span><br><span class="line">   0 &#x2F;.copy-test-001.swp                             2018-11-21 16:14:30.483696</span><br><span class="line">   0 &#x2F;.copy-test-003.swp                             2018-11-21 16:12:46.331094</span><br><span class="line">   0 &#x2F;copy-test-100                                  2018-11-21 14:10:06.65163 </span><br><span class="line">   0 &#x2F;copy-test-099                                  2018-11-21 14:10:05.953871</span><br><span class="line">   0 &#x2F;copy-test-098                                  2018-11-21 14:10:05.773626</span><br><span class="line">   0 &#x2F;copy-test-097                                  2018-11-21 14:10:05.620743</span><br><span class="line">   0 &#x2F;copy-test-096                                  2018-11-21 14:10:05.591005</span><br><span class="line">   0 &#x2F;copy-test-095                                  2018-11-21 14:10:05.555036</span><br><span class="line">#查看单个卷的信息：</span><br><span class="line">gluster volume info &lt;VOLNAME&gt;</span><br><span class="line"></span><br><span class="line">gluster volume info gv5</span><br><span class="line">Volume Name: gv5</span><br><span class="line">Type: Replicate</span><br><span class="line">Volume ID: e12e23f5-7347-4049-8d77-53cef76b0633</span><br><span class="line">Status: Started</span><br><span class="line">Snapshot Count: 0</span><br><span class="line">Number of Bricks: 1 x (2 + 1) &#x3D; 3</span><br><span class="line">Transport-type: tcp</span><br><span class="line">Bricks:</span><br><span class="line">Brick1: node1:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Brick2: node2:&#x2F;gfs&#x2F;test1&#x2F;gv5</span><br><span class="line">Brick3: node3:&#x2F;gfs&#x2F;test1&#x2F;gv5 (arbiter)</span><br><span class="line">Options Reconfigured:</span><br><span class="line">transport.address-family: inet</span><br><span class="line">nfs.disable: on</span><br><span class="line">performance.client-io-threads: off</span><br><span class="line"></span><br><span class="line">#查看所有卷的信息：</span><br><span class="line">gluster volume info all</span><br><span class="line"></span><br><span class="line">#查看卷状态：</span><br><span class="line">gluster volume status [all| []] [detail|clients|mem|inode|fd|callpool]</span><br><span class="line">#显示所有卷的状态</span><br><span class="line">gluster volume status all</span><br><span class="line">#显示卷额外的信息：</span><br><span class="line">gluster volume status gv5  detail</span><br><span class="line">#显示客户端列表：</span><br><span class="line">gluster volume status gv5  clients</span><br><span class="line">#显示内存使用情况：</span><br><span class="line">gluster volume status gv5  mem</span><br><span class="line">#显示卷的inode表</span><br><span class="line">gluster volume status gv5  inode</span><br><span class="line">#显示卷打开的fd表</span><br><span class="line">gluster volume status gv5  fd</span><br><span class="line">#显示卷的挂起调用</span><br><span class="line">gluster volume status gv5  callpool</span><br></pre></td></tr></table></figure>
<h4 id="17、glusterfs其他信息查看"><a href="#17、glusterfs其他信息查看" class="headerlink" title="17、glusterfs其他信息查看"></a>17、glusterfs其他信息查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#看下节点有没有在线</span><br><span class="line">gluster volume status nfsp</span><br><span class="line">#启动完全修复</span><br><span class="line">gluster volume heal gv2 full</span><br><span class="line">#查看需要修复的文件</span><br><span class="line">gluster volume heal gv2 info</span><br><span class="line">#查看修复成功的文件</span><br><span class="line">gluster volume heal gv2 info healed</span><br><span class="line">#查看修复失败的文件</span><br><span class="line">gluster volume heal gv2 heal-failed</span><br><span class="line">#查看脑裂的文件</span><br><span class="line">gluster volume heal gv2 info split-brain</span><br><span class="line">#激活quota功能</span><br><span class="line">gluster volume quota gv2 enable</span><br><span class="line">#关闭quota功能</span><br><span class="line">gulster volume quota gv2 disable</span><br><span class="line">#目录限制（卷中文件夹的大小）</span><br><span class="line">gluster volume quota limit-usage &#x2F;data&#x2F;30MB --&#x2F;gv2&#x2F;data</span><br><span class="line">#quota信息列表</span><br><span class="line">gluster volume quota gv2 list</span><br><span class="line">#限制目录的quota信息</span><br><span class="line">gluster volume quota gv2 list &#x2F;data</span><br><span class="line">#设置信息的超时时间</span><br><span class="line">gluster volume set gv2 features.quota-timeout 5</span><br><span class="line">#删除某个目录的quota设置</span><br><span class="line">gluster volume quota gv2 remove &#x2F;data</span><br><span class="line">备注：quota功能，主要是对挂载点下的某个目录进行空间限额。如：&#x2F;mnt&#x2F;gulster&#x2F;data目录，而不是对组成卷组的空间进行限制。</span><br></pre></td></tr></table></figure>
<h4 id="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"><a href="#18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。" class="headerlink" title="18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。"></a>18、使用zabbix模板监控glusterfs，zabbix官网有自带的模板，CPU、内存、磁盘空间、主机运行时间、系统load。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gfszabbix监控</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;MrCirca&#x2F;zabbix-glusterfs</span><br></pre></td></tr></table></figure>


      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/25/GlusterFS/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/23/vsftp启用虚拟用户功能/"><span>[Linux] vsftp启用虚拟用户功能</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/23/vsftp启用虚拟用户功能/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-23T09:17:30.000Z">
          2018-11-23
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处"><a href="#0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处" class="headerlink" title="0、部署vsftp-server，请先跳转到此处，部署vsfpt-ssl功能，点击此处"></a>0、部署vsftp-server，请先跳转到<a href="https://zeven0707.github.io/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/" target="_blank" rel="noopener">此处</a>，部署vsfpt-ssl功能，点击<a href="https://zeven0707.github.io/2018/11/12/vsftpd%E9%85%8D%E7%BD%AEssl/" target="_blank" rel="noopener">此处</a></h4><h4 id="1、在-etc-vsftpd-conf配置文件添加以下内容"><a href="#1、在-etc-vsftpd-conf配置文件添加以下内容" class="headerlink" title="1、在/etc/vsftpd.conf配置文件添加以下内容"></a>1、在/etc/vsftpd.conf配置文件添加以下内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#开启虚拟用户的功能</span><br><span class="line">guest_enable&#x3D;YES</span><br><span class="line">#指定虚拟用户的宿主用户</span><br><span class="line">guest_username&#x3D;vir</span><br><span class="line">#指定虚拟用户配置文件的存放路径</span><br><span class="line">user_config_dir&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;vuser_conf</span><br><span class="line">#虚拟用户和本地用户有相同的权限</span><br><span class="line">virtual_use_local_privs&#x3D;YES</span><br></pre></td></tr></table></figure>
<h4 id="2、建立虚拟用户名文件"><a href="#2、建立虚拟用户名文件" class="headerlink" title="2、建立虚拟用户名文件"></a>2、建立虚拟用户名文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users.conf</span><br><span class="line">#输入奇数行为账号，偶数行为密码</span><br><span class="line">f1</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<h4 id="3、生成认证文件-如果db-load命令不存在先安装-yum-install-db4-db4-utils"><a href="#3、生成认证文件-如果db-load命令不存在先安装-yum-install-db4-db4-utils" class="headerlink" title="3、生成认证文件,如果db_load命令不存在先安装(yum install db4 db4-utils)"></a>3、生成认证文件,如果db_load命令不存在先安装(yum install db4 db4-utils)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# db_load -T -t hash -f &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users.conf &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users.db</span><br></pre></td></tr></table></figure>
<h4 id="4、文件生成之后，修改文件权限"><a href="#4、文件生成之后，修改文件权限" class="headerlink" title="4、文件生成之后，修改文件权限"></a>4、文件生成之后，修改文件权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# chmod 600 &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users.db</span><br></pre></td></tr></table></figure>
<h4 id="5、编辑认证文件-将其余行注释，只保留第一行和最后两行"><a href="#5、编辑认证文件-将其余行注释，只保留第一行和最后两行" class="headerlink" title="5、编辑认证文件,将其余行注释，只保留第一行和最后两行"></a>5、编辑认证文件,将其余行注释，只保留第一行和最后两行</h4><p>“/etc/vsftpd/vsftpd_users”根据自己配置的文件设置，.db后缀无需添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost f2]# more &#x2F;etc&#x2F;pam.d&#x2F;vsftpd</span><br><span class="line">#%PAM-1.0</span><br><span class="line">#session    optional     pam_keyinit.so    force revoke</span><br><span class="line">#auth       required	pam_listfile.so item&#x3D;user sense&#x3D;deny file&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;ftpusers onerr&#x3D;succeed</span><br><span class="line">#auth       required	pam_shells.so</span><br><span class="line">#auth       include	password-auth</span><br><span class="line">#account    include	password-auth</span><br><span class="line">#session    required     pam_loginuid.so</span><br><span class="line">#session    include	password-auth</span><br><span class="line">auth sufficient &#x2F;lib64&#x2F;security&#x2F;pam_userdb.so db&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users</span><br><span class="line">account sufficient &#x2F;lib64&#x2F;security&#x2F;pam_userdb.so db&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users</span><br></pre></td></tr></table></figure>
<h4 id="6、建立虚拟用户配置文件存放位置"><a href="#6、建立虚拟用户配置文件存放位置" class="headerlink" title="6、建立虚拟用户配置文件存放位置"></a>6、建立虚拟用户配置文件存放位置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir &#x2F;etc&#x2F;vsftpd&#x2F;vuser_conf&#x2F;</span><br><span class="line">[root@localhost ~]# vim &#x2F;etc&#x2F;vsftpd&#x2F;vuser_conf&#x2F;f1</span><br><span class="line">#添加以下内容</span><br><span class="line">local_root&#x3D;&#x2F;var&#x2F;ftp&#x2F;f1</span><br><span class="line">write_enable&#x3D;YES</span><br><span class="line">anon_umask&#x3D;022</span><br><span class="line">anon_world_readable_only&#x3D;NO</span><br><span class="line">anon_upload_enable&#x3D;YES</span><br><span class="line">anon_mkdir_write_enable&#x3D;YES</span><br><span class="line">anon_other_write_enable&#x3D;YES</span><br></pre></td></tr></table></figure>
<h4 id="7、将f1用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f1用户登录"><a href="#7、将f1用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f1用户登录" class="headerlink" title="7、将f1用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f1用户登录"></a>7、将f1用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f1用户登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vsftpd]# more &#x2F;etc&#x2F;vsftpd&#x2F;chroot_list |grep f1</span><br><span class="line">f1</span><br><span class="line">[root@localhost vsftpd]# more &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.user_list |grep f1</span><br><span class="line">f1</span><br></pre></td></tr></table></figure>
<h4 id="8、重新启动vsftp"><a href="#8、重新启动vsftp" class="headerlink" title="8、重新启动vsftp"></a>8、重新启动vsftp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl vsftpd restart</span><br></pre></td></tr></table></figure>
<h4 id="9、测试用户能否正常登录："><a href="#9、测试用户能否正常登录：" class="headerlink" title="9、测试用户能否正常登录："></a>9、测试用户能否正常登录：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# .&#x2F;sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL&#x2F;TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f1</span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">Connection problem SSLTCP:525:ssl_read tcp:-1000:SSL failure. (SSL_ERROR_SSL):error:1408F10B:SSL routines:SSL3_GET_RECORD:wrong version number</span><br><span class="line">Channel open, login Failed!</span><br></pre></td></tr></table></figure>
<p>提示的错误没找到任何相关文档，尝试用tcpdump抓包看看交互情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">15:50:39.932746 IP 192.168.168.120.21 &gt; 192.168.168.121.39398: Flags [P.], seq 1806:1816, ack 772, win 243, options [nop,nop,TS val 513318660 ecr 1441172002], length 10: FTP: 500 OOPS: [!ftp]</span><br><span class="line">15:50:39.932769 IP 192.168.168.120.21 &gt; 192.168.168.121.39398: Flags [P.], seq 1816:1851, ack 772, win 243, options [nop,nop,TS val 513318660 ecr 1441172002], length 35: FTP: cannot change directory:&#x2F;var&#x2F;ftp&#x2F;f1[!ftp]</span><br></pre></td></tr></table></figure>
<p>提示f1的目录不存在，尝试创建f1的目录，并修改权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;ftp&#x2F;f1</span><br><span class="line">chown ftp1.ftp1 &#x2F;var&#x2F;ftp&#x2F;f1</span><br></pre></td></tr></table></figure>
<p>再次登录，正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# .&#x2F;sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL&#x2F;TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f1</span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">230 Login successful.</span><br><span class="line">Type in &quot;save&quot; to save login details to &#x2F;root&#x2F;.netrc</span><br><span class="line">sslftp&gt; ls</span><br><span class="line">226 Directory send OK.</span><br><span class="line">sslftp&gt; exit</span><br><span class="line">221 Goodbye.</span><br><span class="line">Channel Closed.</span><br></pre></td></tr></table></figure>
<h4 id="10、新增f2用户，修改vsftpd-users-conf配置文件，添加f2用户"><a href="#10、新增f2用户，修改vsftpd-users-conf配置文件，添加f2用户" class="headerlink" title="10、新增f2用户，修改vsftpd_users.conf配置文件，添加f2用户"></a>10、新增f2用户，修改vsftpd_users.conf配置文件，添加f2用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users.conf</span><br><span class="line">#输入奇数行为账号，偶数行为密码</span><br><span class="line">f1</span><br><span class="line">123456</span><br><span class="line">f2</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>
<h4 id="11、重新生成认证文件"><a href="#11、重新生成认证文件" class="headerlink" title="11、重新生成认证文件"></a>11、重新生成认证文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# db_load -T -t hash -f &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users.conf &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd_users.db</span><br></pre></td></tr></table></figure>
<h4 id="12、将f2用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f2用户登录"><a href="#12、将f2用户加入-etc-vsftpd-chroot-list，-etc-vsftpd-vsftpd-user-list允许f2用户登录" class="headerlink" title="12、将f2用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f2用户登录"></a>12、将f2用户加入/etc/vsftpd/chroot_list，/etc/vsftpd/vsftpd.user_list允许f2用户登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost vsftpd]# more &#x2F;etc&#x2F;vsftpd&#x2F;chroot_list |grep -E &quot;f1|f2&quot;</span><br><span class="line">f1</span><br><span class="line">f2</span><br><span class="line">[root@localhost vsftpd]# more &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.user_list |grep -E &quot;f1|f2&quot;</span><br><span class="line">f1</span><br><span class="line">f2</span><br></pre></td></tr></table></figure>
<h4 id="13、添加f2配置文件"><a href="#13、添加f2配置文件" class="headerlink" title="13、添加f2配置文件"></a>13、添加f2配置文件</h4><p>vim /etc/vsftpd/vuser_conf/f2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">local_root&#x3D;&#x2F;var&#x2F;ftp&#x2F;f2</span><br><span class="line">write_enable&#x3D;YES</span><br><span class="line">anon_umask&#x3D;022</span><br><span class="line">anon_world_readable_only&#x3D;NO</span><br><span class="line">anon_upload_enable&#x3D;YES</span><br><span class="line">anon_mkdir_write_enable&#x3D;YES</span><br><span class="line">anon_other_write_enable&#x3D;YES</span><br></pre></td></tr></table></figure>
<h4 id="14、创建f2目录，并修改权限"><a href="#14、创建f2目录，并修改权限" class="headerlink" title="14、创建f2目录，并修改权限"></a>14、创建f2目录，并修改权限</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;ftp&#x2F;f2</span><br><span class="line">chown ftp1.ftp1 &#x2F;var&#x2F;ftp&#x2F;f2</span><br></pre></td></tr></table></figure>
<h4 id="15、重新启动vsftpd"><a href="#15、重新启动vsftpd" class="headerlink" title="15、重新启动vsftpd"></a>15、重新启动vsftpd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl vsftpd restart</span><br></pre></td></tr></table></figure>
<h4 id="16、测试登录vsftpd是否正常"><a href="#16、测试登录vsftpd是否正常" class="headerlink" title="16、测试登录vsftpd是否正常"></a>16、测试登录vsftpd是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost surgeftp_2.3f2_linux64]# .&#x2F;sslftp 192.168.168.120</span><br><span class="line">Connected to 192.168.168.120</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">234 Proceed with negotiation.</span><br><span class="line">starting SSL&#x2F;TLS</span><br><span class="line">sslinit 3</span><br><span class="line">Negotiated secure protocol TLSv1.2, using an AES cipher.</span><br><span class="line">200 PBSZ set to 0.</span><br><span class="line">200 PROT now Private.</span><br><span class="line">(secure) User: f2 </span><br><span class="line">331 Please specify the password.</span><br><span class="line">(secure) Password: ******</span><br><span class="line">230 Login successful.</span><br><span class="line">Type in &quot;save&quot; to save login details to &#x2F;root&#x2F;.netrc</span><br><span class="line">sslftp&gt;</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/23/vsftp启用虚拟用户功能/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/22/DNS服务部署/"><span>[Linux] DNS服务部署(单点&amp;主从)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/22/DNS服务部署/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-22T15:10:30.000Z">
          2018-11-22
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="1、关闭防火墙开启相应的服务"><a href="#1、关闭防火墙开启相应的服务" class="headerlink" title="1、关闭防火墙开启相应的服务"></a>1、关闭防火墙开启相应的服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost  ~]#setenforce  0</span><br><span class="line">[root@localhost  ~]#iptables  -F</span><br></pre></td></tr></table></figure>
<h3 id="2、主节点安装dns"><a href="#2、主节点安装dns" class="headerlink" title="2、主节点安装dns"></a>2、主节点安装dns</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot bind-utils</span><br></pre></td></tr></table></figure>
<h4 id="3、修改配置文件"><a href="#3、修改配置文件" class="headerlink" title="3、修改配置文件"></a>3、修改配置文件</h4><h5 id="3-1、-etc-named-conf—–主配置文件-服务器主要运行参数"><a href="#3-1、-etc-named-conf—–主配置文件-服务器主要运行参数" class="headerlink" title="3.1、/etc/named.conf—–主配置文件,服务器主要运行参数"></a>3.1、/etc/named.conf—–主配置文件,服务器主要运行参数</h5><p>修改dns主配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; 10.0.30.95;127.0.0.1 &#125;;</span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       &quot;&#x2F;var&#x2F;named&quot;;</span><br><span class="line">        dump-file       &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;cache_dump.db&quot;;</span><br><span class="line">        statistics-file &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;named_stats.txt&quot;;</span><br><span class="line">        memstatistics-file &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;named_mem_stats.txt&quot;;</span><br><span class="line">        allow-query     &#123; any; &#125;;</span><br><span class="line">        forwarders &#123; 8.8.8.8; &#125;;</span><br></pre></td></tr></table></figure>
<h5 id="3-2、-etc-named-rfc1912-zones—–区域文件，主要指定要解析哪个域名"><a href="#3-2、-etc-named-rfc1912-zones—–区域文件，主要指定要解析哪个域名" class="headerlink" title="3.2、/etc/named.rfc1912.zones—–区域文件，主要指定要解析哪个域名"></a>3.2、/etc/named.rfc1912.zones—–区域文件，主要指定要解析哪个域名</h5><p>vim /etc/named.rfc1912.zones</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 首先对文件中正向解析的区域进行修改</span><br><span class="line">zone &quot;node&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;node.conf&quot;;</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#x2F;&#x2F; 设置好域名格式以及相应的数据文件接下来进行反向解析区域的配置</span><br><span class="line">zone  &quot;30.0.10.in -addr.arpa&quot;  IN&#123;</span><br><span class="line">          type master;</span><br><span class="line">          file &quot;node.txt&quot;;</span><br><span class="line">          allow-update &#123; none; &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-3、配置完成之后校验一下文件配置是否正确："><a href="#3-3、配置完成之后校验一下文件配置是否正确：" class="headerlink" title="3.3、配置完成之后校验一下文件配置是否正确："></a>3.3、配置完成之后校验一下文件配置是否正确：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# named-checkconf</span><br><span class="line">[root@node4 named]# </span><br><span class="line">没有任何输出表示 &#x2F;etc&#x2F;named.conf没有语法错误</span><br></pre></td></tr></table></figure>
<h5 id="3-4、-var-named-xxx-xx-——-数据文件，用来正向和反向的解析"><a href="#3-4、-var-named-xxx-xx-——-数据文件，用来正向和反向的解析" class="headerlink" title="3.4、/var/named/xxx.xx ——-数据文件，用来正向和反向的解析"></a>3.4、/var/named/xxx.xx ——-数据文件，用来正向和反向的解析</h5><p>主文件及区域文件修改完成后接下来进行数据文件的修改,切换到/var/named目录下,对数据文件进行相应的选项配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;var&#x2F;named&#x2F;</span><br><span class="line">cp named.empty  node.conf</span><br></pre></td></tr></table></figure>
<p>首先对其正向解析的数据文件进行配置<br>vim node.com</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA gfs.com rname.invalid. (</span><br><span class="line">					0	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">                NS	dns.gfs.com.</span><br><span class="line">dns.gfs.com	    A 10.0.30.95</span><br><span class="line">node1.gfs.com 1 A 10.0.30.51</span><br><span class="line">	           AAAA	::1</span><br></pre></td></tr></table></figure>
<p>对反向解析的数据文件进行配置，反向解析数据文件里面只有SOA、NS、PTR资源记录，所有A记录都要改为PTR记录，名称为IP地址，IP地址可以写全也可以简写，如果写全则是IP地址反写加上.in-addr.arpa.例如：116.2.16.172.in-addr.arpa. PTR资源记录的值为域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp named.empty  node.txt</span><br></pre></td></tr></table></figure>
<p>vim node.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA gfs.com rname.invalid. (</span><br><span class="line">					0	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">     NS	dns.gfs.com.</span><br><span class="line">95	PTR dns.gfs.com.</span><br><span class="line">51  PTR node1.gfs.com.</span><br></pre></td></tr></table></figure>
<h5 id="3-5、解析文件参数详解"><a href="#3-5、解析文件参数详解" class="headerlink" title="3.5、解析文件参数详解"></a>3.5、解析文件参数详解</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">区域解析库文件第一个记录必须是SOA记录，必须有NS记录并且正解区域要有NS记录的A记录，反解则不需要有NS记录对应的A记录。</span><br><span class="line">$TTL表示宏定义，TTL(Time- To-Live)，dns记录在本地DNS服务器上保留的时间</span><br><span class="line">@符号可代表区域文件&#x2F;etc&#x2F;named.conf里面定义的区域名称，即：&quot;gfs.com.&quot;。</span><br><span class="line">2018030422 ;标识序列号，十进制数字，不能超过10位，通常使用日期</span><br><span class="line">2H ;刷新时间，即每隔多久到主服务器检查一次，此处为2小时，实验环境可以设置小一点</span><br><span class="line">4M ;重试时间，应该小于刷新时间，此处为4分钟，实验环境可以设置小一点</span><br><span class="line">1D ;过期时间，此处为1天</span><br><span class="line">2D ;主服务器挂后，从服务器至多工作的时间，此处为2天)</span><br><span class="line">这个文件里所有的域名结尾的点号一定不能省略。</span><br><span class="line">区域解析库文件是放在&#x2F;var&#x2F;named目录下，由named进程是以named用户运行，因此区域解析库文件的属组应设置为named。</span><br><span class="line"></span><br><span class="line">（1）A记录（Address）正向解析</span><br><span class="line">A记录是将一个主机名（全称域名FQDN）和一个IP地址关联起来。这也是大多数客户端程序默认的查询类型。</span><br><span class="line">（2）PTR记录（Pointer）反向解析</span><br><span class="line">PTR记录将一个IP地址对应到主机名（全称域名FQDN）。这些记录保存在in-addr.arpa域中。</span><br><span class="line">（3）CNAME记录(Canonical Name)别名</span><br><span class="line">别名记录，也称为规范名字(Canonical Name)。这种记录允许您将多个名字映射到同一台计算机。</span><br><span class="line">（4）MX记录（Mail eXchange）</span><br><span class="line">MX记录是邮件交换记录，它指向一个邮件服务器，用于电子邮件系统发邮件时根据 收信人的地址后缀来定位邮件服务器。MX记录也叫做邮件路由记录，用户可以将该域名下的邮件服务器指向到自己的mail server上，然后即可自行操控所有的邮箱设置。</span><br><span class="line">当有多个MX记录（即有多个邮件服务器）时，则需要设置数值来确定其优先级。通过设置优先级数字来指明首选服务器，数字越小表示优先级越高。</span><br><span class="line">（5）NS记录（Name Server）</span><br><span class="line">NS（Name Server）记录是域名服务器记录，也称为授权服务器，用来指定该域名由哪个DNS服务器来进行解析。</span><br><span class="line">将网站的NS记录指向到目标地址，在设置NS记录的同时还需要设置目标网站的指向，否则NS记录将无法正常解析</span><br><span class="line">NS记录优先于A记录。即，如果一个主机地址同时存在NS记录和A记录，则A记录不生效。</span><br><span class="line">（6）AAAA记录 IPV6解析记录</span><br><span class="line">该记录是将域名解析到一个指定的IPV6的IP上。</span><br></pre></td></tr></table></figure>
<h5 id="3-6、相应的数据配置文件完成后对数据文件的属主进行修改"><a href="#3-6、相应的数据配置文件完成后对数据文件的属主进行修改" class="headerlink" title="3.6、相应的数据配置文件完成后对数据文件的属主进行修改"></a>3.6、相应的数据配置文件完成后对数据文件的属主进行修改</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost  named]#chown  named  node.*</span><br><span class="line">[root@node4 named]# ll node.*</span><br><span class="line">-rw-r-----. 1 named root 286 Nov 22 16:12 node.conf</span><br><span class="line">-rw-r-----. 1 named root 310 Nov 22 16:12 node.txt</span><br></pre></td></tr></table></figure>
<h5 id="3-7、配置完成后检测解析文件是否正确"><a href="#3-7、配置完成后检测解析文件是否正确" class="headerlink" title="3.7、配置完成后检测解析文件是否正确"></a>3.7、配置完成后检测解析文件是否正确</h5><p>[root@node4 named]# named-checkzone “gfs.com” node.conf<br>zone gfs.com/IN: loaded serial 0<br>OK</p>
<h5 id="3-8、检测反向解析库配置有没有错误"><a href="#3-8、检测反向解析库配置有没有错误" class="headerlink" title="3.8、检测反向解析库配置有没有错误"></a>3.8、检测反向解析库配置有没有错误</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# named-checkzone &quot;30.0.10.in-addr.arpa&quot; node.txt</span><br><span class="line">zone 30.0.10.in-addr.arpa&#x2F;IN: loaded serial 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h4 id="4、修改完成后启动dns服务"><a href="#4、修改完成后启动dns服务" class="headerlink" title="4、修改完成后启动dns服务"></a>4、修改完成后启动dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named.service</span><br></pre></td></tr></table></figure>
<h4 id="5、在客户端配置dns信息"><a href="#5、在客户端配置dns信息" class="headerlink" title="5、在客户端配置dns信息"></a>5、在客户端配置dns信息</h4><h5 id="5-1、修改-etc-NetworkManager-NetworkManager-conf-文件，防止重启网卡后dns被重置，在main部分添加-“dns-none”-选项"><a href="#5-1、修改-etc-NetworkManager-NetworkManager-conf-文件，防止重启网卡后dns被重置，在main部分添加-“dns-none”-选项" class="headerlink" title="5.1、修改 /etc/NetworkManager/NetworkManager.conf 文件，防止重启网卡后dns被重置，在main部分添加 “dns=none” 选项"></a>5.1、修改 /etc/NetworkManager/NetworkManager.conf 文件，防止重启网卡后dns被重置，在main部分添加 “dns=none” 选项</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">plugins&#x3D;ifcfg-rh</span><br><span class="line">dns&#x3D;none</span><br></pre></td></tr></table></figure>
<h5 id="5-2、NetworkManager重新装载上面修改的配置"><a href="#5-2、NetworkManager重新装载上面修改的配置" class="headerlink" title="5.2、NetworkManager重新装载上面修改的配置"></a>5.2、NetworkManager重新装载上面修改的配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart NetworkManager.service</span><br></pre></td></tr></table></figure>
<h5 id="5-3、之后修改-etc-resolv-conf配置文件："><a href="#5-3、之后修改-etc-resolv-conf配置文件：" class="headerlink" title="5.3、之后修改/etc/resolv.conf配置文件："></a>5.3、之后修改/etc/resolv.conf配置文件：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# more &#x2F;etc&#x2F;resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">[root@node2 ~]# &#x2F;etc&#x2F;init.d&#x2F;network restart</span><br><span class="line">Restarting network (via systemctl):                        [  OK  ]</span><br><span class="line">[root@node2 ~]# more &#x2F;etc&#x2F;resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 202.106.0.20</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# ls</span><br><span class="line">anaconda-ks.cfg  Desktop  Documents  Downloads  initial-setup-ks.cfg  Music  Pictures  Public  Templates  Videos</span><br><span class="line">[root@node2 ~]# vim &#x2F;etc&#x2F;NetworkManager&#x2F;NetworkManager.conf </span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# systemctl restart NetworkManager.service</span><br><span class="line">[root@node2 ~]# vim &#x2F;etc&#x2F;resolv.conf</span><br><span class="line">[root@node2 ~]# </span><br><span class="line">[root@node2 ~]# more &#x2F;etc&#x2F;resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">[root@node2 ~]# &#x2F;etc&#x2F;init.d&#x2F;network restart</span><br><span class="line">Restarting network (via systemctl):                        [  OK  ]</span><br><span class="line">[root@node2 ~]# more &#x2F;etc&#x2F;resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br></pre></td></tr></table></figure>
<h5 id="5-4、测试dns是否能正常解析："><a href="#5-4、测试dns是否能正常解析：" class="headerlink" title="5.4、测试dns是否能正常解析："></a>5.4、测试dns是否能正常解析：</h5><p>正向解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 30794</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 17:44:35 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure>
<p>反向解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -x 10.0.30.51 </span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -x 10.0.30.51</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 50154</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;51.30.0.10.in-addr.arpa.	IN	PTR</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">51.30.0.10.in-addr.arpa. 10800	IN	PTR	node1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">30.0.10.in-addr.arpa.	10800	IN	NS	dns2.gfs.com.</span><br><span class="line">30.0.10.in-addr.arpa.	10800	IN	NS	dns1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 17:44:47 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 149</span><br></pre></td></tr></table></figure>
<p>上面单节点的dns配置完成，下面配置dns主从，从节点实时同步主节点更新的数据。</p>
<h4 id="6、主节点修改-etc-named-rfc1912-zones"><a href="#6、主节点修改-etc-named-rfc1912-zones" class="headerlink" title="6、主节点修改/etc/named.rfc1912.zones"></a>6、主节点修改/etc/named.rfc1912.zones</h4><p>allow-transfer { 10.0.30.117; }; #指定允许转发的目标主机，即从服务器<br>also-notify:主动通知从域名服务器进行更新，在主域名服务器进行更新后，而不需要在等规定的时间后才通知从域名服务器进行更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;gfs.com&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;node.conf&quot;;</span><br><span class="line">        allow-transfer &#123; 10.0.30.117; &#125;;</span><br><span class="line">        also-notify &#123; 10.0.30.117; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone  &quot;30.0.10.in-addr.arpa&quot;  IN&#123;</span><br><span class="line">          type master;</span><br><span class="line">          file &quot;node.txt&quot;;</span><br><span class="line">          also-notify &#123; 10.0.30.117; &#125;;</span><br><span class="line">          allow-transfer &#123; 10.0.30.117; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="7、修改主节点正向解析文件"><a href="#7、修改主节点正向解析文件" class="headerlink" title="7、修改主节点正向解析文件"></a>7、修改主节点正向解析文件</h4><p>[root@node4 named]# more node.conf </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA	gfs.com. rname.invalid. (</span><br><span class="line">					2	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">	NS	dns1.gfs.com.</span><br><span class="line">    NS  dns2.gfs.com.</span><br><span class="line">dns1 A 10.0.30.95</span><br><span class="line">dns2 A 10.0.30.117</span><br><span class="line">node1  A 10.0.30.51</span><br><span class="line">node2  A 10.0.30.35</span><br><span class="line">node3  A 10.0.30.117</span><br><span class="line">	AAAA	::1</span><br></pre></td></tr></table></figure>
<h4 id="8、修改主节点反向解析文件"><a href="#8、修改主节点反向解析文件" class="headerlink" title="8、修改主节点反向解析文件"></a>8、修改主节点反向解析文件</h4><p>[root@node4 named]# more node.txt </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 3H</span><br><span class="line">@	IN SOA gfs.com. rname.invalid. (</span><br><span class="line">					2	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">      NS  dns1.gfs.com.</span><br><span class="line">      NS  dns2.gfs.com.</span><br><span class="line">95   PTR dns1.gfs.com.</span><br><span class="line">117  PTR dns2.gfs.com.</span><br><span class="line">51   PTR node1.gfs.com.</span><br><span class="line">35   PTR node2.gfs.com.</span><br><span class="line">117  PTR node3.gfs.com.</span><br></pre></td></tr></table></figure>

<h4 id="9、重新启动dns服务器"><a href="#9、重新启动dns服务器" class="headerlink" title="9、重新启动dns服务器"></a>9、重新启动dns服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart named.service</span><br></pre></td></tr></table></figure>
<h4 id="10、在从服务器上安装dns服务"><a href="#10、在从服务器上安装dns服务" class="headerlink" title="10、在从服务器上安装dns服务"></a>10、在从服务器上安装dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bind bind-chroot bind-utils</span><br></pre></td></tr></table></figure>
<h4 id="11、修改从节点-etc-named-conf配置文件"><a href="#11、修改从节点-etc-named-conf配置文件" class="headerlink" title="11、修改从节点/etc/named.conf配置文件"></a>11、修改从节点/etc/named.conf配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">	listen-on port 53 &#123; 10.0.30.117;127.0.0.1; &#125;;</span><br><span class="line">	listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">	directory 	&quot;&#x2F;var&#x2F;named&quot;;</span><br><span class="line">	dump-file 	&quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;cache_dump.db&quot;;</span><br><span class="line">	statistics-file &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;named_stats.txt&quot;;</span><br><span class="line">	memstatistics-file &quot;&#x2F;var&#x2F;named&#x2F;data&#x2F;named_mem_stats.txt&quot;;</span><br><span class="line">	allow-query     &#123; any; &#125;;</span><br><span class="line">	forwarders &#123; 8.8.8.8; &#125;;</span><br></pre></td></tr></table></figure>
<h4 id="12、修改-etc-named-rfc1912-zones"><a href="#12、修改-etc-named-rfc1912-zones" class="headerlink" title="12、修改/etc/named.rfc1912.zones"></a>12、修改/etc/named.rfc1912.zones</h4><p>allow-notify 接受这个网段内的主机发送来的通知</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;gfs.com&quot; IN &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        masters &#123; 10.0.30.95; &#125;;</span><br><span class="line">        allow-notify &#123; 10.0.30.95; &#125;;</span><br><span class="line">        file &quot;slaves&#x2F;node.conf&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone  &quot;30.0.10.in-addr.arpa&quot;  IN&#123;</span><br><span class="line">          type slave;</span><br><span class="line">          masters &#123; 10.0.30.95; &#125;;</span><br><span class="line">          allow-notify &#123; 10.0.30.95; &#125;;</span><br><span class="line">          file &quot;slaves&#x2F;node.txt&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="13、从服务器启动dns服务"><a href="#13、从服务器启动dns服务" class="headerlink" title="13、从服务器启动dns服务"></a>13、从服务器启动dns服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start named.service</span><br></pre></td></tr></table></figure>
<h4 id="14、查看-var-named-slaves目录下已经多出了node-的两个文件"><a href="#14、查看-var-named-slaves目录下已经多出了node-的两个文件" class="headerlink" title="14、查看/var/named/slaves目录下已经多出了node.*的两个文件"></a>14、查看/var/named/slaves目录下已经多出了node.*的两个文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# pwd</span><br><span class="line">&#x2F;var&#x2F;named&#x2F;slaves</span><br><span class="line">[root@node3 slaves]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 named named 416 Nov 22 16:12 node.conf</span><br><span class="line">-rw-r--r--. 1 named named 514 Nov 22 16:12 node.txt</span><br></pre></td></tr></table></figure>
<h4 id="15、测试主从文件能否正常同步，修改主节点node-配置文件"><a href="#15、测试主从文件能否正常同步，修改主节点node-配置文件" class="headerlink" title="15、测试主从文件能否正常同步，修改主节点node.*配置文件"></a>15、测试主从文件能否正常同步，修改主节点node.*配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# vim node.conf </span><br><span class="line">[root@node4 named]# vim node.txt </span><br><span class="line">[root@node4 named]# </span><br><span class="line">[root@node4 named]# ll node.*</span><br><span class="line">-rw-r-----. 1 named root 265 Nov 22 18:48 node.conf</span><br><span class="line">-rw-r-----. 1 named root 272 Nov 22 18:48 node.txt</span><br></pre></td></tr></table></figure>
<p>***注意修改配置文件的时候一定要修改配置文件中serial那一行，只有该行的数值大于前一个值，才会同步到从节点。</p>
<h4 id="16、主节点重新加载dns"><a href="#16、主节点重新加载dns" class="headerlink" title="16、主节点重新加载dns"></a>16、主节点重新加载dns</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload named.service</span><br></pre></td></tr></table></figure>
<h4 id="17、查看从节点日志信息"><a href="#17、查看从节点日志信息" class="headerlink" title="17、查看从节点日志信息"></a>17、查看从节点日志信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Nov 22 18:48:55 node3 named[98442]: client 10.0.30.95#52505: received notify for zone &#39;gfs.com&#39;</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com&#x2F;IN: Transfer started.</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &#39;gfs.com&#x2F;IN&#39; from 10.0.30.95#53: connected using 10.0.30.117#58148</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com&#x2F;IN: transferred serial 3</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &#39;gfs.com&#x2F;IN&#39; from 10.0.30.95#53: Transfer completed: 1 messages, 9 records, 252 bytes, 0.008 secs (31500 bytes&#x2F;sec)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone gfs.com&#x2F;IN: sending notifies (serial 3)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: client 10.0.30.95#54023: received notify for zone &#39;30.0.10.in-addr.arpa&#39;</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa&#x2F;IN: Transfer started.</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &#39;30.0.10.in-addr.arpa&#x2F;IN&#39; from 10.0.30.95#53: connected using 10.0.30.117#51530</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa&#x2F;IN: transferred serial 3</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: transfer of &#39;30.0.10.in-addr.arpa&#x2F;IN&#39; from 10.0.30.95#53: Transfer completed: 1 messages, 8 records, 249 bytes, 0.002 secs (124500 bytes&#x2F;sec)</span><br><span class="line">Nov 22 18:48:55 node3 named[98442]: zone 30.0.10.in-addr.arpa&#x2F;IN: sending notifies (serial 3)</span><br></pre></td></tr></table></figure>
<h4 id="18、查看从节点配置文件信息"><a href="#18、查看从节点配置文件信息" class="headerlink" title="18、查看从节点配置文件信息"></a>18、查看从节点配置文件信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 named named 375 Nov 22 18:48 node.conf</span><br><span class="line">-rw-r--r--. 1 named named 433 Nov 22 18:48 node.txt</span><br></pre></td></tr></table></figure>
<p>从节点文件已和主节点正常同步</p>
<h4 id="19、客户端测试主节点dns服务器挂掉从节点能否正常使用"><a href="#19、客户端测试主节点dns服务器挂掉从节点能否正常使用" class="headerlink" title="19、客户端测试主节点dns服务器挂掉从节点能否正常使用"></a>19、客户端测试主节点dns服务器挂掉从节点能否正常使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# more &#x2F;etc&#x2F;resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.0.30.95</span><br><span class="line">nameserver 10.0.30.117</span><br></pre></td></tr></table></figure>
<h4 id="20、测试正向解析是否正常"><a href="#20、测试正向解析是否正常" class="headerlink" title="20、测试正向解析是否正常"></a>20、测试正向解析是否正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 55761</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.0.30.95#53(10.0.30.95)</span><br><span class="line">;; WHEN: Thu Nov 22 18:54:03 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure>
<h4 id="21、主节点停掉dns服务："><a href="#21、主节点停掉dns服务：" class="headerlink" title="21、主节点停掉dns服务："></a>21、主节点停掉dns服务：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node4 named]# systemctl stop named.service</span><br><span class="line">[root@node4 named]# systemctl status named.service</span><br><span class="line">● named.service - Berkeley Internet Name Domain (DNS)</span><br><span class="line">   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;named.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line"></span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: zone 30.0.10.in-addr.arpa&#x2F;IN: sending notifies (serial 3)</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#58148 (gfs.com): transfer of &#39;gfs.com&#x2F;IN&#39;: AXFR-style IXFR started</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#58148 (gfs.com): transfer of &#39;gfs.com&#x2F;IN&#39;: AXFR-style IXFR ended</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#28664: received notify for zone &#39;gfs.com&#39;</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#51530 (30.0.10.in-addr.arpa): transfer of &#39;30.0.10.in-addr.arpa&#x2F;IN&#39;: AXFR-style IXFR started</span><br><span class="line">Nov 22 18:48:55 node4 named[10366]: client 10.0.30.117#51530 (30.0.10.in-addr.arpa): transfer of &#39;30.0.10.in-addr.arpa&#x2F;IN&#39;: AXFR-style IXFR ended</span><br><span class="line">Nov 22 18:48:56 node4 named[10366]: client 10.0.30.117#41288: received notify for zone &#39;30.0.10.in-addr.arpa&#39;</span><br><span class="line">Nov 22 18:59:26 node4 systemd[1]: Stopping Berkeley Internet Name Domain (DNS)...</span><br><span class="line">Nov 22 18:59:26 node4 named[10366]: received control channel command &#39;stop&#39;</span><br><span class="line">Nov 22 18:59:26 node4 systemd[1]: Stopped Berkeley Internet Name Domain (DNS).</span><br></pre></td></tr></table></figure>

<h4 id="22、客户端解析仍然正常"><a href="#22、客户端解析仍然正常" class="headerlink" title="22、客户端解析仍然正常"></a>22、客户端解析仍然正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39672</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.117#53(10.0.30.117)</span><br><span class="line">;; WHEN: Thu Nov 22 18:59:48 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure>
<h4 id="23、指定dns为主节点，解析失败"><a href="#23、指定dns为主节点，解析失败" class="headerlink" title="23、指定dns为主节点，解析失败"></a>23、指定dns为主节点，解析失败</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com @10.0.30.95</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com @10.0.30.95</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure>
<h4 id="24、指定为从节点，解析正常"><a href="#24、指定为从节点，解析正常" class="headerlink" title="24、指定为从节点，解析正常"></a>24、指定为从节点，解析正常</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com @10.0.30.117</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com @10.0.30.117</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 53270</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;node1.gfs.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">node1.gfs.com.		10800	IN	A	10.0.30.51</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">gfs.com.		10800	IN	NS	dns1.gfs.com.</span><br><span class="line">gfs.com.		10800	IN	NS	dns2.gfs.com.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">dns1.gfs.com.		10800	IN	A	10.0.30.95</span><br><span class="line">dns2.gfs.com.		10800	IN	A	10.0.30.117</span><br><span class="line"></span><br><span class="line">;; Query time: 2 msec</span><br><span class="line">;; SERVER: 10.0.30.117#53(10.0.30.117)</span><br><span class="line">;; WHEN: Thu Nov 22 19:01:30 CST 2018</span><br><span class="line">;; MSG SIZE  rcvd: 128</span><br></pre></td></tr></table></figure>
<h4 id="25、把从节点dns服务也关掉"><a href="#25、把从节点dns服务也关掉" class="headerlink" title="25、把从节点dns服务也关掉"></a>25、把从节点dns服务也关掉</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 slaves]# systemctl stop named.service</span><br></pre></td></tr></table></figure>
<h4 id="26、解析域名报错"><a href="#26、解析域名报错" class="headerlink" title="26、解析域名报错"></a>26、解析域名报错</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# dig -t A node1.gfs.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-61.el7 &lt;&lt;&gt;&gt; -t A node1.gfs.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; connection timed out; no servers could be reached</span><br></pre></td></tr></table></figure>

<h4 id="27、额外参考信息"><a href="#27、额外参考信息" class="headerlink" title="27、额外参考信息"></a>27、额外参考信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DNS服务器监听端口:</span><br><span class="line">PORT: udp&#x2F;tcp  53   ---&gt; 服务端口</span><br><span class="line">PORT: udp&#x2F;tcp 953  ---&gt; 主从连接端口</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dns各参数详解，点击[此处](https:&#x2F;&#x2F;blog.csdn.net&#x2F;bpingchang&#x2F;article&#x2F;details&#x2F;38427113)跳转</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/22/DNS服务部署/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/14/mysql-show table status语法/"><span>[Mysql] mysql-show table status语法</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/14/mysql-show table status语法/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-14T09:13:00.000Z">
          2018-11-14
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、使用方法："><a href="#1、使用方法：" class="headerlink" title="1、使用方法："></a>1、使用方法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show table status from aaaa like &#39;test_order&#39;;</span><br><span class="line">或</span><br><span class="line">show table status in aaaa like &#39;test_order&#39;;</span><br></pre></td></tr></table></figure>
<p>结果显示如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: test_order</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Dynamic</span><br><span class="line">           Rows: 84052104</span><br><span class="line"> Avg_row_length: 372</span><br><span class="line">    Data_length: 31321817088</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 25528303616</span><br><span class="line">      Data_free: 7340032</span><br><span class="line"> Auto_increment: 86709693</span><br><span class="line">    Create_time: 2018-11-02 16:20:25</span><br><span class="line">    Update_time: NULL</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: utf8mb4_general_ci</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h4 id="2、具体参数详解："><a href="#2、具体参数详解：" class="headerlink" title="2、具体参数详解："></a>2、具体参数详解：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Name:表名</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Engine:表使用的存储引擎</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Version：该列在8.0版本已经废弃，在5.7版本下显示硬编码10</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Row_format：行存储格式（Fixed, Dynamic, Compressed, Redundant, Compact）。对于myisam表，Dynamic值与 myisamchk -dvv查询出来的Packed值相对应。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rows:对于myisam存储引擎，显示实际行数。对于其他引擎，比如innodb，值是近似的(粗略估计），和实际值可能相差40%至50%之间，想要获取准确的值使用select count(*)。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Avg_row_length：平均行长度。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Data_length：对于Myisam表，该值以字节为单位显示数据文件的长度；对于Innodb,该值以字节为单位显示为聚簇索引分配内存的值（近似）。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Max_data_length：对于Myisam表，该值显示数据文件的最大长度。这是可以存储在表中的数据的总字节数，该表给定使用的数据指针大小。对于Innodb，该值已弃用。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Index_length：对于Myisam，该值为索引文件的长度（以字节为单位）。对于Innodb，该值显示内存为非聚簇索引分配的数量（以字节为单位），它是内存页中非聚簇索引大小的总和与</span><br><span class="line">Innodb内存页大小的乘积。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Data_free：已分配但未使用的字节数。Innodb-tables代表当前表所属表空间的可用空间。如果该表位于共享表空间，该值代表共享表空间的剩余空间。如果使用多个表空间，每个表拥有自己的表空间，该值仅代表当前表的剩余空间。剩余空间的意思就是当前完全空闲的区字节数减去一个安全的边界值。即使该值为0，只要新的区可以被分配插入数据也是正常的。</span><br><span class="line">对于NDB集群，该值显示磁盘分配的空间，但是还没有被磁盘数据表或者磁盘数据碎片使用的空间。</span><br><span class="line">对于分区表，该值只是估计值并不准确。想要获取更加准确的方法使用下面方法查询：</span><br><span class="line">SELECT SUM(DATA_FREE) FROM  INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA &#x3D; &#39;mydb&#39; AND TABLE_NAME &#x3D; &#39;mytable&#39;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Auto_increment：下一个自动增长值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Create_time：表创建时间。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Update_time：数据文件最后更新时间。对于一些存储引擎，该是为null。例如，Innodb存储多个表在系统表空间而且数据文件时间戳没有应用。Innodb表是使用file-per-table模式，每个表都有他自己的.ibd文件，内存buffer写入数据文件存在延迟，因而文件修改时间与最后的插入、更新、删除修改时间是不同的。对于Myisam表，数据文件时间戳是可用的，但是在window系统上，更新并不会更新时间戳，因此该值是不准确的。</span><br><span class="line">对于非分区的Innodb表，该值显示最后update、insert、delete的时间戳的值。对于MVCC，时间戳的值代表commit的时间。如果服务器重启或者该表被数据字典缓存清除，时间戳不会保留。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Check_time：表最后一次检查时间。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collation：表默认的排序规则。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Checksum：校验值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Create_options：创建表时的额外选项。当执行create table时被保留的原始选项，这些选项与活动表的设置和选项不同。</span><br><span class="line">对于Innodb表，该值显示row_format和key_block_size选项。如果表示分区表，该值会显示partitioned。当创建或者修改一个file-per-table表空间为加密模式时，该值会显示为ENCRYPTIONG(general tablespace除外)。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Comment：创建表空间添加的注释。</span><br></pre></td></tr></table></figure>
<h4 id="3、测试对innodb表添加encryption功能："><a href="#3、测试对innodb表添加encryption功能：" class="headerlink" title="3、测试对innodb表添加encryption功能："></a>3、测试对innodb表添加encryption功能：</h4><p>3.1、安装插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL PLUGIN keyring_file  soname &#39;keyring_file.so&#39;;</span><br></pre></td></tr></table></figure>
<p>3.2、创建密钥文件目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;data&#x2F;mysql&#x2F;keyfile</span><br><span class="line">chown mysql.mysql -R &#x2F;data&#x2F;mysql&#x2F;keyfile</span><br></pre></td></tr></table></figure>
<p>3.3、设置key文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set global keyring_file_data&#x3D;&#39;&#x2F;data&#x2F;mysql&#x2F;keyfile&#x2F;key01&#39;;</span><br><span class="line">show global variables like &#39;%keyring_file_data%&#39;;</span><br><span class="line">root@db 16:28:  [aaaa]&gt; show global variables like &#39;%keyring_file_data%&#39;;</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">| Variable_name     | Value                     |</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">| keyring_file_data | &#x2F;data&#x2F;mysql&#x2F;keyfile&#x2F;key01 |</span><br><span class="line">+-------------------+---------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>3.4、查看插件状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:27:  [aaaa]&gt; SELECT PLUGIN_NAME, PLUGIN_STATUS</span><br><span class="line">    -&gt;        FROM INFORMATION_SCHEMA.PLUGINS</span><br><span class="line">    -&gt;        WHERE PLUGIN_NAME LIKE &#39;keyring%&#39;;</span><br><span class="line">+--------------+---------------+</span><br><span class="line">| PLUGIN_NAME  | PLUGIN_STATUS |</span><br><span class="line">+--------------+---------------+</span><br><span class="line">| keyring_file | ACTIVE        |</span><br><span class="line">+--------------+---------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>3.5、表aa未加密时，查看表状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:29:  [aaaa]&gt; show table status from aaaa like &#39;aa&#39;;</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time | Check_time | Collation          | Checksum | Create_options | Comment |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| aa   | InnoDB |      10 | Dynamic    |   12 |           1365 |       16384 |               0 |            0 |         0 |           NULL | 2018-10-29 17:30:47 | NULL        | NULL       | utf8mb4_general_ci |     NULL |                |         |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>3.6、对表aa进行加密：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:29:  [aaaa]&gt; alter table aa encryption&#x3D;&#39;Y&#39;;</span><br><span class="line">Query OK, 12 rows affected (5.13 sec)</span><br><span class="line">Records: 12  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>3.7、再次查看表aa状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:30:  [aaaa]&gt; show table status from aaaa like &#39;aa&#39;;</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time         | Check_time | Collation          | Checksum | Create_options | Comment |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">| aa   | InnoDB |      10 | Dynamic    |   12 |           1365 |       16384 |               0 |            0 |         0 |           NULL | 2018-11-14 16:30:16 | 2018-11-14 16:30:14 | NULL       | utf8mb4_general_ci |     NULL | ENCRYPTION&#x3D;&quot;Y&quot; |         |</span><br><span class="line">+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+---------------------+------------+--------------------+----------+----------------+---------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<h4 id="4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下："><a href="#4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下：" class="headerlink" title="4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此跳转至原文，具体内容如下："></a>4、下面为大佬提供的方便查询数据库下所有表所占行数（估计）和占用空间的存储过程，点此<a href="http://en.latindevelopers.com/ivancp/2012/a-better-show-table-status/" target="_blank" rel="noopener">跳转</a>至原文，具体内容如下：</h4><p>4.1、存储过程所在的aaaa数据库，可根据自己数据库情况自行修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">DROP PROCEDURE IF EXISTS &#96;aaaa&#96;.&#96;sp_status&#96; $$</span><br><span class="line">CREATE PROCEDURE &#96;aaaa&#96;.&#96;sp_status&#96;(dbname VARCHAR(50))</span><br><span class="line">BEGIN </span><br><span class="line">-- Obtaining tables and views</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">     TABLE_NAME AS &#96;Table Name&#96;, </span><br><span class="line">     ENGINE AS &#96;Engine&#96;,</span><br><span class="line">     TABLE_ROWS AS &#96;Rows&#96;,</span><br><span class="line">     CONCAT(</span><br><span class="line">        (FORMAT((DATA_LENGTH + INDEX_LENGTH) &#x2F; POWER(1024,2),2))</span><br><span class="line">        , &#39; Mb&#39;)</span><br><span class="line">       AS &#96;Size&#96;,</span><br><span class="line">     TABLE_COLLATION AS &#96;Collation&#96;</span><br><span class="line">    FROM information_schema.TABLES</span><br><span class="line">    WHERE TABLES.TABLE_SCHEMA &#x3D; dbname</span><br><span class="line">          AND TABLES.TABLE_TYPE &#x3D; &#39;BASE TABLE&#39;</span><br><span class="line">)</span><br><span class="line">UNION</span><br><span class="line">(</span><br><span class="line">    SELECT </span><br><span class="line">     TABLE_NAME AS &#96;Table Name&#96;, </span><br><span class="line">     &#39;[VIEW]&#39; AS &#96;Engine&#96;,</span><br><span class="line">     &#39;-&#39; AS &#96;Rows&#96;,</span><br><span class="line">     &#39;-&#39; &#96;Size&#96;,</span><br><span class="line">     &#39;-&#39; AS &#96;Collation&#96;</span><br><span class="line">    FROM information_schema.TABLES</span><br><span class="line">    WHERE TABLES.TABLE_SCHEMA &#x3D; dbname </span><br><span class="line">          AND TABLES.TABLE_TYPE &#x3D; &#39;VIEW&#39;</span><br><span class="line">)</span><br><span class="line">ORDER BY 1;</span><br><span class="line">-- Obtaining functions, procedures and triggers</span><br><span class="line">(</span><br><span class="line">    SELECT ROUTINE_NAME AS &#96;Routine Name&#96;, </span><br><span class="line">     ROUTINE_TYPE AS &#96;Type&#96;,</span><br><span class="line">     &#39;&#39; AS &#96;Comment&#96;</span><br><span class="line">    FROM information_schema.ROUTINES</span><br><span class="line">    WHERE ROUTINE_SCHEMA &#x3D; dbname</span><br><span class="line">    ORDER BY ROUTINES.ROUTINE_TYPE, ROUTINES.ROUTINE_NAME</span><br><span class="line">)</span><br><span class="line">UNION</span><br><span class="line">(</span><br><span class="line">    SELECT TRIGGER_NAME,&#39;TRIGGER&#39; AS &#96;Type&#96;, </span><br><span class="line">    concat(&#39;On &#39;,EVENT_MANIPULATION,&#39;: &#39;,EVENT_OBJECT_TABLE) AS &#96;Comment&#96;</span><br><span class="line">    FROM information_schema.TRIGGERS</span><br><span class="line">    WHERE EVENT_OBJECT_SCHEMA &#x3D; dbname</span><br><span class="line">)</span><br><span class="line">ORDER BY 2,1;</span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>4.2、执行存储过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call aaaa.sp_status(&#39;aaaa&#39;);</span><br></pre></td></tr></table></figure>
<p>4.3、结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:58:  [aaaa]&gt; call aaaa.sp_status(&#39;aaaa&#39;);</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br><span class="line">| Table Name   | Engine | Rows     | Size         | Collation          |</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br><span class="line">| aa           | InnoDB | 12       | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| sequence     | InnoDB | 12292293 | 515.98 Mb    | utf8mb4_general_ci |</span><br><span class="line">| test         | InnoDB | 0        | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| test1        | InnoDB | 6        | 0.02 Mb      | utf8mb4_general_ci |</span><br><span class="line">| test_order  | InnoDB | 84052104 | 54,216.50 Mb | utf8mb4_general_ci |</span><br><span class="line">+--------------+--------+----------+--------------+--------------------+</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/14/mysql-show table status语法/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/12/vsftpd配置ssl/"><span>[Linux] vsftpd配置ssl</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/12/vsftpd配置ssl/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-12T11:09:30.000Z">
          2018-11-12
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="0、如果还没有部署vsftp-server，请先跳转到此处"><a href="#0、如果还没有部署vsftp-server，请先跳转到此处" class="headerlink" title="0、如果还没有部署vsftp-server，请先跳转到此处"></a>0、如果还没有部署vsftp-server，请先跳转到<a href="https://zeven0707.github.io/2018/11/06/centos%E5%AE%89%E8%A3%85vsftp/" target="_blank" rel="noopener">此处</a></h4><h4 id="1、查询vsftpd软件是否支持SSL"><a href="#1、查询vsftpd软件是否支持SSL" class="headerlink" title="1、查询vsftpd软件是否支持SSL"></a>1、查询vsftpd软件是否支持SSL</h4><p>ldd /usr/sbin/vsftpd | grep ssl   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libssl.so.10 &#x3D;&gt; &#x2F;lib64&#x2F;libssl.so.10 (0x00007f6cfc4a6000)</span><br></pre></td></tr></table></figure>

<h4 id="2、生成vsftpd-pem-证书"><a href="#2、生成vsftpd-pem-证书" class="headerlink" title="2、生成vsftpd.pem 证书"></a>2、生成vsftpd.pem 证书</h4><p>[root@localhost vsftpd]# openssl req -x509 -nodes -days 365 -newkey rsa:1024 -keyout /etc/vsftpd/vsftpd.pem -out /etc/vsftpd/vsftpd.pem</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Generating a 1024 bit RSA private key</span><br><span class="line">..................................++++++</span><br><span class="line">.........++++++</span><br><span class="line">writing new private key to &#39;&#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.pem&#39;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#39;.&#39;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:cn</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:goopal</span><br><span class="line">Organizational Unit Name (eg, section) []:goopal</span><br><span class="line">Common Name (eg, your name or your server&#39;s hostname) []:zeven</span><br><span class="line">Email Address []:test@goopal.com</span><br></pre></td></tr></table></figure>
<p>查看生成vsftpd.pem是否成功<br>ls -l /etc/vsftpd/|grep vsftpd.pem</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r-- 1 root root 1982 11月  9 14:20 vsftpd.pem</span><br></pre></td></tr></table></figure>

<h4 id="3、修改主配置文件-etc-vsftpd-vsftpd-conf"><a href="#3、修改主配置文件-etc-vsftpd-vsftpd-conf" class="headerlink" title="3、修改主配置文件/etc/vsftpd/vsftpd.conf"></a>3、修改主配置文件/etc/vsftpd/vsftpd.conf</h4><p>下面是ssl参数一些定义，根据自己需求去修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ssl_enable&#x3D;yes&#x2F;no             是否启用 SSL,默认为no</span><br><span class="line">allow_anon_ssl&#x3D;yes&#x2F;no         是否允许匿名用户使用SSL,默认为no</span><br><span class="line">rsa_cert_file&#x3D;&#x2F;path&#x2F;to&#x2F;file       rsa证书的位置</span><br><span class="line">dsa_cert_file&#x3D;&#x2F;path&#x2F;to&#x2F;file      dsa证书的位置</span><br><span class="line">force_local_logins_ssl&#x3D;yes&#x2F;no    非匿名用户登陆时是否加密,默认为yes</span><br><span class="line">force_local_data_ssl&#x3D;yes&#x2F;no     非匿名用户传输数据时是否加密,默认为yes</span><br><span class="line">force_anon_logins_ssl&#x3D;yes&#x2F;no    匿名用户登录时是否加密,默认为no</span><br><span class="line">force_anon_data_ssl&#x3D;yes&#x2F;no     匿名用户数据传输时是否加密,默认为no</span><br><span class="line">ssl_sslv2&#x3D;yes&#x2F;no               是否激活sslv2加密,默认no</span><br><span class="line">ssl_sslv3&#x3D;yes&#x2F;no                是否激活sslv3加密,默认no</span><br><span class="line">ssl_tlsv1&#x3D;yes&#x2F;no                是否激活tls v1加密,默认yes</span><br><span class="line">ssl_ciphers&#x3D;加密方法            默认是DES-CBC3-SHA</span><br><span class="line">require_ssl_reuse&#x3D;no 需要数据与控制流使用相同的ssl通道，程序是另起一个ssl通道，选no</span><br><span class="line">#使用ftps的情况下，主动模式是不能用的，必须使用别动模式，为考虑安全问题，可以指定被动端口范围：</span><br><span class="line">pasv_enable&#x3D;YES</span><br><span class="line">pasv_min_port&#x3D;20000</span><br><span class="line">pasv_max_port&#x3D;20001</span><br></pre></td></tr></table></figure>
<p>修改vsftpd的主配置文件vsftpd.conf添加如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ssl_enable&#x3D;YES</span><br><span class="line">allow_anon_ssl&#x3D;YES</span><br><span class="line">force_anon_logins_ssl&#x3D;YES</span><br><span class="line">force_anon_data_ssl&#x3D;YES</span><br><span class="line">force_local_logins_ssl&#x3D;YES</span><br><span class="line">force_local_data_ssl&#x3D;YES</span><br><span class="line">ssl_tlsv1&#x3D;YES</span><br><span class="line">ssl_sslv2&#x3D;NO</span><br><span class="line">ssl_sslv3&#x3D;NO</span><br><span class="line">rsa_cert_file&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.pem</span><br><span class="line">require_ssl_reuse&#x3D;no</span><br><span class="line">pasv_enable&#x3D;YES</span><br><span class="line">pasv_min_port&#x3D;20000</span><br><span class="line">pasv_max_port&#x3D;20001</span><br></pre></td></tr></table></figure>
<h4 id="4、重启vsftpd服务"><a href="#4、重启vsftpd服务" class="headerlink" title="4、重启vsftpd服务"></a>4、重启vsftpd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart vsftpd</span><br></pre></td></tr></table></figure>
<h4 id="5、默认linux自带的ftp-client不支持ssl协议，如果配置了ssl，使用ftp-client连接会报错"><a href="#5、默认linux自带的ftp-client不支持ssl协议，如果配置了ssl，使用ftp-client连接会报错" class="headerlink" title="5、默认linux自带的ftp client不支持ssl协议，如果配置了ssl，使用ftp client连接会报错"></a>5、默认linux自带的ftp client不支持ssl协议，如果配置了ssl，使用ftp client连接会报错</h4><p><img src="https://i.imgur.com/gklzknf.png" alt=""><br>可以使用第三方的surgeftp测试，下载方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget ftp:&#x2F;&#x2F;ftp.netwinsite.com&#x2F;pub&#x2F;surgeftp&#x2F;surgeftp_23f2_linux64.tar.gz</span><br></pre></td></tr></table></figure>
<p>解压之后，测试连接是否正常：<br><img src="https://i.imgur.com/8blhpQc.png" alt=""><br>也可以使用windows下的ftp软件测试，如FileZilla，配置方法如下：<br><img src="https://i.imgur.com/UUcMQL8.png" alt=""></p>
<h4 id="6、配置过程终于到的问题："><a href="#6、配置过程终于到的问题：" class="headerlink" title="6、配置过程终于到的问题："></a>6、配置过程终于到的问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">522 SSL connection failed; session reuse required: see require_ssl_reuse option in vsftpd.conf man page</span><br><span class="line">解决方法：</span><br><span class="line">查看vsftpd.conf配置文件是否配置了下面参数</span><br><span class="line">require_ssl_reuse&#x3D;no</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/12/vsftpd配置ssl/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/09/mysql-mgr解散集群并重新添加/"><span>[Mysql] mysql-mgr解散集群并重新加入集群</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/09/mysql-mgr解散集群并重新添加/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-09T09:21:00.000Z">
          2018-11-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、查看集群状态"><a href="#1、查看集群状态" class="headerlink" title="1、查看集群状态"></a>1、查看集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster &#x3D; dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、解散集群："><a href="#2、解散集群：" class="headerlink" title="2、解散集群："></a>2、解散集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.dissolve()</span><br><span class="line">The cluster still has active ReplicaSets.</span><br><span class="line">Please use cluster.dissolve(&#123;force: true&#125;) to deactivate replication</span><br><span class="line">and unregister the ReplicaSets from the cluster.</span><br><span class="line"></span><br><span class="line">The following replicasets are currently registered:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;topology&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;label&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.dissolve(&#123;force: true&#125;)</span><br><span class="line">WARNING: On instance &#39;dax-mysql-slave:3306&#39; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please set the &#39;group_replication_start_on_boot&#39; variable to &#39;OFF&#39; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">WARNING: On instance &#39;dax-mysql-master:3306&#39; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please set the &#39;group_replication_start_on_boot&#39; variable to &#39;OFF&#39; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">The cluster was successfully dissolved.</span><br><span class="line">Replication was disabled but user data was left intact.</span><br></pre></td></tr></table></figure>
<h4 id="3、查看集群信息已经被删掉了："><a href="#3、查看集群信息已经被删掉了：" class="headerlink" title="3、查看集群信息已经被删掉了："></a>3、查看集群信息已经被删掉了：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:54:  [mysql_innodb_cluster_metadata]&gt; select * from clusters;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="4、重新建立集群："><a href="#4、重新建立集群：" class="headerlink" title="4、重新建立集群："></a>4、重新建立集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; var cluster &#x3D; dba.createCluster(&#39;prodCluster&#39;);</span><br><span class="line">A new InnoDB cluster will be created on instance &#39;repl@dax-mysql-master:3306&#39;.</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-master:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-master</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">Creating InnoDB cluster &#39;prodCluster&#39; on &#39;repl@dax-mysql-master:3306&#39;...</span><br><span class="line">WARNING: On instance &#39;dax-mysql-master:3306&#39; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">Adding Seed Instance...</span><br><span class="line"></span><br><span class="line">Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</span><br><span class="line">At least 3 instances are needed for the cluster to be able to withstand up to</span><br><span class="line">one server failure.</span><br></pre></td></tr></table></figure>
<h4 id="5、-查看集群状态，现在只有一个节点信息"><a href="#5、-查看集群状态，现在只有一个节点信息" class="headerlink" title="5、 查看集群状态，现在只有一个节点信息"></a>5、 查看集群状态，现在只有一个节点信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、添加新的节点："><a href="#6、添加新的节点：" class="headerlink" title="6、添加新的节点："></a>6、添加新的节点：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cluster.addInstance(&#39;dax-mysql-slave:3306&#39;)</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.addInstance(&#39;dax-mysql-slave:3306&#39;)</span><br><span class="line">A new instance will be added to the InnoDB cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Please provide the password for &#39;root@dax-mysql-slave:3306&#39;: ********</span><br><span class="line">Adding instance to the cluster ...</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-slave:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-slave</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">WARNING: On instance &#39;dax-mysql-slave:3306&#39; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &#39;dax-mysql-master:3306&#39; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The instance &#39;root@dax-mysql-slave:3306&#39; was successfully added to the cluster.</span><br></pre></td></tr></table></figure>
<h4 id="7、查看集群状态，可以看到两个节点了："><a href="#7、查看集群状态，可以看到两个节点了：" class="headerlink" title="7、查看集群状态，可以看到两个节点了："></a>7、查看集群状态，可以看到两个节点了：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@db 17:14:  [mysql_innodb_cluster_metadata]&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@db 17:14:  [mysql_innodb_cluster_metadata]&gt; show status like &#39;%primary%&#39;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/09/mysql-mgr解散集群并重新添加/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/09/mysql-mgr单主模式切换为多主/"><span>[Mysql] mysql-mgr单主模式切换为多主，多主切换为单主</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/09/mysql-mgr单主模式切换为多主/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-09T03:54:00.000Z">
          2018-11-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、停止组复制-所有节点执行-："><a href="#1、停止组复制-所有节点执行-：" class="headerlink" title="1、停止组复制(所有节点执行)："></a>1、停止组复制(所有节点执行)：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop group_replication; </span><br><span class="line">mysql&gt; set global group_replication_single_primary_mode&#x3D;OFF; </span><br><span class="line">mysql&gt; set global group_replication_enforce_update_everywhere_checks&#x3D;ON;</span><br></pre></td></tr></table></figure>
<h4 id="2、随便选择某个节点执行"><a href="#2、随便选择某个节点执行" class="headerlink" title="2、随便选择某个节点执行"></a>2、随便选择某个节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group&#x3D;ON; </span><br><span class="line">mysql&gt; START GROUP_REPLICATION; </span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group&#x3D;OFF;</span><br></pre></td></tr></table></figure>
<h4 id="3、其他节点执行"><a href="#3、其他节点执行" class="headerlink" title="3、其他节点执行"></a>3、其他节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>
<p>查看节点启动报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018-11-08T14:00:52.098660Z 56 [ERROR] Plugin group_replication reported: &#39;There was an error when connecting to the donor server. Please check that group_replication_recovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.&#39;</span><br><span class="line">2018-11-08T14:00:52.098689Z 56 [ERROR] Plugin group_replication reported: &#39;For details please check performance_schema.replication_connection_status table and error log messages of Slave I&#x2F;O for channel group_replication_recovery.&#39;</span><br></pre></td></tr></table></figure>
<p>手动配置复制信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_user&#x3D;&#39;repl&#39;,master_password&#x3D;&#39;12345678&#39; for channel &#39;group_replication_recovery&#39;;</span><br></pre></td></tr></table></figure>
<p>再次启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>

<h4 id="4、查看组信息，所有节点的信息正常，所有节点均为主："><a href="#4、查看组信息，所有节点的信息正常，所有节点均为主：" class="headerlink" title="4、查看组信息，所有节点的信息正常，所有节点均为主："></a>4、查看组信息，所有节点的信息正常，所有节点均为主：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br></pre></td></tr></table></figure>

<h4 id="5、查看集群状态"><a href="#5、查看集群状态" class="headerlink" title="5、查看集群状态"></a>5、查看集群状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster &#x3D; dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Single-Master) does not match the current Group Replication configuration (Multi-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure>
<p>提示cluster 拓扑类型为单主与当前的mgr(多主)不匹配，使用cluster.rescan()参数重新扫描：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan()</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次查看集群状态仍然报错：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Single-Master) does not match the current Group Replication configuration (Multi-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure><br>尝试删除集群元数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dba.dropMetadataSchema();</span><br><span class="line">Are you sure you want to remove the Metadata? [y&#x2F;N]: y</span><br><span class="line">Metadata Schema successfully removed.</span><br></pre></td></tr></table></figure>
<p>重新创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var cluster &#x3D; dba.createCluster(&#39;prodCluster&#39;, &#123;adoptFromGR: true ,force: true&#125;);</span><br></pre></td></tr></table></figure>
<p>报错提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Plugin group_replication reported: &#39;Table instances has a foreign key with &#39;CASCADE&#39; clause. This is not compatible with Group Replication&#39;</span><br></pre></td></tr></table></figure>
<p>创建集群会在mysql_innodb_cluster_metadata库下建立一个instances的表，在单主模式下创建集群没有外键级联的报错问题，在多主模式下提示有外键级联的问题，表内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;instances&#96; (</span><br><span class="line">  &#96;instance_id&#96; int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;host_id&#96; int(10) unsigned NOT NULL,</span><br><span class="line">  &#96;replicaset_id&#96; int(10) unsigned DEFAULT NULL,</span><br><span class="line">  &#96;mysql_server_uuid&#96; varchar(40) NOT NULL,</span><br><span class="line">  &#96;instance_name&#96; varchar(256) NOT NULL,</span><br><span class="line">  &#96;role&#96; enum(&#39;HA&#39;,&#39;readScaleOut&#39;) NOT NULL,</span><br><span class="line">  &#96;weight&#96; float DEFAULT NULL,</span><br><span class="line">  &#96;addresses&#96; json NOT NULL,</span><br><span class="line">  &#96;attributes&#96; json DEFAULT NULL,</span><br><span class="line">  &#96;version_token&#96; int(10) unsigned DEFAULT NULL,</span><br><span class="line">  &#96;description&#96; text,</span><br><span class="line">  PRIMARY KEY (&#96;instance_id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;mysql_server_uuid&#96; (&#96;mysql_server_uuid&#96;),</span><br><span class="line">  UNIQUE KEY &#96;instance_name&#96; (&#96;instance_name&#96;),</span><br><span class="line">  KEY &#96;host_id&#96; (&#96;host_id&#96;),</span><br><span class="line">  KEY &#96;instances_ibfk_2&#96; (&#96;replicaset_id&#96;),</span><br><span class="line">  CONSTRAINT &#96;instances_ibfk_1&#96; FOREIGN KEY (&#96;host_id&#96;) REFERENCES &#96;hosts&#96; (&#96;host_id&#96;),</span><br><span class="line">  CONSTRAINT &#96;instances_ibfk_2&#96; FOREIGN KEY (&#96;replicaset_id&#96;) REFERENCES &#96;replicasets&#96; (&#96;replicaset_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4</span><br></pre></td></tr></table></figure>
<p>查阅官方文档有提示说多主模式下存在这个<a href="https://bugs.mysql.com/bug.php?id=91972" target="_blank" rel="noopener">bug</a>，将该表下的外键约束去掉：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE &#96;mysql_innodb_cluster_metadata&#96;.&#96;instances&#96; DROP FOREIGN KEY &#96;instances_ibfk_1&#96;;</span><br><span class="line">ALTER TABLE &#96;mysql_innodb_cluster_metadata&#96;.&#96;instances&#96; DROP FOREIGN KEY &#96;instances_ibfk_2&#96;;</span><br></pre></td></tr></table></figure>
<p>重建添加外键使用下面的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE &#96;mysql_innodb_cluster_metadata&#96;.&#96;instances&#96; ADD CONSTRAINT &#96;instances_ibfk_1&#96; FOREIGN KEY (&#96;host_id&#96;) REFERENCES &#96;hosts&#96; (&#96;host_id&#96;);</span><br><span class="line">ALTER TABLE &#96;mysql_innodb_cluster_metadata&#96;.&#96;instances&#96; ADD CONSTRAINT &#96;instances_ibfk_2&#96; </span><br><span class="line">FOREIGN KEY (&#96;replicaset_id&#96;) REFERENCES &#96;replicasets&#96; (&#96;replicaset_id&#96;);</span><br></pre></td></tr></table></figure>
<p>将外键约束删除之后，重新创建集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; var cluster &#x3D; dba.createCluster(&#39;prodCluster&#39;, &#123;adoptFromGR: true ,force: true&#125;);</span><br><span class="line">A new InnoDB cluster will be created based on the existing replication group on instance &#39;repl@dax-mysql-master:3306&#39;.</span><br><span class="line"></span><br><span class="line">Creating InnoDB cluster &#39;prodCluster&#39; on &#39;repl@dax-mysql-master:3306&#39;...</span><br><span class="line">Adding Instance &#39;dax-mysql-slave:3306&#39;...</span><br><span class="line">Adding Instance &#39;dax-mysql-master:3306&#39;...</span><br><span class="line"></span><br><span class="line">Cluster successfully created based on existing replication group.</span><br></pre></td></tr></table></figure>
<p>集群创建成功，查看集群状态,两个节点均为读写模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主："><a href="#6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主：" class="headerlink" title="6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主："></a>6、mysql-mgr多主模式切换成功，现在将模式从多主切换为单主：</h4><h4 id="7、所有节点执行"><a href="#7、所有节点执行" class="headerlink" title="7、所有节点执行"></a>7、所有节点执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop group_replication; </span><br><span class="line">mysql&gt; set global group_replication_enforce_update_everywhere_checks&#x3D;OFF; </span><br><span class="line">mysql&gt; set global group_replication_single_primary_mode&#x3D;ON;</span><br></pre></td></tr></table></figure>
<h4 id="8、主节点（dax-mysql-master）执行"><a href="#8、主节点（dax-mysql-master）执行" class="headerlink" title="8、主节点（dax-mysql-master）执行"></a>8、主节点（dax-mysql-master）执行</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL group_replication_bootstrap_group&#x3D;ON; </span><br><span class="line">START GROUP_REPLICATION; </span><br><span class="line">SET GLOBAL group_replication_bootstrap_group&#x3D;OFF;</span><br></pre></td></tr></table></figure>
<h4 id="9、从节点执行："><a href="#9、从节点执行：" class="headerlink" title="9、从节点执行："></a>9、从节点执行：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START GROUP_REPLICATION;</span><br></pre></td></tr></table></figure>
<h4 id="10、查看MGR组信息-所有节点同步正常："><a href="#10、查看MGR组信息-所有节点同步正常：" class="headerlink" title="10、查看MGR组信息,所有节点同步正常："></a>10、查看MGR组信息,所有节点同步正常：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST      | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | bddd9c32-8fee-11e8-ac79-525400edbe8d | dax-mysql-slave  |        3306 | ONLINE       |</span><br><span class="line">| group_replication_applier | d5bd8edd-9a1d-11e8-993e-525400578639 | dax-mysql-master |        3306 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+------------------+-------------+--------------+</span><br></pre></td></tr></table></figure>
<p>查看当前主节点信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show status like &#39;%primary%&#39;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | d5bd8edd-9a1d-11e8-993e-525400578639 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<h4 id="11、登录mysql-shell查看集群信息："><a href="#11、登录mysql-shell查看集群信息：" class="headerlink" title="11、登录mysql-shell查看集群信息："></a>11、登录mysql-shell查看集群信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster &#x3D; dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">&lt;Cluster:prodCluster&gt;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Multi-Master) does not match the current Group Replication configuration (Single-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan()</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">Cluster.status: The InnoDB Cluster topology type (Multi-Master) does not match the current Group Replication configuration (Single-Master). Please use &lt;cluster&gt;.rescan() or change the Group Replication configuration accordingly. (RuntimeError)</span><br></pre></td></tr></table></figure>
<p>跟多主切换为单主报错相同，尝试删除集群元数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dba.dropMetadataSchema();</span><br><span class="line">Are you sure you want to remove the Metadata? [y&#x2F;N]: y</span><br><span class="line">Metadata Schema successfully removed.</span><br></pre></td></tr></table></figure>
<p>重新创建集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; var cluster &#x3D; dba.createCluster(&#39;prodCluster&#39;, &#123;adoptFromGR: true&#125;);</span><br><span class="line">A new InnoDB cluster will be created based on the existing replication group on instance &#39;repl@dax-mysql-master:3306&#39;.</span><br><span class="line"></span><br><span class="line">Creating InnoDB cluster &#39;prodCluster&#39; on &#39;repl@dax-mysql-master:3306&#39;...</span><br><span class="line">Adding Seed Instance...</span><br><span class="line">Adding Instance &#39;dax-mysql-slave:3306&#39;...</span><br><span class="line"></span><br><span class="line">Cluster successfully created based on existing replication group.</span><br></pre></td></tr></table></figure>
<p>集群创建成功，查看集群状态为一主一从模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt;  cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/09/mysql-mgr单主模式切换为多主/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/"><span>[Mysql] mysql-mgr（双节点)依次修改server-id</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-09T02:18:00.000Z">
          2018-11-09
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、查看从节点server-id信息："><a href="#1、查看从节点server-id信息：" class="headerlink" title="1、查看从节点server-id信息："></a>1、查看从节点server-id信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@db 16:55:  [(none)]&gt; show variables like &quot;%server%&quot;;</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| Variable_name                                     | Value                                |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br><span class="line">| character_set_server                              | utf8mb4                              |</span><br><span class="line">| collation_server                                  | utf8mb4_general_ci                   |</span><br><span class="line">| group_replication_recovery_ssl_verify_server_cert | OFF                                  |</span><br><span class="line">| innodb_ft_server_stopword_table                   |                                      |</span><br><span class="line">| server_id                                         | 3306102                              |</span><br><span class="line">| server_id_bits                                    | 32                                   |</span><br><span class="line">| server_uuid                                       | bddd9c32-8fee-11e8-ac79-525400edbe8d |</span><br><span class="line">+---------------------------------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<h4 id="2、登录mysql-shell查看集群信息："><a href="#2、登录mysql-shell查看集群信息：" class="headerlink" title="2、登录mysql-shell查看集群信息："></a>2、登录mysql-shell查看集群信息：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster &#x3D; dba.getCluster(&quot;prodCluster&quot;)</span><br><span class="line">MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将从节点移除集群：<br>MySQL  dax-mysql-master:3306  JS &gt; cluster.removeInstance(‘dax-mysql-slave:3306’)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">The instance will be removed from the InnoDB cluster. Depending on the </span><br><span class="line">instance being the Seed or not, the Metadata session might become invalid. </span><br><span class="line">If so, please start a new session to the Metadata Storage R&#x2F;W instance.</span><br><span class="line"></span><br><span class="line">WARNING: On instance &#39;dax-mysql-master:3306&#39; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &#39;dax-mysql-slave:3306&#39; configuration cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please set the &#39;group_replication_start_on_boot&#39; variable to &#39;OFF&#39; in the server configuration file, otherwise it might rejoin the cluster upon restart.</span><br><span class="line">The instance &#39;dax-mysql-slave:3306&#39; was successfully removed from the cluster.</span><br><span class="line"></span><br><span class="line">WARNING: The &#39;group_replication_start_on_boot&#39; variable must be set to &#39;OFF&#39; in the server configuration file, otherwise it might silently rejoin the cluster upon restart.</span><br></pre></td></tr></table></figure>
<p>重新扫描集群信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.rescan();</span><br><span class="line">Rescanning the cluster...</span><br><span class="line"></span><br><span class="line">Result of the rescanning operation:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;newlyDiscoveredInstances&quot;: [], </span><br><span class="line">        &quot;unavailableInstances&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看集群信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、从节点修改server-id，并重启库，之后将从节点加入集群："><a href="#3、从节点修改server-id，并重启库，之后将从节点加入集群：" class="headerlink" title="3、从节点修改server-id，并重启库，之后将从节点加入集群："></a>3、从节点修改server-id，并重启库，之后将从节点加入集群：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql-shell &gt; cluster.addInstance(&#39;dax-mysql-slave:3306&#39;)</span><br><span class="line">A new instance will be added to the InnoDB cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Please provide the password for &#39;root@dax-mysql-slave:3306&#39;: ********</span><br><span class="line">Adding instance to the cluster ...</span><br><span class="line"></span><br><span class="line">Validating instance at dax-mysql-slave:3306...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as dax-mysql-slave</span><br><span class="line">WARNING: The following tables do not have a Primary Key or equivalent column: </span><br><span class="line">aaaa.test</span><br><span class="line"></span><br><span class="line">Group Replication requires tables to use InnoDB and have a PRIMARY KEY or PRIMARY KEY Equivalent (non-null unique key). Tables that do not follow these requirements will be readable but not updateable when used with Group Replication. If your applications make updates (INSERT, UPDATE or DELETE) to these tables, ensure they use the InnoDB storage engine and have a PRIMARY KEY or PRIMARY KEY Equivalent.</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">WARNING: On instance &#39;dax-mysql-slave:3306&#39; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">WARNING: On instance &#39;dax-mysql-master:3306&#39; membership change cannot be persisted since MySQL version 5.7.22 does not support the SET PERSIST command (MySQL version &gt;&#x3D; 8.0.5 required). Please use the &lt;Dba&gt;.configureLocalInstance command locally to persist the changes.</span><br><span class="line">The instance &#39;root@dax-mysql-slave:3306&#39; was successfully added to the cluster.</span><br></pre></td></tr></table></figure>
<p>查看集群信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  dax-mysql-master:3306  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;DISABLED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;dax-mysql-master:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-master:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;dax-mysql-slave:3306&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;dax-mysql-slave:3306&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R&#x2F;O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;mysql:&#x2F;&#x2F;repl@dax-mysql-master:3306&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他节点修改方法如上。</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/09/mysql-mgr（双节点依次修改server-id)/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/07/oracle本地表空间在uniform、system等不同模式下分配extent方式/"><span>[Oracle] oracle本地表空间在uniform、system等不同模式下分配extent方式</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/07/oracle本地表空间在uniform、system等不同模式下分配extent方式/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-07T10:51:00.000Z">
          2018-11-07
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、表空间和表都使用oracle默认参数"><a href="#1、表空间和表都使用oracle默认参数" class="headerlink" title="1、表空间和表都使用oracle默认参数"></a>1、表空间和表都使用oracle默认参数</h4><p>查看scott用户默认表空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select username,default_tablespace from dba_users where username&#x3D;&#39;SCOTT&#39;;</span><br><span class="line">USERNAME		       DEFAULT_TABLESPACE</span><br><span class="line">------------------------------ ------------------------------</span><br><span class="line">SCOTT			       USERS</span><br></pre></td></tr></table></figure>
<p>查看users表空间初始化extent大小：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select TABLESPACE_NAME,BLOCK_SIZE,INITIAL_EXTENT,NEXT_EXTENT,MIN_EXTENTS,MAX_EXTENTS,EXTENT_MANAGEMENT,ALLOCATION_TYPE from user_tablespaces where tablespace_name&#x3D;&#39;USERS&#39;;</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME 	       BLOCK_SIZE INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS EXTENT_MAN ALLOCATIO</span><br><span class="line">------------------------------ ---------- -------------- ----------- ----------- ----------- ---------- ---------</span><br><span class="line">USERS				     8192	   65536		       1  2147483645 LOCAL	SYSTEM</span><br></pre></td></tr></table></figure>
<p>查看当前数据库块大小：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show parameter db_block_size;</span><br><span class="line"></span><br><span class="line">NAME				     TYPE	 VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">db_block_size			     integer	 8192</span><br></pre></td></tr></table></figure>

<p>创建测试表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">11:43:49 SCOTT@ boston&gt;  create table t1 as select * from emp where 0&#x3D;1;</span><br><span class="line">Table created.</span><br><span class="line">表数据为空，查看是否有extent区在：</span><br><span class="line">11:43:54 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>
<p>向t1表内插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">11:43:50 SCOTT@ boston&gt;  insert into t1  select * from emp;</span><br><span class="line">14 rows created.</span><br></pre></td></tr></table></figure>
<p>查看已分配出一个8个block的extent：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">11:43:55 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">Elapsed: 00:00:00.50</span><br></pre></td></tr></table></figure>
<p>因数据量太小，只分配了一个区，需插入大量数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">12:00:40 SCOTT@ boston&gt;  insert into t1  select * from t1;</span><br><span class="line">42 rows created.</span><br><span class="line">...</span><br><span class="line">12:00:57 SCOTT@ boston&gt; &#x2F;</span><br><span class="line">2688 rows created.</span><br><span class="line">Elapsed: 00:00:00.02</span><br></pre></td></tr></table></figure>
<p>再次查看extent，当分配16个extent之后，数据量达到了16<em>8</em>8/1024=1M，当达到1m之后，在分配下一个extent会直接分配128个块，大小分为128*8/1024=1M：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">12:01:01 SYS@ boston&gt;  select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">...</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br></pre></td></tr></table></figure>
<p>再次插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">12:28:36 SCOTT@ boston&gt; &#x2F;</span><br><span class="line">5376 rows created.</span><br><span class="line">Elapsed: 00:00:00.02</span><br><span class="line">....</span><br><span class="line">12:30:11 SCOTT@ boston&gt; &#x2F;</span><br><span class="line">688128 rows created.</span><br></pre></td></tr></table></figure>
<p>查看extent情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">12:30:14 SYS@ boston&gt;select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">....</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br><span class="line">...</span><br><span class="line">T1											  78	      4       8320	  128</span><br><span class="line">T1											  79	      4       8448	 1024</span><br><span class="line">80 rows selected.</span><br></pre></td></tr></table></figure>
<p>当表数据量达到64M的时候，再次分配下一个extent会直接分配1024个block，大小为64M。</p>
<p>手动对表t1分配extent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">13:35:52 SCOTT@ boston&gt; alter table t1 allocate extent;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.49</span><br><span class="line">14:18:45 SCOTT@ boston&gt; &#x2F;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.07</span><br><span class="line">14:19:28 SCOTT@ boston&gt; &#x2F;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.06</span><br></pre></td></tr></table></figure>
<p>查看extent情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">14:19:06 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">...</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br><span class="line">...</span><br><span class="line">T1											  78	      4       8320	  128</span><br><span class="line">T1											  79	      4       8448	 1024</span><br><span class="line">T1											  80	      4       9472	  128</span><br><span class="line">T1											  81	      4       9600	  128</span><br><span class="line">T1											  82	      4       9728	  128</span><br><span class="line">83 rows selected.</span><br><span class="line">Elapsed: 00:00:00.45</span><br></pre></td></tr></table></figure>
<p>使用alter table ** allocate extent手动分配的区大小为1M。</p>
<p>再次对表插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">14:19:30 SCOTT@ boston&gt;  insert into t1  select * from t1;</span><br><span class="line">1376256 rows created.</span><br><span class="line">Elapsed: 00:00:12.03</span><br></pre></td></tr></table></figure>
<p>查看extent情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">14:20:34 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      4        176	    8</span><br><span class="line">...</span><br><span class="line">T1											  15	      4        296	    8</span><br><span class="line">T1											  16	      4        384	  128</span><br><span class="line">...</span><br><span class="line">T1											  78	      4       8320	  128</span><br><span class="line">T1											  79	      4       8448	 1024</span><br><span class="line">T1											  80	      4       9472	  128</span><br><span class="line">T1											  81	      4       9600	  128</span><br><span class="line">T1											  82	      4       9728	  128</span><br><span class="line">T1											  83	      4       9856	 1024</span><br><span class="line">...</span><br><span class="line">T1											  88	      4      14976	 1024</span><br><span class="line">89 rows selected.</span><br></pre></td></tr></table></figure>
<p>插入数据分配的extent大小均为64M。</p>
<h4 id="2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）："><a href="#2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）：" class="headerlink" title="2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）："></a>2、表空间空间使用默认参数，表参数自定义（INITIAL参数小于65536）：</h4><p>创建测试表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table t2 as select * from emp where 0&#x3D;1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t2 MOVE STORAGE ( INITIAL 20k NEXT 40k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure>
<p>查看表参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name &#x3D; &#39;T2&#39;;</span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">	 24576	     40960</span><br></pre></td></tr></table></figure>
<p>表数据为空，查看是否有extent区在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T2&#39;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>
<p>向表空插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from emp;</span><br><span class="line">insert into t2 select * from t2;</span><br></pre></td></tr></table></figure>
<p>查看extent情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T2&#39;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      4        168	    8</span><br></pre></td></tr></table></figure>
<p>分配出来的extent最少8个块。<br>多次插入数据查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T2&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      4        168	    8</span><br><span class="line">...</span><br><span class="line">T2											  15	      4      17184	    8</span><br><span class="line">T2											  16	      4      17280	  128</span><br><span class="line">...</span><br><span class="line">T2											  78	      4       7936	  128</span><br><span class="line">T2											  79	      4       8064	 1024</span><br><span class="line">T2											  80	      4       9088	 1024</span><br><span class="line">T2											  81	      4      10112	 1024</span><br><span class="line">T2											  82	      4      11136	 1024</span><br></pre></td></tr></table></figure>
<p>extent分配增长情况为（64k-1m-64m-…)。</p>
<h4 id="3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）："><a href="#3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）：" class="headerlink" title="3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）："></a>3、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next小于64k）：</h4><p>创建测试表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> create table t3 as select * from emp where 0&#x3D;1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t3 MOVE STORAGE ( INITIAL 100k NEXT 40k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure>
<p>查看表参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name &#x3D; &#39;T3&#39;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">	106496	     40960</span><br></pre></td></tr></table></figure>
<p>表数据为空，查看是否有extent区在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T3&#39;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>
<p>向表空插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t3 select * from emp;</span><br></pre></td></tr></table></figure>
<p>一次分配出来两个extent，每个extent8个block：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T3&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T3											   0	      4        176	    8</span><br><span class="line">T3											   1	      4        184	    8</span><br></pre></td></tr></table></figure>
<p>再次插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t3 select * from t3;</span><br></pre></td></tr></table></figure>
<p>不要插入太多数据，查看下一次分配的extent为1个，占8个块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T3&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T3											   0	      4        208	    8</span><br><span class="line">T3											   1	      4        216	    8</span><br><span class="line">T3											   2	      4        224	    8</span><br></pre></td></tr></table></figure>
<p>再次插入数据，extent增长情况（64k-1m-64m）</p>
<h4 id="4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）："><a href="#4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）：" class="headerlink" title="4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）："></a>4、表空间空间使用默认参数，表参数自定义（INITIAL参数大于64k，next大于64k）：</h4><p>创建测试表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> create table t4 as select * from emp where 0&#x3D;1;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">ALTER TABLE t4 MOVE STORAGE ( INITIAL 100k NEXT 140k) TABLESPACE users;</span><br><span class="line">Table altered.</span><br><span class="line">Elapsed: 00:00:00.23</span><br></pre></td></tr></table></figure>
<p>查看表参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">14:31:43 SCOTT@ boston&gt; SELECT initial_extent, next_extent,  min_extents, max_extents, pct_increase, blocks, sample_size FROM   user_tables WHERE  table_name &#x3D; &#39;T4&#39;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">	106496	    147456</span><br></pre></td></tr></table></figure>
<p>表数据为空，查看是否有extent区在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T4&#39;;</span><br><span class="line">no rows selected</span><br></pre></td></tr></table></figure>
<p>向表空插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t4 select * from emp;</span><br></pre></td></tr></table></figure>
<p>一次分配出来两个extent，每个extent8个block：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T4&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T4											   0	      4        176	    8</span><br><span class="line">T4											   1	      4        184	    8</span><br></pre></td></tr></table></figure>
<p>再次插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t4 select * from t4;</span><br></pre></td></tr></table></figure>
<p>不要插入太多数据，查看下一次分配的extent为1个，占8个块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T4&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T4											   0	      4        176	    8</span><br><span class="line">T4											   1	      4        184	    8</span><br><span class="line">T4											   2	      4        192	    8</span><br></pre></td></tr></table></figure>
<p>再次插入数据，extent增长情况（64k-1m-64m）</p>
<h4 id="5、创建表空间使用并设置extent大小，统一为2m："><a href="#5、创建表空间使用并设置extent大小，统一为2m：" class="headerlink" title="5、创建表空间使用并设置extent大小，统一为2m："></a>5、创建表空间使用并设置extent大小，统一为2m：</h4><p>创建测试表空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create tablespace test datafile &#39;&#x2F;data&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;boston&#x2F;test01.dbf&#39; size 100M extent management local uniform size 2m;</span><br></pre></td></tr></table></figure>
<p>查看表空间参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">15:28:39 SYS@ boston&gt; select TABLESPACE_NAME,BLOCK_SIZE,INITIAL_EXTENT,NEXT_EXTENT,MIN_EXTENTS,MAX_EXTENTS,EXTENT_MANAGEMENT,ALLOCATION_TYPE from user_tablespaces where tablespace_name&#x3D;&#39;TEST&#39;;</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME 	       BLOCK_SIZE INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS EXTENT_MAN ALLOCATIO</span><br><span class="line">------------------------------ ---------- -------------- ----------- ----------- ----------- ---------- ---------</span><br><span class="line">TEST				     8192	 2097152     2097152	       1  2147483645 LOCAL	UNIFORM</span><br></pre></td></tr></table></figure>

<h5 id="6、表空间使用上面创建的test表空间，表参数默认："><a href="#6、表空间使用上面创建的test表空间，表参数默认：" class="headerlink" title="6、表空间使用上面创建的test表空间，表参数默认："></a>6、表空间使用上面创建的test表空间，表参数默认：</h5><p>创建测试表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table t1;</span><br><span class="line">create table t1 as select * from emp where 0&#x3D;1;</span><br><span class="line">alter table t1 move tablespace test;</span><br></pre></td></tr></table></figure>
<p>查看表t1参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent,next_extent,min_extents,max_extents,pct_increase,blocks,sample_size FROM user_tables WHERE  table_name &#x3D; &#39;T1&#39;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">       2097152	   2097152	     1	2147483645	      0</span><br></pre></td></tr></table></figure>
<p>表数据为空，查看是否有extent区在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line">15:32:51 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line">no rows selected</span><br><span class="line">Elapsed: 00:00:00.04</span><br></pre></td></tr></table></figure>
<p>插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">15:33:16 SCOTT@ boston&gt; insert into t1  select * from emp;</span><br><span class="line">14 rows created.</span><br></pre></td></tr></table></figure>
<p>为t1表分配了一个2m大小的extent：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">15:32:54 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      5        128	  256</span><br></pre></td></tr></table></figure>
<p>批量插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">15:48:07 SYS@ boston&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T1&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T1											   0	      5        128	  256</span><br><span class="line">...</span><br><span class="line">T1											  80	      5      20608	  256</span><br><span class="line">81 rows selected.</span><br></pre></td></tr></table></figure>
<p>不管插入多少数据，因为设置了统一大小为2m，一个extent永远都是256个块。</p>
<h5 id="7、表空间使用上面创建的test表空间，表参数自定义："><a href="#7、表空间使用上面创建的test表空间，表参数自定义：" class="headerlink" title="7、表空间使用上面创建的test表空间，表参数自定义："></a>7、表空间使用上面创建的test表空间，表参数自定义：</h5><p>创建测试表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drop table t2;</span><br><span class="line">create table t2 as select * from emp where 0&#x3D;1;</span><br><span class="line">ALTER TABLE t2 MOVE STORAGE ( INITIAL 5m NEXT 5m) TABLESPACE test;</span><br></pre></td></tr></table></figure>
<p>查看表t2参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT initial_extent,next_extent,min_extents,max_extents,pct_increase,blocks,sample_size FROM user_tables WHERE  table_name &#x3D; &#39;T2&#39;;</span><br><span class="line"></span><br><span class="line">INITIAL_EXTENT NEXT_EXTENT MIN_EXTENTS MAX_EXTENTS PCT_INCREASE     BLOCKS SAMPLE_SIZE</span><br><span class="line">-------------- ----------- ----------- ----------- ------------ ---------- -----------</span><br><span class="line">       5242880	   5242880</span><br></pre></td></tr></table></figure>
<p>表数据为空，查看是否有extent区在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T2&#39;;</span><br><span class="line">no rows selected</span><br><span class="line">Elapsed: 00:00:00.11</span><br></pre></td></tr></table></figure>
<p>插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from emp;</span><br></pre></td></tr></table></figure>
<p>因为初始化设置为5m，而每个extent大小统一为2m，因此分配出三个extent：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T2&#39;;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      5       1920	  256</span><br><span class="line">T2											   1	      5       2176	  256</span><br><span class="line">T2											   2	      5       2432	  256</span><br></pre></td></tr></table></figure>
<p>再次插入数据，一次性不要插入太多：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into t2 select * from t2;</span><br><span class="line">...</span><br><span class="line">insert into t2 (select * from t2 where rownum &lt; 10000);</span><br></pre></td></tr></table></figure>
<p>当前三个extent用满之后再次分配extent时，分配1个extent，大小为2m。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID,BLOCKS from dba_extents where OWNER&#x3D;&#39;SCOTT&#39; AND SEGMENT_NAME&#x3D;&#39;T2&#39;;</span><br><span class="line">SEGMENT_NAME									   EXTENT_ID	FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line">--------------------------------------------------------------------------------- ---------- ---------- ---------- ----------</span><br><span class="line">T2											   0	      5        640	  256</span><br><span class="line">T2											   1	      5        896	  256</span><br><span class="line">T2											   2	      5       1152	  256</span><br><span class="line">T2											   3	      5       1408	  256</span><br></pre></td></tr></table></figure>

<h4 id="8、测试总结"><a href="#8、测试总结" class="headerlink" title="8、测试总结"></a>8、测试总结</h4><p>在本地管理表空间的模式下，oracle分配extent，会根据initial指定的参数分配（按相应的倍数），但是next指定的值会被忽略。官方文档如下所示：<br><img src="https://i.imgur.com/ZsQ7zP1.png" alt=""><br><img src="https://i.imgur.com/hcElxSO.png" alt=""></p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/oracle/">oracle</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/07/oracle本地表空间在uniform、system等不同模式下分配extent方式/"><span>点击阅读</span></a></h3>
    
  
</article>





  <article class="article-container ">

  
    
    <h3 class="article-title"><a href="/2018/11/06/centos安装vsftp/"><span>[Linux] centos安装vsftp</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/11/06/centos安装vsftp/" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-06T14:49:30.000Z">
          2018-11-06
        </time>
      </a>
    </span>
    <br />
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h4 id="1、检查vsftp是否安装，如果没有yum安装vsftp："><a href="#1、检查vsftp是否安装，如果没有yum安装vsftp：" class="headerlink" title="1、检查vsftp是否安装，如果没有yum安装vsftp："></a>1、检查vsftp是否安装，如果没有yum安装vsftp：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa| grep vsftpd</span><br><span class="line">yum install vsftpd -y</span><br></pre></td></tr></table></figure>

<h4 id="2、创建用户："><a href="#2、创建用户：" class="headerlink" title="2、创建用户："></a>2、创建用户：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adduser -s &#x2F;sbin&#x2F;nologin -d &#x2F;var&#x2F;ftp&#x2F;ftp1 ftp1 </span><br><span class="line">修改用户名：</span><br><span class="line">passwd ftp1</span><br></pre></td></tr></table></figure>
<h4 id="3、修改配置文件："><a href="#3、修改配置文件：" class="headerlink" title="3、修改配置文件："></a>3、修改配置文件：</h4><p>cat /etc/vsftpd/vsftpd.conf |grep -v ‘^#’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#禁止匿名用户登录</span><br><span class="line">anonymous_enable&#x3D;NO</span><br><span class="line">local_enable&#x3D;YES</span><br><span class="line">write_enable&#x3D;YES</span><br><span class="line">local_umask&#x3D;022</span><br><span class="line">dirmessage_enable&#x3D;YES</span><br><span class="line">xferlog_enable&#x3D;YES</span><br><span class="line">connect_from_port_20&#x3D;YES</span><br><span class="line">xferlog_std_format&#x3D;YES</span><br><span class="line">#不允许chroot_list下的用户访问其他目录：</span><br><span class="line">chroot_list_file&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;chroot_list</span><br><span class="line">chroot_local_user&#x3D;YES</span><br><span class="line">chroot_list_enable&#x3D;NO</span><br><span class="line">listen&#x3D;NO</span><br><span class="line">listen_ipv6&#x3D;YES</span><br><span class="line"></span><br><span class="line">pam_service_name&#x3D;vsftpd</span><br><span class="line">#只允许vsftpd.user_list文件下的用户登录：</span><br><span class="line">userlist_enable&#x3D;YES</span><br><span class="line">userlist_deny&#x3D;NO</span><br><span class="line">userlist_file&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.user_list</span><br><span class="line">tcp_wrappers&#x3D;YES</span><br><span class="line">allow_writeable_chroot&#x3D;YES</span><br></pre></td></tr></table></figure>

<h4 id="4、添加访问用户："><a href="#4、添加访问用户：" class="headerlink" title="4、添加访问用户："></a>4、添加访问用户：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.user_list</span><br><span class="line">ftp1</span><br><span class="line"></span><br><span class="line">cat &#x2F;etc&#x2F;vsftpd&#x2F;chroot_list</span><br><span class="line">ftp1</span><br></pre></td></tr></table></figure>
<h4 id="5、启动，查看ftp服务状态"><a href="#5、启动，查看ftp服务状态" class="headerlink" title="5、启动，查看ftp服务状态"></a>5、启动，查看ftp服务状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd status</span><br><span class="line">service vsftpd start</span><br><span class="line">service vsftpd stop</span><br><span class="line">service vsftpd restart</span><br></pre></td></tr></table></figure>
<h4 id="6、客户端安装ftp："><a href="#6、客户端安装ftp：" class="headerlink" title="6、客户端安装ftp："></a>6、客户端安装ftp：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ftp</span><br></pre></td></tr></table></figure>
<p>连接到ftp-server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; ftp *.*.*.*</span><br></pre></td></tr></table></figure>

<h4 id="7、配置过程遇到的问题："><a href="#7、配置过程遇到的问题：" class="headerlink" title="7、配置过程遇到的问题："></a>7、配置过程遇到的问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">500 OOPS: vsftpd: refusing to run with writable root inside chroot ()</span><br><span class="line">查看配置文件该行参数是否配置：</span><br><span class="line">allow_writeable_chroot&#x3D;YES</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">500 OOPS: chroot</span><br><span class="line">Login failed.</span><br><span class="line">421 Service not available, remote server has closed connection</span><br><span class="line">检查selinux是否为enforcing状态，并修改：</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ftp vsftpd 530 login incorrect</span><br><span class="line">解决方法：</span><br><span class="line">1.检查密码是否正常。</span><br><span class="line">2.检查&#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.conf配置：</span><br><span class="line">pam_service_name&#x3D;vsftpd</span><br><span class="line">userlist_enable&#x3D;YES</span><br><span class="line">userlist_deny&#x3D;NO</span><br><span class="line">userlist_file&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;vsftpd.user_list</span><br><span class="line">3.检查&#x2F;etc&#x2F;pam.d&#x2F;vsftpd配置：</span><br><span class="line">#%PAM-1.0</span><br><span class="line">session    optional     pam_keyinit.so    force revoke</span><br><span class="line">auth       required	pam_listfile.so item&#x3D;user sense&#x3D;deny file&#x3D;&#x2F;etc&#x2F;vsftpd&#x2F;ftpusers onerr&#x3D;succeed</span><br><span class="line">auth       required	pam_shells.so</span><br><span class="line">auth       include	password-auth</span><br><span class="line">account    include	password-auth</span><br><span class="line">session    required     pam_loginuid.so</span><br><span class="line">session    include	password-auth</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/linux/">linux</a>
    </span>
    

    </div>

    
  </div>
  
    
    <h3 class="article-read"><a href="/2018/11/06/centos安装vsftp/"><span>点击阅读</span></a></h3>
    
  
</article>






<nav class="pagination">
  
  <a href="/page/9/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/11/" class="pagination-next">下一页</a>
  
</nav>
            </main>
            <div class="sidebar
                    col-lg-3 col-lg-offset-0
                    col-md-3 col-md-offset-0
                    col-sm-12
                    col-xs-12
                    sidebar-container
                ">

                <div class="sidebar-container">



<div class="search-container">
<form class="site-search-form">
    <span class="glyphicon glyphicon-search"></span><input type="text" id="local-search-input" class="st-search-input" placeholder="Search..." />
</form>
<div id="local-search-result" class="local-search-result-cls"></div>
</div>
<script type="text/javascript" id="local.search.active">
var inputArea       = document.querySelector("#local-search-input");
inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script>




    <div class="categories-container" style="margin-top:40px;">
        <p>归档:</p>
            
    </div>




    <div class="social-container" style="margin-top:40px;">
        <p>Links:</p>
            
                
                    <li class="social-item"><i class="fa fa-fw fa-github"></i><a href="https://github.com/zeven0707">GitHub</a></li>
                
            
    </div>

</div>
            </div>
          </div>
        </div>
        
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2020 zeven0707&#39;s blog
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('30')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/js/index.js"></script>
<script src="/js/search.js"></script>

</body>
</html>